<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Shawn Tabrizi Blog</title>
        <link>https://shawntabrizi.com/blog</link>
        <description>Shawn Tabrizi Blog</description>
        <lastBuildDate>Fri, 15 Jul 2022 00:14:03 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Web3 Reading List]]></title>
            <link>https://shawntabrizi.com/blog/personal/web3-reading-list/</link>
            <guid>https://shawntabrizi.com/blog/personal/web3-reading-list/</guid>
            <pubDate>Fri, 15 Jul 2022 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will try to convince you to quit your current job and join the Web3 movement to change the way the world works.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-try-to-convince-you-to-quit-your-current-job-and-join-the-web3-movement-to-change-the-way-the-world-works">In this post, I will try to convince you to quit your current job and join the Web3 movement to change the way the world works.<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#in-this-post-i-will-try-to-convince-you-to-quit-your-current-job-and-join-the-web3-movement-to-change-the-way-the-world-works" class="hash-link" aria-label="Direct link to In this post, I will try to convince you to quit your current job and join the Web3 movement to change the way the world works." title="Direct link to In this post, I will try to convince you to quit your current job and join the Web3 movement to change the way the world works.">​</a></h5>
<p>Having worked professionally in the blockchain space for the last 4 years, it can be important to reflect on the influences that got me here in the first place.</p>
<p>I was quite happy with my job at Microsoft, and still think that Seattle is my favorite place where I have lived. (although Puerto Rico comes close...)</p>
<p>So then, what could compel me to quit my job, move to a 30m<sup>2</sup> apartment in Berlin, at half the pay?</p>
<p>To discover that, you will need to read these 5 influential books which convinced me to make the jump into a job in Web3. If these books resonate with you, then maybe it is time for you to take the jump too!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-lean-startup">The Lean Startup<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#the-lean-startup" class="hash-link" aria-label="Direct link to The Lean Startup" title="Direct link to The Lean Startup">​</a></h2>
<p>Written by <a href="https://en.wikipedia.org/wiki/Eric_Ries" target="_blank" rel="noopener noreferrer">Eric Ries</a></p>
<img src="https://shawntabrizi.com/assets/images/the-lean-startup.jpg" height="300px">
<p>This is my go-to book on how to effectively and successfully lead a project at a tech company. This was the way my mentor at Microsoft (Praveen Rutnam) ran his team, and this is the way I try to run all of my teams here at Parity.</p>
<blockquote>
<p>Reading Time: 6 hours, 299 pages.</p>
</blockquote>
<p><a href="https://contentfiesta.com/book-notes/the-lean-startup-summary/" target="_blank" rel="noopener noreferrer">Summary</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="zero-to-one">Zero to One<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#zero-to-one" class="hash-link" aria-label="Direct link to Zero to One" title="Direct link to Zero to One">​</a></h2>
<p>Written by <a href="https://en.wikipedia.org/wiki/Peter_Thiel" target="_blank" rel="noopener noreferrer">Peter Thiel</a></p>
<img src="https://shawntabrizi.com/assets/images/zero-to-one.jpg" height="300px">
<p>This book touches on the challenges of being the first to do something, and how to overcome those challenges and change the world along the way. This book is reassuring in times of doubt, since our goal at Parity is to fundamentally change the world with blockchain. Thiel uses his experiences from the dot com bubble, and I think there are many noticeable parallels happening in our space.</p>
<blockquote>
<p>Reading Time: 4 hours, 195 pages in book</p>
</blockquote>
<p><a href="https://howdo.com/book-summaries/zero-to-one-summary-and-review/" target="_blank" rel="noopener noreferrer">Summary</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="radical-markets">Radical Markets<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#radical-markets" class="hash-link" aria-label="Direct link to Radical Markets" title="Direct link to Radical Markets">​</a></h2>
<p>Written by <a href="https://en.wikipedia.org/wiki/Eric_Posner" target="_blank" rel="noopener noreferrer">Eric A. Posner</a> and <a href="https://en.wikipedia.org/wiki/Glen_Weyl" target="_blank" rel="noopener noreferrer">E. Glen Weyl</a></p>
<img src="https://shawntabrizi.com/assets/images/radical-markets.jpg" height="300px">
<p>This book is a bit denser and more academic than the others, but suggests tangible solutions to some of the many social and financial problems that we are trying to solve with blockchain and Web3 technology.</p>
<p>In fact, at one point, they mention that some of their suggestions would only be possible on blockchain technologies.</p>
<p>Better voting systems, ways to control and reduce the costs of land ownership, better immigration programs, disassembling monopolies, etc... If the problems in this book resonate with you, you are definitely headed toward a Web3 future.</p>
<blockquote>
<p>Reading Time: 8 hours, 368 pages in book</p>
</blockquote>
<p><a href="https://vitalik.ca/general/2018/04/20/radical_markets.html" target="_blank" rel="noopener noreferrer">Summary</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-starfish-and-the-spider">The Starfish and the Spider<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#the-starfish-and-the-spider" class="hash-link" aria-label="Direct link to The Starfish and the Spider" title="Direct link to The Starfish and the Spider">​</a></h2>
<p>Written by Ori Brafman and <a href="https://en.wikipedia.org/wiki/Rod_Beckstrom" target="_blank" rel="noopener noreferrer">Rod Beckstrom</a></p>
<img src="https://shawntabrizi.com/assets/images/the-starfish-and-the-spider.jpg" height="300px">
<p>This book paints an awesome picture as to the unstoppability of decentralized organizations, and how effective decentralized organizations can form.</p>
<p>When I think about what Parity wants to be, I see a starfish, and I think that we should learn from other organizations which have done this in the past (as covered in this book).</p>
<blockquote>
<p>Reading Time: 5 hours, 240 pages in book</p>
</blockquote>
<p><a href="https://wikileaks.org/gifiles/attach/23/23016_Starfish%20and%20the%20Spider.pdf" target="_blank" rel="noopener noreferrer">Summary</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-internet-of-money">The Internet of Money<a href="https://shawntabrizi.com/blog/personal/web3-reading-list/#the-internet-of-money" class="hash-link" aria-label="Direct link to The Internet of Money" title="Direct link to The Internet of Money">​</a></h2>
<p><a href="https://en.wikipedia.org/wiki/Andreas_Antonopoulos" target="_blank" rel="noopener noreferrer">Written by Andreas M. Antonopoulos</a></p>
<img src="https://shawntabrizi.com/assets/images/the-internet-of-money.jpg" height="300px">
<p>Andreas is famous in the Bitcoin world, and has even published the book <a href="https://github.com/ethereumbook/ethereumbook" target="_blank" rel="noopener noreferrer">Mastering Ethereum</a> with my boss Gavin Wood.</p>
<p>This book is a collection of talks he has given around the world, describing the problems which Bitcoin and blockchain can solve. This is the book that I send to anyone who asks "what is blockchain and why should I care?".</p>
<blockquote>
<p>Reading Time: 3 hours, 150 pages in book</p>
</blockquote>
<p>You can find the book free online <a href="https://github.com/erangadbw/IoMv1" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
            <category>books</category>
            <category>web3</category>
        </item>
        <item>
            <title><![CDATA[Transparent Keys in Substrate]]></title>
            <link>https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/</link>
            <guid>https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/</guid>
            <pubDate>Mon, 30 Mar 2020 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, we will take a look at the new Substrate storage hashers that allow you to transparently extract the keys for any given value in Substrate.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-we-will-take-a-look-at-the-new-substrate-storage-hashers-that-allow-you-to-transparently-extract-the-keys-for-any-given-value-in-substrate">In this post, we will take a look at the new Substrate storage hashers that allow you to transparently extract the keys for any given value in Substrate.<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#in-this-post-we-will-take-a-look-at-the-new-substrate-storage-hashers-that-allow-you-to-transparently-extract-the-keys-for-any-given-value-in-substrate" class="hash-link" aria-label="Direct link to In this post, we will take a look at the new Substrate storage hashers that allow you to transparently extract the keys for any given value in Substrate." title="Direct link to In this post, we will take a look at the new Substrate storage hashers that allow you to transparently extract the keys for any given value in Substrate.">​</a></h5>
<p>The more I learn about Substrate (and blockchain development in general), the more I come to understand the importance of storage design.</p>
<p>In retrospect, I guess this is obvious since the blockchain is all about coming to consensus about an underlying database, but I cannot overemphasize the fact that once you begin to fully understand the storage layers of Substrate, design decisions across the entire platform start to make more sense.</p>
<p>This blog post will be an extension of a previous post I wrote <a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/">Interacting with the Substrate RPC Endpoint</a>, where we investigated a little about how Substrate storage works, and how you can use basic RPC requests, along with the Substrate metadata, to retrieve information from the chain about the current state of the runtime.</p>
<p>This blog post will dive into the changes introduced to the Substrate storage keys since my last post by this PR: <a href="https://github.com/paritytech/substrate/pull/5226" target="_blank" rel="noopener noreferrer">Refactor away from opaque hashes #5226</a></p>
<p>Ultimately, I hope to show you how a simple design decision about the key format for Substrate storage maps has made the platform infinitely more friendly to external APIs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="opaque-storage-keys">Opaque Storage Keys<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#opaque-storage-keys" class="hash-link" aria-label="Direct link to Opaque Storage Keys" title="Direct link to Opaque Storage Keys">​</a></h2>
<p>Just do to a quick recap, in <a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/">my last post about interacting with Substrate storage via RPC</a>, we showed an example of how you can get all the balances in your Substrate blockchain using the <code>getKeys</code> query and knowledge about the underlying prefix tries used in runtime storage.</p>
<blockquote>
<p>This means you could actually use the <code>state_getKeys</code> API to get all the storage keys for all the free balances in your system!</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getKeys", "params": ["0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4"]}' http://localhost:9933</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"jsonrpc":"2.0","result":[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4024cd62ab7726e039438193d4bbd915427f2d7de85afbcf00bd16fadbcad6aed",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b42e3fb4c297a84c5cebc0e78257d213d0927ccc7596044c6ba013dd05522aacba",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b44724e5390fcf0d08afc9608ff4c45df257266ae599ac7a32baba26155dcf4402",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b454b75224d766c852ac60eb44e1329aec5058574ae8daf703d43bc2fbd9f33d6c",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b465d0de2c1f75d898c078307a00486016783280c8f3407db41dc9547d3e3d651e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b46b1ab1274bcbe3a4176e17eb2917654904f19b3261911ec3f7a30a473a04dcc8",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b477d14a2289dda9bbb32dd9313db096ef628101ac5bbb3b19301ede2c61915b89",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4927407fbcfe5afa14bcfb44714a843c532f291a9c33612677cb9e0ae5e2bd5de",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b494772f97f5f6b539aac74e798bc395119f39603402d0c85bc9eda5dfc5ae2160",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b49a9304efeee429067b2e8dfbcfd8a22d96f9d996a5d6daa02899b96bd7a667b1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b49ea52149af6b15f4d523ad4342f63089646e29232a1777737159c7bc84173597",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4a315ee9e56d2f3bb24992a1cff6617b0f7510628a15722b680c42c2be8bb7452",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4c4a80eb5e32005323fb878ca749473d7e5f40d60ed5e74e887bc125a3659f258"],"id":1}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote>
<p>However, I also mentioned that this would only allow you to calculate the total balance in your system. It would <em>not</em> necessarily allow you to know the individual balances of all the accounts because those Account IDs are cryptographically hashed and placed into the key. To figure out which account corresponds to each of the keys above, you would need to know the account ahead of time and then verify that the hash matches the bytes at the end of one of these keys.</p>
<p>In general, it is important that we use hashes in the construction of the storage key to <a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/">avoid unbalanced tries</a>. Imagine instead we use the raw Account ID rather than the hash of it in constructing these storage keys. I could attack a Substrate chain by transferring a very small balance to all accounts whose hexadecimal representation start with <code>0x69</code>. This means that any <em>real</em> account that also shares that first byte would be more heavy to access since we will need to traverse past all of the "dust" accounts in the trie.</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/unbalanced-trie-bbdaf53c815b5a70738b114624264c8a.png" width="3000" height="1005" class="img_ev3q"></p>
<p>You can see in this illustration, most accounts take only 4 hops to get access to the final value, but some in the middle can take up to 6 hops. This is a very tame example of an "unbalanced trie", but when actually attacking a system, you can imagine introducing many extra additional hops to access some user accounts.</p>
<p>So we can't use the Account ID directly because it is not safe for the chain, and using hashes is completely opaque to the user... Is there maybe some middle ground?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="customizable-storage-keys">Customizable Storage Keys<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#customizable-storage-keys" class="hash-link" aria-label="Direct link to Customizable Storage Keys" title="Direct link to Customizable Storage Keys">​</a></h2>
<p>This whole blog is about customizable storage keys in Substrate, so before we jump into it, lets talk about what this means.</p>
<p>In Substrate, each Pallet you design can introduce new storage items that will become part of your blockchain's state. These storage items can be simple single value items, or more complex storage maps. When you define storage maps in substrate, you must also specify a <code>hasher</code> that you want to use:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Foo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">foo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map </span><span class="token function" style="color:#d73a49">hasher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blake2_128_concat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><span class="token operator" style="color:#393A34">^</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You actually have the flexibility in Substrate to change which <code>hasher</code> gets used for each different storage map, and as a result, change the way your underlying storage keys are saved in the Substrate database. The <code>hasher</code> you select will be a part of blockchain's metadata, so any external UI will know what to do in order to correctly access your Substrate storage.</p>
<p>But you might be asking, what do these <code>hasher</code>s do?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="concatenating-hashers">Concatenating Hashers<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#concatenating-hashers" class="hash-link" aria-label="Direct link to Concatenating Hashers" title="Direct link to Concatenating Hashers">​</a></h2>
<p>In <a href="https://github.com/paritytech/substrate/pull/5226" target="_blank" rel="noopener noreferrer">PR #5226</a> a new set of "hashers" were introduced into the Substrate runtime storage system:</p>
<ul>
<li><code>blake2_128_concat</code></li>
<li><code>twox_64_concat</code></li>
</ul>
<p>These hashers are precisely a middle ground between using an opaque hash and using the raw key value, like an Account ID.</p>
<p>When we use these hashers, we take a key, find the hash, and then append to the end the hash the raw key itself. For example:</p>
<p><strong>Account ID</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Account Bytes in Hex</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Blake2 128 of Account Hex</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xde1e86a9a8c739864cf3cc5ec2bea59f</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Blake2 128 Concat of Account Hex</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xde1e86a9a8c739864cf3cc5ec2bea59fd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-------------- hash --------------++++++++++++++++++++++++++ raw key +++++++++++++++++++++++++++++</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So if you have this <code>blake2_128_concat</code> formed key, you will directly be able to find the underlying Account ID used to generate the key, you just need to look at the last 32 bytes. But since it is prefixed with a hash, it is also safe to use in the underlying storage trie since it cannot be trivially manipulated to attack the system as described in the previous section.</p>
<p>You can see these concatenating hashers comes in two flavors: <code>twox_64</code> and <code>blake2_128</code>. The only difference here is the security provided by the underlying hashing algorithm. <code>twox</code>/<code>xxhash</code> is not a cryptographically secure hashing algorithm, but it is significantly faster to execute. <code>blake2</code> is cryptographically secure, but also more resource heavy. So, when should we choose to use each of these?</p>
<p>That ultimately depends on how much control the users have over the value being hashed. Remember, we must always assume that the users of our blockchain are malicious, and build our chain to be resistent to that malicious activity.</p>
<p>So let's talk about when it would be appropriate to use each hasher and also show some examples of they they are being used in Substrate today.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blake2-128-concat">Blake2 128 Concat<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#blake2-128-concat" class="hash-link" aria-label="Direct link to Blake2 128 Concat" title="Direct link to Blake2 128 Concat">​</a></h3>
<p><code>blake2_128_concat</code> should be the default choice for any storage key. Because the prefix of the final key uses Blake2, a cryptographically secure hashing algorithm, we need not worry about the content of the starting key. This <code>hasher</code> will work for anything.</p>
<p>So where is it used?</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// The full account information for a particular account ID.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token class-name">Account</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">account</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map </span><span class="token function" style="color:#d73a49">hasher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blake2_128_concat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">AccountInfo</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountData</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the <code>Account</code> storage item in the FRAME System. Your default substrate configuration will put all user balances in here.</p>
<p>So why must we use <code>blake2_128_concat</code> for this storage item?</p>
<p>Well, this storage item can be <em>completely</em> controlled by external users. An Account ID (as implemented in a Substrate node) is any valid 32 bytes. When you make a transfer, you can specify any 32 bytes as the recipient of that balance transfer. That account need not have an existing balance or even a private key for someone to access it. So the attack we described earlier in the article where a malicious user could overpopulate parts of the trie still applies. Unfortunately, a non-cryptographic hashing algorithm like <code>twox</code> would not really help stop this attack. A malicious user would simply "mine" for an arbitrary account that generates a <code>twox</code> hash starting with some prefix, and perform the same attack. Because the <code>twox</code> hasher is not cryptographically secure, this kind of mining attack is not hard to the attacker.</p>
<p>So given that the starting key of this Storage Map is in complete and full control of the users in your network, we must use <code>blake2</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="twox-64-concat">TwoX 64 Concat<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#twox-64-concat" class="hash-link" aria-label="Direct link to TwoX 64 Concat" title="Direct link to TwoX 64 Concat">​</a></h3>
<p><code>twox_64_concat</code> should only be used as an optimization to <code>blake2_128_concat</code> in situations where you know that starting key cannot be chosen arbitrarily by your users.</p>
<p>Let's look at a few ways it is used in Substrate:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="incrementing-index">Incrementing Index<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#incrementing-index" class="hash-link" aria-label="Direct link to Incrementing Index" title="Direct link to Incrementing Index">​</a></h4>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// The next free referendum index, aka the number of referenda started so far.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token class-name">ReferendumCount</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">referendum_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token closure-params">_</span><span class="token closure-params closure-punctuation punctuation" style="color:#393A34">|</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">ReferendumIndex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ReferendumIndex</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// Information concerning any given referendum.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token class-name">ReferendumInfoOf</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">referendum_info</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map </span><span class="token function" style="color:#d73a49">hasher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twox_64_concat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">ReferendumIndex</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">ReferendumInfo</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BalanceOf</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Referendums are a part of Substrate's Democracy Pallet, allowing people to execute on-chain governance which can evolve your Substrate chain. Here you will see that we place information about an ongoing referendum into a map where the key uses <code>twox_64_concat</code>.</p>
<p>The starting key in this situation is a <code>ReferendumIndex</code>, which is simply a value that will be incremented for each new referendum. I have included the <code>ReferendumCount</code> storage item above to show you were the current <code>ReferendumIndex</code> is being tracked. Technically speaking, the starting key of a referendum is allowed to be any <code>ReferendumIndex</code> value. However, practically speaking, this value is not really in control of the end user. If a malicious user wants to insert some data where <code>ReferendumIndex = 420</code>, they will need to open up 419 other referendums, all of which has some underlying economic cost to the user (a deposit, a transaction fee, etc...).</p>
<p>And that is just to populate one key!</p>
<p>So a user can only manipulate the <code>ReferendumIndex</code> by creating more referendums, and ultimately, that is within the safety conditions of what the <code>twox</code> hasher can provide. Do note though, that if it was <em>much</em> easier for a user to increment this referendum count, for example by submitting a low cost transaction or a transaction which allows them to increment the index multiple spots at a time, then it is possible that <code>twox_64_concat</code> would not be good enough again. You will need to justify the use on a case by base basis.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="real-accounts">Real Accounts<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#real-accounts" class="hash-link" aria-label="Direct link to Real Accounts" title="Direct link to Real Accounts">​</a></h4>
<p>Let's stay in the Democracy Pallet.</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// All votes for a particular voter. We store the balance for the number of votes that we</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// have recorded. The second item is the total amount of delegations, that will be added.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token class-name">VotingOf</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map </span><span class="token function" style="color:#d73a49">hasher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">twox_64_concat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Voting</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">BalanceOf</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">BlockNumber</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here we have all of the votes of users in our system for various referendums or proposals. You can see that this storage map is very similar to the <code>Account</code> storage item that we used <code>blake2_128_concat</code> for, as it maps from Account ID to some value.</p>
<p>So why can we use <code>twox_64_concat</code> here and not there?</p>
<p>Well the way this storage item is populated is very different than in the case of managing user balances. Only when a user submits a vote onto the blockchain will this storage item be populated. Specifically, this implies the user has the private key to the account in question. If an attacker wanted to put onto the blockchain some data under an arbitrary public key, they would need to generate private keys until one had the corresponding public key they wanted. But at that point, it is as difficult to attack as a regular cryptographic hash.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="identity">Identity<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#identity" class="hash-link" aria-label="Direct link to Identity" title="Direct link to Identity">​</a></h3>
<p>One last option you have which I did not mention yet is the <code>identity</code> <code>hasher</code>. As its name implies, it does not do any hashing at all, and instead directly uses the starting key as the final storage key for the storage item. An example of this in Substrate can also be found in the Democracry Pallet:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Map of hashes to the proposal preimage, along with who registered it and their deposit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/// The block number is the block at which it was deposited.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token class-name">Preimages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  map </span><span class="token function" style="color:#d73a49">hasher</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">identity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">PreimageStatus</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">BalanceOf</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">BlockNumber</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This should only be used when the starting key is already a cryptographic hash. In the example above, a user can submit a call that will be later executed by a democracy proposal, and we track that call on-chain using the hashing algorithm defined by the runtime, in this case Blake2. So there is no need to append any additional data to the key, we can just use it directly!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="listing-all-users">Listing All Users<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#listing-all-users" class="hash-link" aria-label="Direct link to Listing All Users" title="Direct link to Listing All Users">​</a></h2>
<p>Okay, so now that you understand the new hashers introduced to Substrate, lets go through a clear example why this is so great from a UX perspective.</p>
<p>In my old RPC blog post, I was able to list all the user balances, and calculate with it the total balance in my Substrate chain, but I was not able to tell you how much each person has. Well, with our new transparent storage keys, we can do this!</p>
<p>I will start a regular Substrate dev node and make a query to return all <code>System.Accounts</code>. They will all have a shared prefix of:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">twox_128("System")                 + twox_128("Account")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0x26aa394eea5630e07c48ae0c9558cef7 + 0xb99d880ec681799c0cf30e8886371da9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; 0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So then I call the <code>getKeys</code> rpc for my dev node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getKeys", "params": ["0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9"]}' http://localhost:9933</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which returns:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "jsonrpc": "2.0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "result": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9007cbc1270b5b091758f9c42f5915b3e8ac59e11963af19174d0b94d5d78041c233f55d2e19324665bafdfb62925af2d",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da923a05cabf6d3bde7ca3ef0d11596b5611cbd2d43530a44705ad088af313e18f80b53ef16b36177cd4b77b846f2a5f07c",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da932a5935f6edc617ae178fef9eb1e211fbe5ddb1579b72e84524fc29e78609e3caf42e85aa118ebfe0b0ad404b5bdd25f",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da94f9aea1afa791265fae359272badc1cf8eaf04151687736326c9fea17e25fc5287613693c912909cb226aa4794f26a48",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da95ecffd7b6c0f78751baa9d281e0bfa3a6d6f646c70792f74727372790000000000000000000000000000000000000000",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da96f2e33376834a63c86a195bcf685aebbfe65717dad0447d715f660a0a58411de509b42e6efb8375f562f58a554d5860e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da98578796c363c105114787203e4d93ca6101191192fc877c24d725b337120fa3edc63d227bbc92705db1e2cb65f56981a",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9b0edae20838083f2cde1c4080db8cf8090b5ab205c6974c9ea841be688864633dc9ca8a357843eeacf2314649965fe22",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9b321d16960ce1d9190b61e2421cc60131e07379407fecc4b89eb7dbd287c2c781cfb1907a96947a3eb18e4f8e7198625",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9de1e86a9a8c739864cf3cc5ec2bea59fd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9e5e802737cce3a54b0bc9e3d3e6be26e306721211d5404bd9da88e0204360a1a9ab8b87c66c1bc2fcdd37f3c2222cc20",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9edeaa42c2163f68084a988529a0e2ec5e659a7a1628cdd93febc04a4e0646ea20e9f5f0ce097d9a05290d4a9e054df4e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    "0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9f3f619a1c2956443880db9cc9a13d058e860f1b1c7227f7c22602f53f15af80747814dffd839719731ee3bba6edc126c"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "id": 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now, I know that all these storage keys use <code>blake2_128_concat</code> with the Account ID as the starting key, so I know that there should be an additional 48 bytes added to the end of their shard prefix, and the last 32 bytes should be the raw Account ID information!</p>
<p>Let's break one down manually:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da932a5935f6edc617ae178fef9eb1e211fbe5ddb1579b72e84524fc29e78609e3caf42e85aa118ebfe0b0ad404b5bdd25f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---------------------- storage prefix key ------------------------+++++++ blake2 128 hash ++++++++------------------------ account id ----------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Taking a closer look at the last 32 bytes:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Account ID:      0xbe5ddb1579b72e84524fc29e78609e3caf42e85aa118ebfe0b0ad404b5bdd25f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Blake2 128 Hash: 0x32a5935f6edc617ae178fef9eb1e211f</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address:         5GNJqTPyNqANBkUVMN1LPPrxXnFouWXoe2wNSmmEoLctxiZY</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And this address corresponds to "Alice's Stash" account:</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/alice-stash-account-f666a0b4145591e5dc778f75b3635d96.png" width="1792" height="678" class="img_ev3q"></p>
<p>Nice! So we could follow this same process for every key that is returned under <code>System.Account</code> and get a full list of all the accounts in our Substrate dev node!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-thoughts">Final Thoughts<a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/#final-thoughts" class="hash-link" aria-label="Direct link to Final Thoughts" title="Direct link to Final Thoughts">​</a></h2>
<p>At this point, it should be obvious why this storage key design is really an amazing feature for Substrate and its users. It provides safety, flexibility, and usability to everyone on the platform. I am not sure you can ask for much more.</p>
<p>One thing to note is that Substrate is able to quickly change fundamental design decisions like these storage key patterns due to its modular nature and the minimal number underlying assumptions it makes. If you are a blockchain developer who wants to introduce another storage key system, it really would not be that hard to do it!</p>
<p>I have created some tools at <a href="https://www.shawntabrizi.com/substrate-js-utilities/" target="_blank" rel="noopener noreferrer">https://www.shawntabrizi.com/substrate-js-utilities/</a> that allow people to quickly calculate the <code>blake2_128_concat</code> or <code>twox_64_concat</code> of some arbitrary string or hex bytes. Try out these examples on your own and see for yourself the advantages that these new transparent storage keys bring to you.</p>
<p>As always, if you enjoy the content I write, you can send me a friendly tip on my <a href="https://www.shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>.</p>]]></content:encoded>
            <category>storage</category>
            <category>runtime</category>
            <category>module</category>
            <category>keys</category>
            <category>rpc</category>
        </item>
        <item>
            <title><![CDATA[Substrate Weights and Fees]]></title>
            <link>https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/</link>
            <guid>https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/</guid>
            <pubDate>Fri, 28 Feb 2020 00:14:03 GMT</pubDate>
            <description><![CDATA[This is the first in a series of posts explaining our philosophy toward benchmarking and assigning weights to Substrate pallets for the imminent launch of the Polkadot network.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="this-is-the-first-in-a-series-of-posts-explaining-our-philosophy-toward-benchmarking-and-assigning-weights-to-substrate-pallets-for-the-imminent-launch-of-the-polkadot-network">This is the first in a series of posts explaining our philosophy toward benchmarking and assigning weights to Substrate pallets for the imminent launch of the Polkadot network.<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#this-is-the-first-in-a-series-of-posts-explaining-our-philosophy-toward-benchmarking-and-assigning-weights-to-substrate-pallets-for-the-imminent-launch-of-the-polkadot-network" class="hash-link" aria-label="Direct link to This is the first in a series of posts explaining our philosophy toward benchmarking and assigning weights to Substrate pallets for the imminent launch of the Polkadot network." title="Direct link to This is the first in a series of posts explaining our philosophy toward benchmarking and assigning weights to Substrate pallets for the imminent launch of the Polkadot network.">​</a></h5>
<p>For the past couple of weeks, I have been working hard creating and executing a plan around weighing extrinsic functions across our different FRAME pallets so that we can launch the Polkadot network.</p>
<p>There are a few overall goals that we want to accomplish with this task:</p>
<ol>
<li>Provide computational limits and thresholds for block producers on the network.</li>
<li>Provide economic security such that malicious actors would not be able to profitably attack the network.</li>
<li>Identify and redesign extrinsics which have non-linear complexity.</li>
<li>Improve the runtime architecture to reduce overall complexity.</li>
</ol>
<p>To follow along this journey, you must first understand what "weights" are in Substrate, and how they are related to the more commonly understood fee system.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="weights">Weights<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#weights" class="hash-link" aria-label="Direct link to Weights" title="Direct link to Weights">​</a></h2>
<p>If you are unfamiliar with weights, the TL;DR is that a Substrate blockchains have limited resources when it comes to producing new blocks. Most notably, there is a limited window for block producers to create a block, limited amount of data that can be included per block (<a href="https://substrate.dev/rustdocs/master/frame_system/trait.Trait.html#associatedtype.MaximumBlockLength" target="_blank" rel="noopener noreferrer"><code>MaximumBlockLength</code></a>), and an overall practical limit to the storage footprint of the blockchain.</p>
<p>Substrate has introduced a Weight system that allows the runtime developer to tell the block production process how "heavy" an extrinsic is. Given some <a href="https://substrate.dev/rustdocs/master/frame_system/trait.Trait.html#associatedtype.MaximumBlockWeight" target="_blank" rel="noopener noreferrer"><code>MaximumBlockWeight</code></a>, and the weight of the individual extrinsics in a transaction pool, we can select the set of extrinsics that allow us to saturate our block, while not going over the limits.</p>
<p>On top of this basic idea, Substrate has additionally introduced a configurable <a href="https://substrate.dev/rustdocs/master/frame_system/trait.Trait.html#associatedtype.AvailableBlockRatio" target="_blank" rel="noopener noreferrer"><code>AvailableBlockRatio</code></a> which ensures that only a portion of the total <code>MaximumBlockWeight</code> is used for regular transactions. This also introduces the concept of <em>operational transactions</em> which are system critical operations that can use the rest of the available block weight.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="example">Example<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#example" class="hash-link" aria-label="Direct link to Example" title="Direct link to Example">​</a></h3>
<p>Let's say a <code>balance_transfer</code> has weight 1,000, and our Substrate chain is configured to a maximum block weight of 1,000,000, with an available block ratio of 20%.</p>
<p>This means we would be able to include at most:</p>
<p>1,000,000 * .20 / 1,000 = 200 transfers per block</p>
<p>For more details on weights, read our doc: <a href="https://substrate.dev/docs/en/conceptual/runtime/weight" target="_blank" rel="noopener noreferrer">https://substrate.dev/docs/en/conceptual/runtime/weight</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="fees">Fees<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#fees" class="hash-link" aria-label="Direct link to Fees" title="Direct link to Fees">​</a></h2>
<p>To bring the weight system to the users of our blockchain, Substrate introduces a tightly coupled fee system. In short, users will pay a transaction fee proportional to the weight of the call they are making.</p>
<p>total_fee = base_fee + length_fee + weight_fee</p>
<blockquote>
<p>Note: There is also a length_fee which takes into account the amount of data included in an extrinsic.</p>
</blockquote>
<p>As a pallet developer writing new dispatchable functions, the fee system should mostly be abstract to you, and instead you should primarily think in terms of weights.</p>
<p>For more details on fees, read our doc: <a href="https://substrate.dev/docs/en/development/module/fees" target="_blank" rel="noopener noreferrer">https://substrate.dev/docs/en/development/module/fees</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="runtime-development">Runtime Development<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#runtime-development" class="hash-link" aria-label="Direct link to Runtime Development" title="Direct link to Runtime Development">​</a></h2>
<p>As a runtime developer, it is your goal to:</p>
<ul>
<li>Minimize the computational and resource complexity of runtime functions.</li>
<li>Accurately calculate the relative weight of your runtime functions.</li>
</ul>
<p>We can accomplish this in three steps:</p>
<ol>
<li>Follow best practices when writing a runtime.</li>
<li>Accurately document the computational complexity introduced by runtime functions.</li>
<li>Empirically measure the real world cost of running these functions, and associate those measurements back to our computational complexity.</li>
</ol>
<p>It is beyond the scope of any single blog post to explain all the best practices when it comes to runtime development, but we can start to touch on (2) and follow up and talk more about how to approach (3).</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="documentation-of-weights">Documentation of Weights<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#documentation-of-weights" class="hash-link" aria-label="Direct link to Documentation of Weights" title="Direct link to Documentation of Weights">​</a></h3>
<p>Dispatchable functions within a FRAME pallet should contain documentation about the computational and resource complexity of the function. The result of weight documentation is to arrive at a final <a href="https://en.wikipedia.org/wiki/Big_O_notation" target="_blank" rel="noopener noreferrer">order of a function</a>. Such as:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">O(A + logA + BlogC)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This should serve as a resource to accurately measure the weight of different functions across all possible inputs, something we would not reasonably able to measure otherwise.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-to-document">What to Document<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#what-to-document" class="hash-link" aria-label="Direct link to What to Document" title="Direct link to What to Document">​</a></h4>
<p>Your weight documentation should include information about your runtime function which has notable execution costs. For example:</p>
<ul>
<li>Storage Operations (read, write, mutate, etc...)</li>
<li>Codec Operations (serializing/deserializing vecs or large structs)</li>
<li>Search / Sort / Notable Computation</li>
<li>Calls to other pallet functions (i.e. reserving some balance through the Currency trait)</li>
</ul>
<p>We will work off the following example function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Join a group of members.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> who </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> deposit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Deposit</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// configuration constant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sorted_members</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">members</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sorted_members</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Membership Full"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">match</span><span class="token plain"> sorted_members</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">binary_search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// User is not a member.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Err</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Currency</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">reserve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deposit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			members</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> who</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Members</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sorted_members</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// User is already a member, do nothing.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">deposit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RawEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Joined</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="storage-and-codec-operations">Storage and Codec Operations<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#storage-and-codec-operations" class="hash-link" aria-label="Direct link to Storage and Codec Operations" title="Direct link to Storage and Codec Operations">​</a></h4>
<p>Accessing storage is a heavy operation, and one that should be well documented and optimized in favor writing "functional code". See <a href="https://www.notion.so/paritytechnologies/Weights-8c916536949b47f299eed1302b6a2074?p=c5aafd34578f4be9ab8c8d7510e98314&amp;showMoveTo=true#best-practices" target="_blank" rel="noopener noreferrer">Best Practices</a>.</p>
<p>The each storage operation should be documented with the relative codec complexity of interacting with that storage.</p>
<p>For example, if you are reading a vector of members from a single value storage item, the weight documentation should read:</p>
<ul>
<li>One storage read to get the members of this pallet: <code>O(M)</code>.</li>
</ul>
<p>In this case reading the vector from storage has a codec complexity of <code>O(M)</code> to deserialize the <code>M</code> member accounts in the vector.</p>
<p>Later in your module, you might go ahead and write the data back into the runtime, which should also be documented:</p>
<ul>
<li>One storage write to update the members of this pallet: <code>O(M)</code>.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="search-sort-and-notable-computations">Search, Sort, and Notable Computations<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#search-sort-and-notable-computations" class="hash-link" aria-label="Direct link to Search, Sort, and Notable Computations" title="Direct link to Search, Sort, and Notable Computations">​</a></h4>
<p>If you need to search or sort in your runtime module, it is also important to note the relative complexity of those operations.</p>
<p>For example, if you are searching for an item in a sorted list, a <code>binary_search</code> operation should take <code>O(logM)</code>, while an unsorted list, should take <code>O(M)</code>.</p>
<p>So the documentation may look like:</p>
<ul>
<li>Insert a new member into sorted list: O(logM).</li>
</ul>
<p>This kind of documentation should be present for any sort of notable heavy computation present in your logic.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="calls-to-other-pallets-and-traits">Calls to Other Pallets and Traits<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#calls-to-other-pallets-and-traits" class="hash-link" aria-label="Direct link to Calls to Other Pallets and Traits" title="Direct link to Calls to Other Pallets and Traits">​</a></h4>
<p>The computational complexity of your function may extend beyond your pallet. If you call other FRAME pallets either directly or through Trait configurations, you should take note of that, and assign these calls with their own variable.</p>
<p>For example, if you write a function which reserves some balance in the Balances pallet or emits an event through the System pallet, you should document:</p>
<ul>
<li>One balance reserve operation: O(B)</li>
<li>One event emitted: O(E)</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="combining-the-data">Combining the Data<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#combining-the-data" class="hash-link" aria-label="Direct link to Combining the Data" title="Direct link to Combining the Data">​</a></h4>
<p>Once you have good documentation for your runtime function, you need to consolidate it into a <em>single overall order of the function</em>.Lets combine the different example operations to create a full end to end example.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># &lt;weight&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key: M (len of members), B (reserve balance), E (event)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- One storage read to get the members of this pallet: `O(M)`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- One balance reserve operation: O(B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Insert a new member into sorted list: O(logM).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- One storage write to update the members of this pallet: `O(M)`.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- One event emitted: O(E)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Total Complexity: O(M + logM + B + E)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># &lt;/weight&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Note: You may have introduced multiple different variables into your overall weight documentation, so be sure to document what these variables represent.</p>
</blockquote>
<p>If you look at this example, you can see we had two operations that were O(M) (the storage read and write), but our overall order does not take this into account.</p>
<p><strong>When doing empirical testing, we are unable to separate complexities which have the same order</strong>. This means that there could be many many more operations added to this function, of order <code>O(M)</code>, <code>O(logM</code>), etc.. but it would not change our final formula as a function of <code>M</code>, <code>B</code>, and <code>E</code>:</p>
<p>weight(M, B, E) = K_1 + K_2 * M + K_3 * logM + B + E</p>
<p>The difference between two functions with the same order will be empirically measured through on-chain tests. The goal of this step is to simply derive the coefficients (<code>K</code>) that we will be searching for when we do the <a href="https://www.notion.so/paritytechnologies/Weights-8c916536949b47f299eed1302b6a2074?p=c5aafd34578f4be9ab8c8d7510e98314&amp;showMoveTo=true#measuring-weights" target="_blank" rel="noopener noreferrer">next step</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://shawntabrizi.com/blog/substrate/substrate-weight-and-fees/#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>So hopefully now you can see how we can approach runtime code, and from it, derive a theoretical order of complexity. The next step after this is to actually run benchmarks for these different extrinsics, and start collecting data that we can map back to these derived formulas.</p>
<p>If you enjoy this content and want to see the next post where we dive deeper into actually benchmarking the runtime, consider taking a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a> to see how you can support me.</p>]]></content:encoded>
            <category>weight</category>
            <category>transaction</category>
            <category>fee</category>
            <category>benchmark</category>
            <category>substrate</category>
        </item>
        <item>
            <title><![CDATA[Porting Web3.js to Polkadot.js]]></title>
            <link>https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/</link>
            <guid>https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/</guid>
            <pubDate>Mon, 13 Jan 2020 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will go over the changes I needed to make in order to port a Web3.js based Ethereum web app I had previously blogged about to use Polkadot.js and Substrate.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-go-over-the-changes-i-needed-to-make-in-order-to-port-a-web3js-based-ethereum-web-app-i-had-previously-blogged-about-to-use-polkadotjs-and-substrate">In this post, I will go over the changes I needed to make in order to port a Web3.js based Ethereum web app I had <a href="https://shawntabrizi.com/blog/ethereum/graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js/">previously blogged about</a> to use Polkadot.js and Substrate.<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#in-this-post-i-will-go-over-the-changes-i-needed-to-make-in-order-to-port-a-web3js-based-ethereum-web-app-i-had-previously-blogged-about-to-use-polkadotjs-and-substrate" class="hash-link" aria-label="Direct link to in-this-post-i-will-go-over-the-changes-i-needed-to-make-in-order-to-port-a-web3js-based-ethereum-web-app-i-had-previously-blogged-about-to-use-polkadotjs-and-substrate" title="Direct link to in-this-post-i-will-go-over-the-changes-i-needed-to-make-in-order-to-port-a-web3js-based-ethereum-web-app-i-had-previously-blogged-about-to-use-polkadotjs-and-substrate">​</a></h5>
<p>Almost 2 years ago, I was still on my journey learning about Ethereum, when I built a simple web application using Web3.js. At the time, there was a spawn of viral "ponzi scheme" smart contracts, and I wanted to see how these dApps grew and eventually crashed over time.</p>
<p>Check out my previous blog post about <a href="https://shawntabrizi.com/blog/ethereum/graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js/">Graphing ETH Balance History of an Ethereum Address using Parallel Asynchronous Requests in Web3.js</a> to learn more.</p>
<p>Since the launch of <a href="https://kusama.network/" target="_blank" rel="noopener noreferrer">Kusama</a>, there has been a lot more activity around actually <em>using</em> Substrate, specifically among the validator/nominator community. I wanted to take a look at the my nomination rewards over time, and to do that, I basically needed to rebuild this same application, but using Polkadot.js... (<a href="https://www.shawntabrizi.com/substrate-balance-graph/" target="_blank" rel="noopener noreferrer">sneak peek</a>)</p>
<p><img loading="lazy" alt="Before and after screenshot of Web3 to Polkadot port" src="https://shawntabrizi.com/assets/images/substrate-balance-graph-hero-52698f197d2068bbeede1cb39a98859f.png" width="1086" height="467" class="img_ev3q"></p>
<p>Here is <strong>that</strong> journey.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-polkadotjs-bundle">Creating a Polkadot.js Bundle<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#creating-a-polkadotjs-bundle" class="hash-link" aria-label="Direct link to Creating a Polkadot.js Bundle" title="Direct link to Creating a Polkadot.js Bundle">​</a></h2>
<p>The first issue I ran into when trying to migrate from Web3.js to Polkadot.js was generating a standalone JavaScript bundle so I can simply include the dependencies into my barebones project. At the moment, Polkadot.js does not provide an official bundle, but it is easy enough to create with <a href="http://browserify.org/" target="_blank" rel="noopener noreferrer">browserify</a>.</p>
<p>Assuming you already have <code>npm</code>, here are those steps:</p>
<ol>
<li>
<p>Install browserify:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm install -g browserify</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Create a new NodeJS project:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir temp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd temp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># lots of interaction here, doesn't matter what you select</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Add the Polkadot.js dependencies (I use <code>@beta</code>, but the exact versions to use may change over time):</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm install @polkadot/api@beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm install @polkadot/util@beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm install @polkadot/util-crypto@beta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm install @polkadot/keyring@beta</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You should have a <code>package.json</code> that looks like:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">"dependencies": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@polkadot/api": "^1.0.0-beta.7",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@polkadot/keyring": "^2.0.0-beta.4",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@polkadot/util": "^2.0.0-beta.4",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@polkadot/util-crypto": "^2.0.0-beta.4"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Create a simple file which exports these libraries into the <code>window</code> object:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// In a file named `dependencies.js`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> api </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"@polkadot/api"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> util </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"@polkadot/util"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> util_crypto </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"@polkadot/util-crypto"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> keyring </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"@polkadot/keyring"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">api</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">util</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> util</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">util_crypto</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> util_crypto</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">keyring</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> keyring</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Create the <code>polkadot.js</code> bundle:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">browserify dependencies.js &gt; polkadot.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>You should now have a <code>polkadot.js</code> file that you can include into any HTML page and will export <code>api</code>, <code>util</code>, <code>util_crypto</code>, and <code>keyring</code> commands.</p>
<div class="language-html codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-html codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">script</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">src</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">polkadot.js</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token script"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">script</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Actually, you can find it on this page too! Just open your browser console and try any of these commands.</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">blake2AsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Hello, World!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0x511bc81dde11180838c562c82bb35f3223f46061ebde4a955c27b3f489cf1e03"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you don't want to follow these steps, feel free to grab the <code>polkadot.js</code> bundle I created at: <a href="https://github.com/shawntabrizi/substrate-balance-graph" target="_blank" rel="noopener noreferrer">shawntabrizi/substrate-balance-graph</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="connecting-to-a-node">Connecting to a Node<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#connecting-to-a-node" class="hash-link" aria-label="Direct link to Connecting to a Node" title="Direct link to Connecting to a Node">​</a></h2>
<p>As a front-end developer, I am not so interested in setting up a local node, to get my app to work. In the Web3.js world, I would use Metamask + a dedicated infura node. From my Ethereum web app <a href="https://github.com/shawntabrizi/ethgraph" target="_blank" rel="noopener noreferrer">(ethgraph)</a>:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Check for MetaMask, otherwise use an HTTP Provider</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">addEventListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"load"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">typeof</span><span class="token plain"> web3 </span><span class="token operator" style="color:#393A34">!==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"undefined"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Web3 Detected! "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">currentProvider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">constructor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">web3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Web3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">currentProvider</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"No Web3 Detected... using HTTP Provider"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">web3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Web3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Web3</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">providers</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">HttpProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"https://mainnet.infura.io/&lt;APIKEY&gt;"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <a href="https://github.com/polkadot-js/extension" target="_blank" rel="noopener noreferrer">polkadot-js/extension</a> does not inject a WebSocket provider automatically, so we can skip the "detected" step, and just connect when we know we are not connected. Substrate is also not just a platform for <em>one</em> chain, but many chains, so I wanted to also support the user user customizable endpoints.</p>
<p>I created a <code>connect</code> function which looks like this:</p>
<div class="language-js codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-js codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Connect to Substrate endpoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> endpoint </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"endpoint"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">substrate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">endpoint</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">api</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">WsProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"output"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Connecting to Endpoint..."</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">window</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">substrate</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">ApiPromise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> provider </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">endpoint</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token dom variable" style="color:#36acaa">document</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getElementById</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"output"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">innerHTML</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Connected"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see I keep track of two global properties:</p>
<ol>
<li><code>window.substrate</code> - This will be my WebSocket provider and how I access the Polkadot.js APIs. If it already exists, I am already connected!</li>
<li><code>window.global.endpoint</code> - This is a global variable I created to keep track of the current endpoint I am connected to.</li>
</ol>
<p>When I call <code>connect</code>, it will make sure I am connected to the endpoint I want based on the input of the <code>endpoint</code> element on the HTML page. For a network like Kusama, this endpoint would be something like:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wss://kusama-rpc.polkadot.io/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-the-node">Querying the Node<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#querying-the-node" class="hash-link" aria-label="Direct link to Querying the Node" title="Direct link to Querying the Node">​</a></h2>
<p>At the time of creating <code>ethgraph</code>, Web3.js did not support <code>async</code>/<code>await</code>. Instead, <a href="https://shawntabrizi.com/blog/ethereum/making-web3-js-work-asynchronously-javascript-promises-await/">I wrapped everything in a "promisify" wrapper</a>. Fortunately, Polkadot.js supports this natively, so you can query every API easily and ergonomically with a promise.</p>
<p>For example, here is how we can get the balance of a user:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> balance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">freeBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"EGVQCe73TpFyAZx5uKfE1222XfkT3BSKozjgcqzLBnc5eYo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">balance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2116624633061757</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To provide all the functionality of the Ethereum version of this app, I also need to query the timestamp of a block. Ethereum would include this in the block header, but we know that Substrate has no such requirements, and instead provides this through another runtime module:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token known-class-name class-name">Date</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"Wed Jan 15 2020 22:42:37 GMT+0100 (Central European Standard Time)"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Great! But how do we get the <em>historical</em> information?</p>
<p>In Ethereum, we could just provide the block number directly into the query:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockNumber</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">/*callback*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In Polkadot.js we need to use the <code>.at(hash, &lt;PARAMS&gt;)</code> API, which extends all the Substrate queries. <code>hash</code> here is the block hash of the block that I want to get the information for. To get the block hash, I need to make an RPC call through the Polkadot.js API:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockHash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBlockHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">blockHash</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0x46781d9a3350a0e02dbea4b5e7aee7c139331a65b2cd736bb45a824c2f3ffd1a"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So all together now:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> balance_100 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">freeBalance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0x46781d9a3350a0e02dbea4b5e7aee7c139331a65b2cd736bb45a824c2f3ffd1a"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"EGVQCe73TpFyAZx5uKfE1222XfkT3BSKozjgcqzLBnc5eYo"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">balance_100</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toNumber</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10000000000</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see I gained quite a bit of free balance since block 0! :)</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keeping-it-async">Keeping it Async<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#keeping-it-async" class="hash-link" aria-label="Direct link to Keeping it Async" title="Direct link to Keeping it Async">​</a></h2>
<p>So we have all the pieces to be able convert our old queries into the new ones. However, if we do things naively, we will run into a trap which was warned about in my last blog post.</p>
<p>Can you guess?</p>
<p>Let's take a look how a naive conversion between Web3.js to Polkadot.js would look like:</p>
<ul>
<li>
<p>Original Web3.js Code</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Loop over the blocks, using the step value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> endBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If we already have data about that block, skip it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">block</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to query the ETH balance for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> balancePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">promisify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">cb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to get the timestamp for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">promisify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">cb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Push data to a linear array of promises to run in parellel.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    promises</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> balancePromise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timePromise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Naive Polkadot.js Code</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Loop over the blocks, using the step value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> endBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If we already have data about that block, skip it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">block</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the block hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockHash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBlockHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to query the balance for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> freeBalancePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">freeBalance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      blockHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to get the timestamp for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockHash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Push data to a linear array of promises to run in parellel.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    promises</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> freeBalancePromise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timePromise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>First, we should call out how incredibly similar the two code blocks look. The naive update is <em>totally</em> working, and really we did not have to change our app at all! But if you are trying this at home, you might notice the app is running pretty slow... over 30 seconds to fetch the data needed to create the graph!</p>
<p><img loading="lazy" alt="Image before parallel async" src="https://shawntabrizi.com/assets/images/substrate-balance-graph-before-fb6d71a5855ded8244bfdc86226ab570.png" width="2880" height="1800" class="img_ev3q"></p>
<p>The point of this loop was to collect all the queries and run them asynchronously. As mentioned in the last blog post, this provides a huge boost in performance since we are not waiting for each response to move onto the next one. However, this naive conversion sticks an <code>await</code> right in the middle of the loop, and this causes us to serialize querying for all the blocks, and slow down the entire processes.</p>
<p>To solve this, we want to also query all the block hashes for the blocks we need in parallel, but in a separate loop, because we need to know the hash before we can make the next query.</p>
<p>The improved solution looks like:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> promises </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Get all block hashes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> endBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If we already have data about that block, skip it.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">blockHashes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">block</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockHashPromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">chain</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getBlockHash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    promises</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockHashPromise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Call all promises in parallel for speed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">promises</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Save block hashes globally so we don't query them again if we don't need to.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">length</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">blockHashes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">block</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">hash</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> promises </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Loop over the blocks, using the step value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> startBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> endBlock</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// If we already have data about that block, skip it</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">block</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Get the block hash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> blockHash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> global</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">blockHashes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">find</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">block</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">hash</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to query the balance for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> freeBalancePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">balances</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">freeBalance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      blockHash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Create a promise to get the timestamp for that block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timePromise </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> substrate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">query</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">now</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockHash</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Push data to a linear array of promises to run in parellel.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    promises</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> freeBalancePromise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timePromise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Call all promises in parallel for speed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> results </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token known-class-name class-name">Promise</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">promises</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Results:"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This generates a graph for us in under 2 seconds!</p>
<p><img loading="lazy" alt="Image after parallel async" src="https://shawntabrizi.com/assets/images/substrate-balance-graph-after-57e92e045e9f6bc0ea73590fa39d5e2a.png" width="2880" height="1800" class="img_ev3q"></p>
<p>Much better, and what you would expect from a modern web application! But here we don't have a traditional database, just a blockchain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-thoughts">Final Thoughts<a href="https://shawntabrizi.com/blog/substrate/porting-web3-js-to-polkadot-js/#final-thoughts" class="hash-link" aria-label="Direct link to Final Thoughts" title="Direct link to Final Thoughts">​</a></h2>
<p>You can play with the final application here: <a href="https://www.shawntabrizi.com/substrate-balance-graph/" target="_blank" rel="noopener noreferrer">https://www.shawntabrizi.com/substrate-balance-graph/</a></p>
<p>After this exercise it has become clear to me that porting existing web applications built with Web3.js to Polkadot.js is trivial. Additionally, I already have a ton of experience with Substrate runtime development, so I already know how easy it will be to take existing smart contracts and build them on Substrate, maybe even better than before.</p>
<p>With that in mind, it won't be long until we see a wave of existing dApps joining Substrate/Polkadot, taking advantage of all the next generation features without making any compromises toward their existing functionality. The future seems bright overall, and I am excited to be at the forefront.</p>
<p>As always, if you like the content I create, stop by my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a> and say thanks!</p>]]></content:encoded>
            <category>javascript</category>
            <category>front-end</category>
            <category>balance</category>
            <category>graph</category>
            <category>plotly.js</category>
            <category>ethereum</category>
            <category>substrate</category>
        </item>
        <item>
            <title><![CDATA[Substrate Storage Deep Dive]]></title>
            <link>https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/</link>
            <guid>https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/</guid>
            <pubDate>Tue, 10 Dec 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will share the video and slides I presented at the Substrate Developer Conference (Sub0) which gives a deep dive into the storage layers of the Substrate blockchain development framework.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-share-the-video-and-slides-i-presented-at-the-substrate-developer-conference-sub0-which-gives-a-deep-dive-into-the-storage-layers-of-the-substrate-blockchain-development-framework">In this post, I will share the video and slides I presented at the Substrate Developer Conference (Sub0) which gives a deep dive into the storage layers of the Substrate blockchain development framework.<a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/#in-this-post-i-will-share-the-video-and-slides-i-presented-at-the-substrate-developer-conference-sub0-which-gives-a-deep-dive-into-the-storage-layers-of-the-substrate-blockchain-development-framework" class="hash-link" aria-label="Direct link to In this post, I will share the video and slides I presented at the Substrate Developer Conference (Sub0) which gives a deep dive into the storage layers of the Substrate blockchain development framework." title="Direct link to In this post, I will share the video and slides I presented at the Substrate Developer Conference (Sub0) which gives a deep dive into the storage layers of the Substrate blockchain development framework.">​</a></h5>
<p>This last week I was given the opportunity to present at the official Substrate Developer Conference where I gave a deep dive into the inner workings of Substrate storage.</p>
<p>As a runtime developer, you should know that storage is one of the most important things to keep in mind when designing and developing your new runtime modules. Having a deep understanding of how the different storage layers work and interact will be critical for you to make correct decisions moving forward.</p>
<p>Here is a video of my presentation, and the presentation itself:</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="video">Video<a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/#video" class="hash-link" aria-label="Direct link to Video" title="Direct link to Video">​</a></h2>
<iframe width="720px" height="480px" src="https://www.youtube.com/embed/9S8rmW8LD5o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="presentation">Presentation<a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/#presentation" class="hash-link" aria-label="Direct link to Presentation" title="Direct link to Presentation">​</a></h2>
<iframe src="/assets/presentations/substrate-storage-deep-dive.pdf" width="720px" height="480px"></iframe>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="questions">Questions?<a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/#questions" class="hash-link" aria-label="Direct link to Questions?" title="Direct link to Questions?">​</a></h2>
<p>Feel free to contact me with any questions you might have or any details you think I may have gotten wrong. As always, if you enjoy this content and want to continue to support me, take a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>.</p>]]></content:encoded>
            <category>storage</category>
            <category>database</category>
            <category>runtime</category>
            <category>sub0</category>
            <category>merkle</category>
            <category>patricia</category>
            <category>trie</category>
        </item>
        <item>
            <title><![CDATA[What is Substrate?]]></title>
            <link>https://shawntabrizi.com/blog/substrate/what-is-substrate/</link>
            <guid>https://shawntabrizi.com/blog/substrate/what-is-substrate/</guid>
            <pubDate>Mon, 30 Sep 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will try to explain the Substrate blockchain framework in a way that anyone with a bit of technical experience could understand.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-try-to-explain-the-substrate-blockchain-framework-in-a-way-that-anyone-with-a-bit-of-technical-experience-could-understand">In this post, I will try to explain the Substrate blockchain framework in a way that anyone with a bit of technical experience could understand.<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#in-this-post-i-will-try-to-explain-the-substrate-blockchain-framework-in-a-way-that-anyone-with-a-bit-of-technical-experience-could-understand" class="hash-link" aria-label="Direct link to In this post, I will try to explain the Substrate blockchain framework in a way that anyone with a bit of technical experience could understand." title="Direct link to In this post, I will try to explain the Substrate blockchain framework in a way that anyone with a bit of technical experience could understand.">​</a></h5>
<p>You may have heard before that Substrate is an <strong>extensible</strong>, <strong>modular</strong>, and <strong>open-source</strong> framework for building blockchains. But what does that mean?</p>
<p>Substrate provides you with all the core components needed to build a distributed blockchain network:</p>
<ul>
<li><a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#database">Database</a></li>
<li><a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#networking">Networking</a></li>
<li><a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#transaction-queue">Transaction Queue</a></li>
<li><a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#consensus">Consensus</a></li>
</ul>
<p>While these layers are extensible, Substrate mostly assumes the average blockchain developer should not care about the specific implementation details of these core components. Instead, Substrate's core philosophy is to make development of a blockchain's state transition function as flexible and easy as possible. This layer is called the <a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#substrate-runtime">Substrate runtime</a>.</p>
<p>But before we dive into all these details, first we need to establish a common understanding of what a blockchain is...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-a-blockchain">What is a Blockchain?<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#what-is-a-blockchain" class="hash-link" aria-label="Direct link to What is a Blockchain?" title="Direct link to What is a Blockchain?">​</a></h2>
<p>In its most basic form, a blockchain is a simple data structure where <em>blocks</em> of data are linked together forming an ordered <em>chain</em>. The specific details of a blockchain can vary depending on the functionality of that chain. However, at a high level, all blockchains should share some common properties.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blocks">Blocks<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#blocks" class="hash-link" aria-label="Direct link to Blocks" title="Direct link to Blocks">​</a></h3>
<p>Each block in a blockchain has some data that can be used to generate a unique identifier for that block. One part of this data is the unique identifier for the preceding block, known as the "parent block". Since each block has a pointer to its parent block, the blocks can be ordered in a deterministic way.</p>
<p><img loading="lazy" alt="Blockchain Blocks" src="https://shawntabrizi.com/assets/images/wis-blocks-a004205229a523c5bf5da84a982c69a6.png" width="600" height="220" class="img_ev3q"></p>
<p>Any small changes to the data in a block will change its unique ID. Since this block's ID changed, the block that comes after it (the "child block") will also change. Same with the next child, and the next one, and the next... In fact, all the blocks that come after the originally modified block will have to change their unique ID in order to maintain the chain! This means that it is easy to verify that two blockchains have the exact same data by simply checking the unique identifier of the last block on the chain.</p>
<blockquote>
<p>To learn more about these basics of a blockchain, visit the demo/videos found here: <a href="https://anders.com/blockchain/" target="_blank" rel="noopener noreferrer">https://anders.com/blockchain/</a></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="block-production">Block Production<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#block-production" class="hash-link" aria-label="Direct link to Block Production" title="Direct link to Block Production">​</a></h3>
<p>Due to these properties, blockchain systems are commonly used to keep track of a shared <a href="https://en.wikipedia.org/wiki/Ledger" target="_blank" rel="noopener noreferrer">ledger</a>. The contents of the ledger are changed not by changing an existing block, but by adding new blocks to the blockchain with instructions about how the state of the ledger should change from block to block. These instructions are commonly referred to as <em>transactions</em>.</p>
<p><img loading="lazy" alt="Block Production" src="https://shawntabrizi.com/assets/images/wis-block-production-68563f716e4ecd6d3efed4a6c7c369f2.png" width="600" height="376" class="img_ev3q"></p>
<p>There are usually rules associated with how the ledger can change, which are defined by a <a href="https://en.wikipedia.org/wiki/Transition_system" target="_blank" rel="noopener noreferrer">state transition function</a>. For cryptocurrency systems, these rules can be quite simple; for example:</p>
<blockquote>
<p><strong>Rule:</strong> Users can only spend funds that they own.</p>
</blockquote>
<p>These rules can also be more complex, even allowing for blockchain systems to act as a <a href="https://simple.wikipedia.org/wiki/Turing_complete" target="_blank" rel="noopener noreferrer">Turing complete</a> computer, and the ledger acting as that computer's storage.</p>
<p>Once a valid set of transactions are collected, they are put into the content of a block, and then this block is placed at the end of the chain. This block production process allows the underlying state of the blockchain to change over time.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="block-finalization">Block Finalization<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#block-finalization" class="hash-link" aria-label="Direct link to Block Finalization" title="Direct link to Block Finalization">​</a></h3>
<p>Now that a new block has been produced, it can be shared with others who want to construct the same shared ledger. However, since blockchains are decentralized in nature, it could be that two different, yet still valid blocks compete for the same position at the end of a chain. Different block finalization mechanisms can be used to determine which "chain of blocks" is the <em>canonical</em> blockchain. For any given blockchain, there should only be one true final state of the shared ledger. Any alternative states of the blockchain are known as "forks".</p>
<p><img loading="lazy" alt="Blockchain Fork" src="https://shawntabrizi.com/assets/images/wis-forking-71df695650c428a073ff78c678c8fd3e.png" width="600" height="236" class="img_ev3q"></p>
<p>Forks are normal, expected, and generally not a problem. The block finalization process is in place to help non-canonical chains get back in sync. We will return to forking later in this post.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="nodes">Nodes<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#nodes" class="hash-link" aria-label="Direct link to Nodes" title="Direct link to Nodes">​</a></h3>
<p>At this point, you should be able to see that blockchains are designed to be distributed and decentralized. You want multiple users around the world to be able to keep track of this shared ledger without the need of intermediary third parties. By following the rules above, each participant of this shared ledger can run a <em>node</em>, which is a computer program that follows the rules of the blockchain network and connects to other nodes that do the same, all without the need for a centralized service. Blockchain system are often "open" systems, which mean that anyone can participate. To prevent against malicious actors, mechanisms are put in place to incentivize good behavior while punishing bad behavior. With all of these mechanisms in place, a blockchain system can become an unstoppable machine.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-components">Substrate Components<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#substrate-components" class="hash-link" aria-label="Direct link to Substrate Components" title="Direct link to Substrate Components">​</a></h2>
<p>Now that you have a high level understanding of what a blockchain is, we can now start to understand how Substrate is a framework for building them. The first claim about the Substrate framework is that it is <strong>extensible</strong>. This means that it makes as few assumptions about how you design your blockchain and attempts to be as <em>generic</em> as possible.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="database">Database<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#database" class="hash-link" aria-label="Direct link to Database" title="Direct link to Database">​</a></h3>
<p>As we illustrated, the heart of a blockchain is its shared ledger that must be maintained and stored. Substrate makes no assumptions about the content or structure of the data in your blockchain. The underlying database layer uses simple key-value storage, on top of which a modified Patricia Merkle tree (<a href="https://github.com/paritytech/trie" target="_blank" rel="noopener noreferrer">trie</a>) is implemented. This special storage structure allows us to easily verify if an item is or is not in that storage. This is particularly important to support light clients, who will depend on these storage proofs to provide light-weight, yet trustless interactions with the blockchain network.</p>
<p><img loading="lazy" alt="Trie Structure" src="https://shawntabrizi.com/assets/images/wis-trie-5a8c290bd9aeeef1e5f55219243d9a9a.png" width="350" height="219" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="networking">Networking<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#networking" class="hash-link" aria-label="Direct link to Networking" title="Direct link to Networking">​</a></h3>
<p>In order for a decentralized blockchain system to communicate, it needs to establish a peer-to-peer networking protocol. Substrate uses <a href="https://github.com/libp2p" target="_blank" rel="noopener noreferrer">libp2p</a> as a modular peer-to-peer networking stack. Through this networking layer, Substrate-based blockchains are able to share transactions, blocks, peers, and other system critical details without the need for centralized servers. In line with Substrate's philosophy, libp2p is unique in the fact that it makes no assumptions about your specific networking protocol. As a result, you are able to implement and use different transports on top of a Substrate-based blockchain.</p>
<p><img loading="lazy" alt="Peer-to-Peer Networking" src="https://shawntabrizi.com/assets/images/wis-p2p-a499a0cce262ab950150f07b73efe654.png" width="600" height="258" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-queue">Transaction Queue<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#transaction-queue" class="hash-link" aria-label="Direct link to Transaction Queue" title="Direct link to Transaction Queue">​</a></h3>
<p>As mentioned above, transactions are collected and formed into blocks that ultimately define how the state of the blockchain changes. However, the order of these transactions can impact the final state of the ledger. Substrate allows you full control over the dependency and queue management of transactions on your network. Substrate only assumes that a transaction has a <em>weight</em> and a set of prerequisite <em>tags</em> that are used to create dependency graphs. These dependency graphs are linear in the simplest case, but they can become more complex. Substrate handles those complexities for you automatically.</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/wis-txq-6ef60ead454175df78fec3d63d3397e1.png" width="226" height="223" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="consensus">Consensus<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#consensus" class="hash-link" aria-label="Direct link to Consensus" title="Direct link to Consensus">​</a></h3>
<p>Recall that there are different ways that a blockchain network can come to consensus about changes to the chain. Traditionally, these consensus engines are tightly coupled to the other blockchain components. However, Substrate has spent extra effort designing a consensus layer that can be easily changed during development. In fact, it was made such that consensus could even be hot-swapped after the chain goes live! Built into Substrate are multiple different consensus engines such as traditional <a href="https://en.wikipedia.org/wiki/Proof_of_work" target="_blank" rel="noopener noreferrer">Proof of Work (PoW)</a>, <a href="https://github.com/poanetwork/wiki/wiki/Aura-Consensus-Protocol-Audit" target="_blank" rel="noopener noreferrer">Aura (Authority Round)</a>, and Polkadot consensus, which is unique in the fact that it separates the block production process (<a href="https://research.web3.foundation/en/latest/polkadot/BABE/Babe/" target="_blank" rel="noopener noreferrer">BABE</a>) from the block finalization process (<a href="https://research.web3.foundation/en/latest/polkadot/GRANDPA/" target="_blank" rel="noopener noreferrer">GRANDPA</a>).</p>
<p><img loading="lazy" alt="GRANDPA Consensus" src="https://shawntabrizi.com/assets/images/wis-grandpa-44847a526e8eb1f7ee66341e664dfcbf.png" width="600" height="674" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-runtime">Substrate Runtime<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#substrate-runtime" class="hash-link" aria-label="Direct link to Substrate Runtime" title="Direct link to Substrate Runtime">​</a></h2>
<p>So far, we have touched on all the core blockchain components that Substrate provides to you. As you have read, Substrate has made every effort to stay as generic and extensible as possible. However, arguably the most customizable part of Substrate is its <strong>modular</strong> runtime. The runtime is Substrate's <em>state transition function</em> that we mentioned earlier.</p>
<p>Substrate believes that the average blockchain developer does not need to care so much about the blockchain components listed above. As long as the components are battle-tested and production-ready, the implementation details are often of little importance. However, the core blockchain logic that determines what is and is not valid for a network is often of critical importance for any chain.</p>
<p><strong>Thus, Substrate's core philosophy is to make blockchain runtime development as flexible and easy as possible.</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-runtime-module-library-srml">Substrate Runtime Module Library (SRML)<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#substrate-runtime-module-library-srml" class="hash-link" aria-label="Direct link to Substrate Runtime Module Library (SRML)" title="Direct link to Substrate Runtime Module Library (SRML)">​</a></h3>
<p>A Substrate runtime is divided into separate logical components that are known as <em>runtime modules</em>. These modules will control some aspect of the on-chain logic managed by that blockchain. You can think of these modules like "plug-ins" for your system. As a Substrate developer, you are able to pick and choose the modules and functionality that you want to include in your chain.</p>
<p>For example, there is a module called "Balances" that manages the currency of the chain. There are also a set of modules like "Collective", "Democracy", and "Elections" that handle decision making and governance for the chain. There is even a module called "Contracts" that can turn any Substrate-based chain into a <a href="https://en.wikipedia.org/wiki/Smart_contract" target="_blank" rel="noopener noreferrer">smart contract</a> platform. These kinds of modules are provided to you automatically when you build on Substrate.</p>
<p>However, you are not limited to only the modules provided by Substrate. In fact, developers can easily build their own runtime modules, either as independent logical components, or even directly interacting with other runtime modules to build more complicated logic. I believe that long term, the module system in Substrate will act much like an "app store", where users can simply pick and choose the functionality they want to include, and with minimal technical expertise, deploy a distributed blockchain network!</p>
<p><img loading="lazy" alt="Modern App Store" src="https://shawntabrizi.com/assets/images/wis-app-store-4171b9a303df86ef4ec6b8da19e128f6.png" width="600" height="264" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="forkless-runtime-upgrades">Forkless Runtime Upgrades<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#forkless-runtime-upgrades" class="hash-link" aria-label="Direct link to Forkless Runtime Upgrades" title="Direct link to Forkless Runtime Upgrades">​</a></h3>
<p>If we follow the analogy of the Substrate module ecosystem acting like an app store, then we must also address how we update our runtime. Whether it be bug fixes, general improvements to existing modules, or even new features that you want to add to your blockchain, the ability to change your runtime is something that Substrate has made a first class process.</p>
<p>However, changes to the state transition function of your chain also impact consensus of the network. If one node running on your network has one version of your runtime logic, while another node has a different one, these two nodes will not be able to reach consensus with one another. They will fundamentally disagree on the true state of the ledger, resulting in what we defined earlier as a fork. These kinds of irreconcilable forks are bad because they reduce the security of your network, as only a subset of nodes will correctly create and verify new blocks.</p>
<p><img loading="lazy" alt="Blockchain Hard Fork Upgrade" src="https://shawntabrizi.com/assets/images/wis-upgrade-d22af5621333c471cce07f164b00bde2.png" width="600" height="236" class="img_ev3q"></p>
<p>Substrate has addressed this issue by having the network come to consensus about the runtime logic itself! Using the <a href="https://webassembly.org/" target="_blank" rel="noopener noreferrer">Wasm</a> binary format, we are able to put the Substrate runtime code on the blockchain as part of the shared ledger. This means that anyone running a node is able to verify that their node has the latest logic. If it does not, then it will instead execute the on-chain Wasm directly! This means runtime upgrades to your blockchain can happen in real time, on a live network, without creating forks!</p>
<p>In the spirit of Substrate's flexibility, you do not need to enable this feature at all. If you want to disable on-chain upgrades, you can. Truly, Substrate provides you with all the tools needed to create a living, breathing blockchain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="free-open-source-production-ready">Free, Open-Source, Production-Ready<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#free-open-source-production-ready" class="hash-link" aria-label="Direct link to Free, Open-Source, Production-Ready" title="Direct link to Free, Open-Source, Production-Ready">​</a></h2>
<blockquote>
<p><strong>Note:</strong> At the time of writing this post, Substrate is <strong>not</strong> production ready... but it almost is. Substrate is currently undergoing a security audit in preparation of a 2020 release of the Polkadot network.</p>
</blockquote>
<p>Substrate is a completely free and <a href="https://github.com/paritytech/substrate/blob/master/LICENSE" target="_blank" rel="noopener noreferrer"><strong>open-source</strong></a> project. It is built using the <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust programming language</a>, which is designed for creating fast and inherently safe software. Coordination and development of Substrate happens through public communities like <a href="https://github.com/paritytech/substrate" target="_blank" rel="noopener noreferrer">GitHub</a> and <a href="https://riot.im/app/#/room/!HzySYSaIhtyWrwiwEV:matrix.org" target="_blank" rel="noopener noreferrer">Riot</a>, with over 100 individual contributors.</p>
<p>Substrate is a project born from <a href="https://polkadot.network/" target="_blank" rel="noopener noreferrer">Polkadot</a>, a larger vision of a world with many interoperable blockchains. Substrate powers the blockchain that connects this public network in addition to most of the chains that will be connected to it. You can feel secure that the technology that backs your blockchain is the same technology that powers multiple other production-level blockchains.</p>
<p>Substrate aims to be the absolute best platform for blockchain innovators, and the natural choice for anyone who is thinking about building a blockchain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="https://shawntabrizi.com/blog/substrate/what-is-substrate/#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>At this point, I hope that you can see why we say that Substrate an <strong>extensible</strong>, <strong>modular</strong>, and <strong>open-source</strong> platform for building blockchain systems. At every point in the Substrate development process, keeping things generic has remained a priority. As a result, Substrate can be used as a platform to build future technologies, even those that are not yet thought of.</p>
<p>If you enjoy this content and want to see more, consider taking a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a> to see how you can support me.</p>]]></content:encoded>
            <category>runtime</category>
            <category>module</category>
            <category>block</category>
            <category>database</category>
            <category>networking</category>
            <category>transaction queue</category>
            <category>consensus</category>
        </item>
        <item>
            <title><![CDATA[Substrate Feeless Token Factory]]></title>
            <link>https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/</link>
            <guid>https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/</guid>
            <pubDate>Thu, 29 Aug 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will share the Hackathon project I worked on for ETHBerlin 2019, where we built a Substrate blockchain that supports generating fungible tokens that can be transferred without end-users paying fees.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-share-the-hackathon-project-i-worked-on-for-ethberlin-2019-where-we-built-a-substrate-blockchain-that-supports-generating-fungible-tokens-that-can-be-transferred-without-end-users-paying-fees">In this post, I will share the <a href="https://github.com/shawntabrizi/substrate-feeless-token-factory" target="_blank" rel="noopener noreferrer">Hackathon project</a> I worked on for ETHBerlin 2019, where we built a Substrate blockchain that supports generating fungible tokens that can be transferred without end-users paying fees.<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#in-this-post-i-will-share-the-hackathon-project-i-worked-on-for-ethberlin-2019-where-we-built-a-substrate-blockchain-that-supports-generating-fungible-tokens-that-can-be-transferred-without-end-users-paying-fees" class="hash-link" aria-label="Direct link to in-this-post-i-will-share-the-hackathon-project-i-worked-on-for-ethberlin-2019-where-we-built-a-substrate-blockchain-that-supports-generating-fungible-tokens-that-can-be-transferred-without-end-users-paying-fees" title="Direct link to in-this-post-i-will-share-the-hackathon-project-i-worked-on-for-ethberlin-2019-where-we-built-a-substrate-blockchain-that-supports-generating-fungible-tokens-that-can-be-transferred-without-end-users-paying-fees">​</a></h5>
<p>Ethereum has shown itself to be the ultimate platform for building token economies. Thousands of contracts have been created which support standards like ERC20 and ERC721.</p>
<p>However, businesses using Ethereum have struggled adopting new users into the ecosystem due to the upfront costs of Gas to interact with these token contracts. Many newcomers do not understand why they need ETH to be able to interact with other tokens they actually are interested in.</p>
<p>Businesses have shown that they would be more than happy to fund the usage of their users. Some have done this by providing a faucet or ETH drop to their users, while others have implemented layer 2 solutions or have made compromises building centralized solutions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-feeless-token-factory">A "Feeless" Token Factory<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#a-feeless-token-factory" class="hash-link" aria-label="Direct link to A &quot;Feeless&quot; Token Factory" title="Direct link to A &quot;Feeless&quot; Token Factory">​</a></h2>
<p>The <a href="https://github.com/shawntabrizi/substrate-feeless-token-factory" target="_blank" rel="noopener noreferrer">Substrate Feeless Token Factory</a> (SFTF) removes the pains and costs of token transfer fees from end users, by offloading those costs onto the token creators and community contributors who want to support a particular token.</p>
<p>Transaction fees are used as a mechanism to prevent denial-of-service attacks on public blockchain systems. SFTF is a blockchain level protocol, developed on top of the Substrate blockchain framework, which provides an alternative mechanism for transfer fees on tokens, while still preventing nominal attack vectors. In short, each token built on the network is backed by a fund of the native blockchain currency. This fund is ultimately used to pay for the transfers of that token, on behalf of the user.</p>
<p>Any user can deposit funds into the pot for a token, but we think that most often, it will be the token creator who will be most incentivized to fund their users to transfer and spend their tokens. Users are enabled only a certain number of free transfers per token within a given time period. These transfers are enabled by an extension of the standard ERC20 token API, introducing a <code>try_free_transfer</code> function which can allow a user to make a free transfer if underlying conditions are met.</p>
<p>Let's take a look at a hypothetical example: the "Better Energy Foundation" wants to issue a new token to be used as electricity credits. When they do this, they fund the token with an initial supply of the underlying blockchain currency (10,000,000 units), and specify that the users of their token have 10 free transactions every 1,000 blocks. They can sell their tokens and transfer them to the buyers just like a normal ICO. These buyers can then call the <code>try_free_transfer</code> function when trying to trade the token among their peers, and the fees are paid for using the fund. Assuming the underlying transfer fee being charged to the pot is 1 unit per transfer, the "Better Energy Foundation" has just supported millions of "free" transfers of their token. Anyone in the community can continue to add more funds, and allow the free transfers to continue when the funds start to dry up. If a user does not have any more "free" transactions left, or if the fund is empty, they can always make a transaction using the normal <code>transfer</code> function which will charge them a normal transaction fee directly from their own account.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design">Design<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#design" class="hash-link" aria-label="Direct link to Design" title="Direct link to Design">​</a></h2>
<p>First we designed a runtime module which acts as a normal ERC20 compatible token <em>factory</em>, this mean the module supports the creation of any number of different fungible tokens. This was mostly based on the <a href="https://github.com/paritytech/substrate/tree/master/frame/assets" target="_blank" rel="noopener noreferrer"><code>srml-assets</code> module</a>, but extended to expose an API which matches that of an ERC20 token: transfers on-behalf-of and allowances. We kept the token factory constructor simple by having the user mint all token up front into their own account, and controlling distribution manually.</p>
<p>Without touching any of the fee mechanisms, this module is basically a replacement for any number of ERC20 token contracts, but built at the Substrate runtime level, which should be more efficient and cost effective for everyone.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="removing-fees">Removing Fees<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#removing-fees" class="hash-link" aria-label="Direct link to Removing Fees" title="Direct link to Removing Fees">​</a></h3>
<p>At that point, we needed to remove fees from the runtime module. At the moment, Substrate runtime fees are controlled in two areas:</p>
<ol>
<li>The <a href="https://github.com/paritytech/substrate/blob/v1.0/srml/balances/src/lib.rs" target="_blank" rel="noopener noreferrer">Balances module</a>, which defines a <code>TransactionBaseFee</code> and <code>TransactionByteFee</code>.</li>
<li>The <a href="https://github.com/paritytech/substrate/pull/3157" target="_blank" rel="noopener noreferrer">weight annotation</a>, which allows you to control fees for an individual runtime function.</li>
</ol>
<p>We configured our runtime such that both the <code>TransactionBaseFee</code> and the <code>TransactionByteFee</code> would be set to 0:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pub const TransactionBaseFee: u128 = 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pub const TransactionByteFee: u128 = 0;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>NOTE: I think in the long term, the fees within the Balances module will be completely removed in favor of weight annotations. For the time being, weight annotations do not support the concept of "per byte fee", which is why I think it is still around.</p>
</blockquote>
<p>Originally, we thought this might be all that is needed to remove fees from our Runtime, however, if we do not specify a weight annotation for a runtime function, it is automatically assigned a default value:</p>
<p><a href="https://github.com/paritytech/substrate/blob/master/frame/support/src/weights.rs" target="_blank" rel="noopener noreferrer"><strong>sr-primitives/weights</strong></a></p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token class-name">Default</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">SimpleDispatchInfo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">default</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Default weight of all transactions.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">SimpleDispatchInfo</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">FixedNormal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">10_000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So what we actually need to do is label our function(s) explicitly with a zero weight tag:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#[weight = SimpleDispatchInfo::FixedNormal(0)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">my_free_function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We really only wanted to remove fees from the <code>transfer</code> function, not necessarily the other parts of the ERC20 API, so we decided to create a new function <code>try_free_transfer</code> which would have a fee of zero, and the additional functionality needed to protect our chain from malicious attacks.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="protecting-our-chain">Protecting Our Chain<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#protecting-our-chain" class="hash-link" aria-label="Direct link to Protecting Our Chain" title="Direct link to Protecting Our Chain">​</a></h3>
<p>The whole reason there are transfer fees on the blockchain is to protect the network from attackers who would be able to perform a denial-of-service attacks and spam the network with transactions. So, if we choose to remove the base fees from our transfer function, we would need to implement a new solution to prevent attacks to our chain.</p>
<p>Here is where you could get very clever, and someone with much more research and knowledge into game theory would probably come up with some really interesting solutions. But we were not those people, and we only had 1 day to build our solution, so we addressed this issue in the simplest way we could think of.</p>
<p>We know that businesses and organizations are the number one user of creating these tokenized assets. Usually they make a huge profit through an ICO and further development of their company. As a result, we predict in most cases they would happily eat any and all costs of fees related to using their token. So, we created an open fund for each token, where the standard token fee will be burned from that fund rather than the individuals who are transferring tokens. While this pot can obviously be funded by the token creators, we allowed open contributions to the pot in order to allow any community members who want to support a token to be able to do so.</p>
<p>To support this new functionality, we continued to develop our API to support an initial contribution when the token is created, and a <code>deposit</code> function allowing users to place funds in the pot for a token. If at any point the funds for a token is depleted, the fund can be replenished through new deposits. Futhermore, because we created a separate function for free transfers, we can still support the standard <code>transfer</code> function which has a standard fee and allows users to still use a token even when the fund is zero. Really, all these feeless transfer stuff is all extra functionality that is built on top of the token factory, which already works on its own!</p>
<p>One last point of friction we introduced was a limit per user, per token, per time period on how many transfers can be made. This prevents a malicious user from simply spending all of the pot by making frivolous transfers. This mechanism is still vulnerable to a <a href="https://en.wikipedia.org/wiki/Sybil_attack" target="_blank" rel="noopener noreferrer">Sybil attack</a>, where you can imagine an attacker generates millions of accounts and has account 1 send tokens to account 2, who sends tokens to account 3, etc...</p>
<p>However, this is hopefully thwarted by the need for an existential deposit of the base blockchain currency to make an active account. This existential deposit limit could be adjusted in order to provide the needed friction to prevent a single user from having too many accounts. Again, this initial existential deposit could be provided by the companies that want to support their users to use their tokens, and since there are no fees, only the minimum amount is needed to be given to a user, and only one time per user.</p>
<p>I think that the design here has lots of room for improvement, and there are likely a lot of different ways we could prevent malicious attacks on individual token funds, but for the hackathon, I felt that this was a reasonable first step.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-patterns">Substrate Patterns<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#substrate-patterns" class="hash-link" aria-label="Direct link to Substrate Patterns" title="Direct link to Substrate Patterns">​</a></h2>
<p>Having gone over all the details of how we designed the SFTF, I want to review a few of the specific implementation details which hopefully convey reusable design patterns for other Substrate runtime modules.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="module-funds">Module Funds<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#module-funds" class="hash-link" aria-label="Direct link to Module Funds" title="Direct link to Module Funds">​</a></h3>
<p>The main aspect of our feeless token is creating a fund for each token. Ultimately these funds will need to be controlled and managed by our module.</p>
<p>To do this, we create a unique identifier for our module, and use this to generate new accounts for the funds:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">MODULE_ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ModuleId</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token class-name">ModuleId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token string" style="color:#e3116c">b"coinfund"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">fund_account_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">TokenId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token constant" style="color:#36acaa">MODULE_ID</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into_sub_account</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Using the <code>into_sub_account</code> function, we can actually use the unique module id we created to generate any number of unique <code>AccountIds</code> which can then represent the funds for each of the tokens.</p>
<p>To then fund these accounts, we simply call the Balances module's <code>transfer</code> function, just like you would transfer to any other account:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">deposit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token attribute attr-name" style="color:#00a4db">#[compact]</span><span class="token plain"> token_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">TokenId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token attribute attr-name" style="color:#00a4db">#[compact]</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">BalanceOf</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> who </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> token_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Non-existent token"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Currency</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">transfer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">fund_account_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">deposit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RawEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Deposit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Since funds for different tokens are separated, we don't really need to do fancy tracking of the funds for each account. Instead, we can rely on the Balances module to do that for us! In our <code>try_free_transfer</code> function, we do the following:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Burn fees from funds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fund_account </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">fund_account_id</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fund_fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">FundTransferFee</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Currency</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">withdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fund_account</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fund_fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Transfer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ExistenceRequirement</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AllowDeath</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If the <code>withdraw</code> call fails, then the token does not have enough funds, and we simply fail to complete the <code>try_free_transfer</code>. Easy as pie.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tracking-transfers-per-time-period">Tracking Transfers Per Time Period<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#tracking-transfers-per-time-period" class="hash-link" aria-label="Direct link to Tracking Transfers Per Time Period" title="Direct link to Tracking Transfers Per Time Period">​</a></h3>
<p>One of the more challenging tricks we had to implement for this runtime module was a storage structure which would allow us to track how many time each user transferred a particular token in a given time period. If we simply wanted to count the total number of transfers, we would be able to create a regular map like so:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">TotalTransferCount</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">total_transfer_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">map</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">TokenId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, since we want to reset this count after a certain time period, this is not good enough. To use this regular map in this way, we would need to track each user which spent tokens in a time period, and which tokens they spent, and then we would need to do some unbounded loop over this mapping in order to clear all the entries. This is a big no-no.</p>
<p>The trick here is to take advantage of the <code>StorageDoubleMap</code>, which is just a map nested within a map. Most importantly, the <code>StorageDoubleMap</code> API provides the ability to clear all entries under a key in the top level map through <code>remove_prefix</code>. This means that I simply need to create a <code>double_map</code> where the first key is "fixed" (essentially treating the <code>double_map</code> as a regular <code>map</code>), and then call <code>remove_prefix</code> on that fixed first key when I want to clear all entries. This will clean up all of the data in our map without having to do a loop, which we know is generally a runtime sin.</p>
<p>Here is what the double map declaration looks like:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">FreeTransferCount</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">free_transfer_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">double_map</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">blake2_128</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">TokenId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">TokenFreeTransfers</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we want to keep track of the user's free transfers, we simply update the storage item like so:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> free_transfer_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">free_transfer_count</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sender</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> new_free_transfer_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> free_transfer_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checked_add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">One</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">one</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok_or</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"overflow when counting new transfer"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">FreeTransferCount</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">new_free_transfer_count</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally, when we want to clean up all the tracking and start fresh, we simply call the magical <code>remove_prefix</code> API:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// This function is called at the beginning of every block</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">on_initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Check is `true` every `FreeTransferPeriod` number of blocks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">FreeTransferPeriod</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token class-name">Zero</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">zero</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Reset everyone's free transfer count</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">FreeTransferCount</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">remove_prefix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>I would hope in the future, the <code>StorageMap</code> and <code>StorageDoubleMap</code> will implement a <code>kill</code> function like the <code>StorageValue</code> item has, which would allow a user to easily clear all entries of the mapping. It could even use this trick under the hood! However, it is unclear to me if there are significant costs to doing things this way. ¯\<em>(ツ)</em>/¯</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="https://shawntabrizi.com/blog/substrate/substrate-feeless-token-factory/#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h2>
<p>Because the hackathon is so short, and we were teaching new developers to start building on Substrate, the full potential of this idea was not created, nor was it even conceived. There is so much more potential for exploring how Substrate can enable "feeless" token transfers given that you have full control at the runtime level of how your blockchain operates. This is not feature that you would get with any open smart contract platform.</p>
<p>A few ideas which could further this project are:</p>
<ul>
<li>
<p>Upgrade the token API to support ERC1155, thus also supporting non-fungible tokens.</p>
</li>
<li>
<p>Allow payment of token transfers with the custom token rather than the underlying blockchain currency.</p>
<blockquote>
<p>We actually mostly did this in the SFTF by implementing <code>SignedExtension</code> for a custom <code>TakeTokenFees</code> struct. This has logic which transfers a token from the user to the block author, and increases the priority of the transaction. However, limitations of easily generating the correct extrinsic format meant that it would not work in time for the hackathon.</p>
</blockquote>
</li>
<li>
<p>Allow a small proof of work to replace the cost of transferring the token.</p>
</li>
<li>
<p>Create a ban list of users who are not allowed to use any free transfer funds.</p>
</li>
<li>
<p>Build a decentralized token exchange module which supports tokens generated from the factory.</p>
</li>
</ul>
<p>Do you have good ideas? Open an issue on the <a href="https://github.com/shawntabrizi/substrate-feeless-token-factory/" target="_blank" rel="noopener noreferrer">Substrate Feeless Token Factory</a> repository!</p>
<p>As always, if you enjoy this content and want to support me in continuing to write new posts, check out my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>.</p>]]></content:encoded>
            <category>runtime</category>
            <category>module</category>
            <category>erc20</category>
            <category>fee</category>
            <category>gas</category>
            <category>token</category>
            <category>ethberlin</category>
            <category>hackathon</category>
        </item>
        <item>
            <title><![CDATA[Querying Substrate Storage via RPC]]></title>
            <link>https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/</link>
            <guid>https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/</guid>
            <pubDate>Mon, 29 Jul 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, we will investigate how you can interact with the Substrate RPC endpoint in order to read storage items from your Substrate runtime.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-we-will-investigate-how-you-can-interact-with-the-substrate-rpc-endpoint-in-order-to-read-storage-items-from-your-substrate-runtime">In this post, we will investigate how you can interact with the Substrate RPC endpoint in order to read storage items from your Substrate runtime.<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#in-this-post-we-will-investigate-how-you-can-interact-with-the-substrate-rpc-endpoint-in-order-to-read-storage-items-from-your-substrate-runtime" class="hash-link" aria-label="Direct link to In this post, we will investigate how you can interact with the Substrate RPC endpoint in order to read storage items from your Substrate runtime." title="Direct link to In this post, we will investigate how you can interact with the Substrate RPC endpoint in order to read storage items from your Substrate runtime.">​</a></h5>
<blockquote>
<p>This post was updated to the latest changes in Substrate as of January 2020.</p>
</blockquote>
<p>Most of the posts I have written about Substrate so far have showed you how easy it is to build custom blockchains with this next generation framework. However, there is an entire set of parallel development and tools needed to enable users to easily interact with these new blockchain systems.</p>
<p>Our ultimate goal in this post is to <strong>query the balance of a Substrate user using the Substrate RPC</strong>. Along the way, we will paint a better picture of how Substrate interacts with the outside world by investigating storage structures, hashing algorithms, encoding schemes, public endpoints, metadata, and more!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-rpc-methods">Substrate RPC Methods<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#substrate-rpc-methods" class="hash-link" aria-label="Direct link to Substrate RPC Methods" title="Direct link to Substrate RPC Methods">​</a></h2>
<p>Substrate provides a set of RPC methods by default which allow you to interact, query, and submit to the actual node. The available RPC methods that Substrate exposes are documented as part of the <a href="https://polkadot.js.org/api/substrate/rpc.html" target="_blank" rel="noopener noreferrer">Polkadot-JS docs</a>. Your node actually exposes this information behind another RPC endpoint: <code>rpc_methods</code>.</p>
<p>To query the balance of a Substrate user, we will need to read into the runtime storage of the Balances module. This is done by calling the <code>getStorage</code> method in <code>state</code>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">getStorage(key: StorageKey, block?: Hash): StorageData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">summary: Retrieves the storage for a key</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Note that specifying a <code>block</code> here is optional. By default, it will query the latest block.</p>
</blockquote>
<p>The actual RPC method name is generated by combining the category with the documented function name, like so:</p>
<ul>
<li><code>state_getStorage</code></li>
</ul>
<p>However, to start simple, we will first query the Metadata endpoint for our Substrate node, which requires only knowledge of the method name: <code>state_getMetadata</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-rpc-endpoint">Substrate RPC Endpoint<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#substrate-rpc-endpoint" class="hash-link" aria-label="Direct link to Substrate RPC Endpoint" title="Direct link to Substrate RPC Endpoint">​</a></h2>
<p>To actually call these methods, you need access to a Substrate RPC endpoint. When you start a local Substrate node, two endpoints are made available to you:</p>
<ul>
<li>HTTP Endpoint: <a href="http://localhost:9933/" target="_blank" rel="noopener noreferrer">http://localhost:9933/</a></li>
<li>Websocket Endpoint: ws://localhost:9944/</li>
</ul>
<p>Most of the Substrate front-end libraries and tools use the more powerful WebSocket endpoint to interact with the blockchain. Through WebSockets, you can subscribe to various items, like events, and receive push notifications whenever changes in your blockchain occur.</p>
<p>For the purposes of this post, we will continue to keep things simple and use the HTTP endpoint to make JSON-RPC queries to our blockchain.</p>
<p>Let's first use this endpoint to call the RPC methods endpoint:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "rpc_methods"}' http://localhost:9933/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; {"jsonrpc":"2.0","result":{"methods":["account_nextIndex","author_insertKey","author_pendingExtrinsics","author_removeExtrinsic","author_rotateKeys","author_submitAndWatchExtrinsic","author_submitExtrinsic","author_unwatchExtrinsic","chain_getBlock","chain_getBlockHash","chain_getFinalisedHead","chain_getFinalizedHead","chain_getHead","chain_getHeader","chain_getRuntimeVersion","chain_subscribeFinalisedHeads","chain_subscribeFinalizedHeads","chain_subscribeNewHead","chain_subscribeNewHeads","chain_subscribeRuntimeVersion","chain_unsubscribeFinalisedHeads","chain_unsubscribeFinalizedHeads","chain_unsubscribeNewHead","chain_unsubscribeNewHeads","chain_unsubscribeRuntimeVersion","contracts_call","state_call","state_callAt","state_getChildKeys","state_getChildStorage","state_getChildStorageHash","state_getChildStorageSize","state_getKeys","state_getMetadata","state_getRuntimeVersion","state_getStorage","state_getStorageAt","state_getStorageHash","state_getStorageHashAt","state_getStorageSize","state_getStorageSizeAt","state_queryStorage","state_subscribeRuntimeVersion","state_subscribeStorage","state_unsubscribeRuntimeVersion","state_unsubscribeStorage","subscribe_newHead","system_accountNextIndex","system_chain","system_health","system_name","system_networkState","system_nodeRoles","system_peers","system_properties","system_version","unsubscribe_newHead"],"version":1},"id":1}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here you see a full list of available RPC apis. We can try calling the Metadata endpoint:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getMetadata"}' http://localhost:9933/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; {"jsonrpc":"2.0","result":"0x6d65746107481853797374656d011853797374656d3c304163636f756e744e6f6e636501010130543a3a4163636f756e74496420543a3a496e64657800200000000000000000047c2045787472696e73696373206e6f6e636520666f72206163636f756e74732e3845787472696e736963436f756e...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Yay! A basic RPC call to get the metadata from Substrate is successful! However, you will notice the result is a <em>large</em> hex value, which really isn't that helpful...</p>
<p>There is more to the story.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-encoding">Substrate Encoding<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#substrate-encoding" class="hash-link" aria-label="Direct link to Substrate Encoding" title="Direct link to Substrate Encoding">​</a></h2>
<p>What we haven't touched on yet are the various encoding mechanisms used by Substrate to both optimize serialization of data, but also provide safeties to the blockchain system.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="scale-codec">SCALE Codec<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#scale-codec" class="hash-link" aria-label="Direct link to SCALE Codec" title="Direct link to SCALE Codec">​</a></h3>
<p>If we try to naively decode the hex returned from the metadata endpoint using JavaScript, we get something like:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// From StackOverflow question 3745666</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hex_to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">metadata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> metadata</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">.</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">{1,2}</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">v</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token known-class-name class-name">String</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">fromCharCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">parseInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">hex_to_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0x6d65746107481853797374656d011853797374656d3c304163636f756e744e6f6e636501010130543a3a4163636f756e74496420543a3a496e64657800200000000000000000047c2045787472696e73696373206e6f6e636520666f72206163636f756e74732e3845787472696e736963436f756e..."</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"\u0000meta\u0007H\u0018System\u0001\u0018System&lt;0AccountNonce\u0001\u0001\u00010T::AccountId T::Index\u0000 \u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0000\u0004| Extrinsics nonce for accounts.8ExtrinsicCoun..."</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There is real data in there! However, it is not well formed.</p>
<p>To correctly parse the metadata, you will need to become familiar with is <a href="https://github.com/paritytech/parity-scale-codec" target="_blank" rel="noopener noreferrer">Parity's SCALE codec</a>:</p>
<blockquote>
<p>SCALE is a light-weight format which allows encoding (and decoding) which makes it highly suitable for resource-constrained execution environments like blockchain runtimes and low-power, low-memory devices.</p>
</blockquote>
<p>Parity uses SCALE for a number of reasons. <a href="https://github.com/gavofyork" target="_blank" rel="noopener noreferrer">Gav</a> mentioned that:</p>
<ul>
<li>It does not use Rust STD, and thus can compile to Wasm.</li>
<li>It is zero-copy and uses next to no memory on little-endian hardware for elementary numeric types.</li>
<li>It is built to have great support in Rust for deriving codec logic for new types: just add <code>#[derive(Encode, Decode)]</code>.</li>
<li>It is about as thin and lightweight as can be.</li>
</ul>
<p>Using the SCALE codec and parsing the Substrate metadata could be it's own blog post, so I will not go much deeper here; I just wanted to point out the main encoding scheme used by Substrate, and which shows up in the examples we have done so far.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-keys">Storage Keys<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#storage-keys" class="hash-link" aria-label="Direct link to Storage Keys" title="Direct link to Storage Keys">​</a></h3>
<p>For our goal, what we really want to learn is how to generate the storage keys for our various runtime storage items.</p>
<p>Substrate has a single key-value database for powering the entire blockchain framework. From this minimal data structure, additional abstractions can be constructed such as a <a href="https://github.com/paritytech/trie" target="_blank" rel="noopener noreferrer">Merkle Patricia tree ("trie")</a> that is used throughout Substrate.</p>
<p>At a base level, to gain access to any runtime storage item, you simply need to know it's storage key for the core key-value database. To prevent key collisions, a special schema is used to generate keys for Runtime module storage items:</p>
<ul>
<li>
<p>For storage values:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xxhash128("ModuleName") + xxhash128("StorageName")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>For storage maps:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xxhash128("ModuleName") + xxhash128("StorageName") + blake256hash("StorageItemKey")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>For storage double maps:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">xxhash128("ModuleName") + xxhash128("StorageName") + blake256hash("FirstKey") + blake256hash("SecondKey")</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>This constructs a "prefix trie", where all storage items for a module share a common prefix, where all storage keys under a storage item share a common prefix, and so on... This may not make a lot of sense right now, but we will do some practical examples below to hopefully clarify.</p>
<blockquote>
<p><strong>Learn More:</strong> Check out my deep-dive into Substrate storage <a href="https://shawntabrizi.com/blog/substrate/substrate-storage-deep-dive/">here</a>.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="querying-runtime-storage">Querying Runtime Storage<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#querying-runtime-storage" class="hash-link" aria-label="Direct link to Querying Runtime Storage" title="Direct link to Querying Runtime Storage">​</a></h2>
<p>We are almost to the finish line. Now that you know the different storage key encoding patterns, we can try to construct and query the runtime storage for a Substrate chain. Since you will need to use some cryptographic hash functions to try this yourself, I have loaded them for you on this blog post.</p>
<p>Open your browser console, and you will find utility functions under <code>util.*</code>, <code>util_crypto.*</code>, and <code>keyring.*</code>. These come from the <a href="https://polkadot.js.org/common/" target="_blank" rel="noopener noreferrer">polkadot-js/common</a> and will give you access to the hash functions like <code>util_crypto.xxhashAsHex</code> or <code>util_crypto.blake2AsHex</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-value-query">Storage Value Query<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#storage-value-query" class="hash-link" aria-label="Direct link to Storage Value Query" title="Direct link to Storage Value Query">​</a></h3>
<p>Let's start with a simple storage value, for instance getting the <a href="https://substrate.dev/rustdocs/v1.0/srml_sudo/index.html" target="_blank" rel="noopener noreferrer">Sudo user</a> for a Substrate chain. The module name is <code>Sudo</code> and the storage item which holds the <code>AccountId</code> is named <code>Key</code>.</p>
<p>Thus we would do the following:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">xxhashAsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Sudo"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x5c0d1176a568c1f92944340dbfed9e9c"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">xxhashAsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Key"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x530ebca703c85910e7164cb7d1c9e47b"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So the combined storage key would be:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x5c0d1176a568c1f92944340dbfed9e9c530ebca703c85910e7164cb7d1c9e47b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p><strong>Note:</strong> Note that we use XXHash to output a 128 bit hash. However, XXHash only supports 32 bit and 64 bit outputs. To correctly generate the 128 bit hash, we need to hash the same phrase twice, with seed <code>0</code> and seed <code>1</code>, and concatenate them.</p>
</blockquote>
<p>Now we can form an RPC request using this value as the <code>params</code> when calling the <code>state_getStorage</code> endpoint:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getStorage", "params": ["0x5c0d1176a568c1f92944340dbfed9e9c530ebca703c85910e7164cb7d1c9e47b"]}' http://localhost:9933/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; {"jsonrpc":"2.0","result":"0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d","id":1}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Success! The result here is the SCALE encoded AccountID of the Sudo user:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">keyring</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">encodeAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0xd43593c715fdd31c61141abd04a99fd6822c8558854ccde39a5684e7a56da27d"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is the familiar <code>Alice</code> account which we would expect on a <code>--dev</code> chain, and also matches what we get using the <a href="https://polkadot.js.org/apps/#/chainstate" target="_blank" rel="noopener noreferrer">Polkadot-JS UI</a>:</p>
<p><img loading="lazy" alt="Sudo Key for the Substrate --dev node" src="https://shawntabrizi.com/assets/images/sudo-key-dev-node-1327a48fc2effb51c6d3f784e51219de.png" width="2656" height="1460" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="storage-map-query">Storage Map Query<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#storage-map-query" class="hash-link" aria-label="Direct link to Storage Map Query" title="Direct link to Storage Map Query">​</a></h3>
<blockquote>
<p><strong>Note:</strong> The construction of storage keys for maps has slightly changed from when this was written. You can find an up to date version of that key construction in my post <a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/">"Transparent Keys in Substrate"</a>.</p>
</blockquote>
<p>As a final challenge, we will look to query a storage map like the balance of an account. The module name is <code>Balances</code> and the storage item we are interested in is named <code>FreeBalance</code>. They mapping for this storage item is from <code>AccountId -&gt; Balance</code>, so the storage item key we want to use is an <code>AccountId</code>.</p>
<p>We need to follow the same pattern as before, but append to the end the hash of the <code>AccountId</code>:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">xxhashAsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Balances"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0xc2261276cc9d1f8598ea4b6a74b15c2f"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">xxhashAsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"FreeBalance"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"0x6482b9ade7bc6657aaca787ba1add3b4"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">util_crypto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">blake2AsHex</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  keyring</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">decodeAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">256</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x2e3fb4c297a84c5cebc0e78257d213d0927ccc7596044c6ba013dd05522aacba"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So the final storage key in this case is:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b42e3fb4c297a84c5cebc0e78257d213d0927ccc7596044c6ba013dd05522aacba</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Just like before, we can form an RPC request using this value as the <code>params</code>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getStorage", "params": ["0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b42e3fb4c297a84c5cebc0e78257d213d0927ccc7596044c6ba013dd05522aacba"]}' http://localhost:9933</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"jsonrpc":"2.0","result":"0x0000a0dec5adc9353600000000000000","id":1}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The result here is now a SCALE encoded version of the <code>Balance</code> type, which is a u64 and thus trivially decodable (now that you know it is little endian):</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">hexToBn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"0x0000a0dec5adc9353600000000000000"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">isLe</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token string" style="color:#e3116c">"1000000000000000000000"</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Woohoo!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prefix-tries">Prefix Tries<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#prefix-tries" class="hash-link" aria-label="Direct link to Prefix Tries" title="Direct link to Prefix Tries">​</a></h2>
<p>Hopefully, you should be able to see they this storage key generation forms "prefix tries".</p>
<p>Let's say you wanted to query another user's balance. Well the construction of the key would make the first 256 bits exactly the same!</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># All Balances -&gt; FreeBalance storage keys start with</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This means you could actually use the <code>state_getKeys</code> API to get all the storage keys for all the free balances in your system!</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -H "Content-Type: application/json" -d '{"id":1, "jsonrpc":"2.0", "method": "state_getKeys", "params": ["0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4"]}' http://localhost:9933</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&gt; {"jsonrpc":"2.0","result":[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4024cd62ab7726e039438193d4bbd915427f2d7de85afbcf00bd16fadbcad6aed",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b42e3fb4c297a84c5cebc0e78257d213d0927ccc7596044c6ba013dd05522aacba",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b44724e5390fcf0d08afc9608ff4c45df257266ae599ac7a32baba26155dcf4402",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b454b75224d766c852ac60eb44e1329aec5058574ae8daf703d43bc2fbd9f33d6c",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b465d0de2c1f75d898c078307a00486016783280c8f3407db41dc9547d3e3d651e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b46b1ab1274bcbe3a4176e17eb2917654904f19b3261911ec3f7a30a473a04dcc8",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b477d14a2289dda9bbb32dd9313db096ef628101ac5bbb3b19301ede2c61915b89",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4927407fbcfe5afa14bcfb44714a843c532f291a9c33612677cb9e0ae5e2bd5de",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b494772f97f5f6b539aac74e798bc395119f39603402d0c85bc9eda5dfc5ae2160",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b49a9304efeee429067b2e8dfbcfd8a22d96f9d996a5d6daa02899b96bd7a667b1",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b49ea52149af6b15f4d523ad4342f63089646e29232a1777737159c7bc84173597",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4a315ee9e56d2f3bb24992a1cff6617b0f7510628a15722b680c42c2be8bb7452",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "0xc2261276cc9d1f8598ea4b6a74b15c2f6482b9ade7bc6657aaca787ba1add3b4c4a80eb5e32005323fb878ca749473d7e5f40d60ed5e74e887bc125a3659f258"],"id":1}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This basically allows you to enumerate across all the balances in a Substrate blockchain! Although, you would not necessarily know the <code>AccountId</code> for these balances...</p>
<blockquote>
<p><strong>Note:</strong> Now you CAN figure out the <code>AccountId</code> for all these balances! Learn how in my post <a href="https://shawntabrizi.com/blog/substrate/transparent-keys-in-substrate/">"Transparent Keys in Substrate"</a>.</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="https://shawntabrizi.com/blog/substrate/querying-substrate-storage-via-rpc/#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h2>
<p>If you made it this far, you probably have come to the same conclusion as me, which is that interacting with the Substrate RPC is not trivial. Substrate is optimized for performance, bandwidth, and execution, which leaves tasks like encoding and decoding of transactions, storage, metadata, etc... to the outside world.</p>
<p>That being said, once you are able to walk through these examples step by step, I think it becomes easier to understand what is going on, and even reproduce this logic on other platforms and languages. Certainly this is needed for the future Substrate ecosystem.</p>
<p>I have started a project called Substrate RPC Examples:</p>
<p><a href="https://github.com/shawntabrizi/substrate-rpc-examples" target="_blank" rel="noopener noreferrer">https://github.com/shawntabrizi/substrate-rpc-examples</a></p>
<p>The idea of this project is to provide some easy to read, "minimal library magic" examples of interacting with the Substrate RPC. So far, I have only used the tools available in <code>util</code>, <code>util_crypto</code>, and <code>keyring</code>, and ideally this can be reduced by introducing a few hand written functions.</p>
<p>The two samples I have described in this blog post (getting metadata, querying storage) are implemented. I hope to also add to it an example of a balance transfer, which will show how to sign a message. If you have any good ideas or examples that you would want to share with the world, feel free to open a <a href="https://github.com/shawntabrizi/substrate-rpc-examples/pulls" target="_blank" rel="noopener noreferrer">PR</a>.</p>
<p>I think the next follow up from this post should be a deep dive into the SCALE codec and how you can turn the Metadata you receive from a Substrate node into valid JSON.</p>
<p>As always, if you are enjoying the content I have produced, take a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a> to see how you can continue to support me.</p>]]></content:encoded>
            <category>runtime</category>
            <category>module</category>
            <category>rpc</category>
            <category>metadata</category>
            <category>storage</category>
            <category>scale</category>
            <category>hash</category>
        </item>
        <item>
            <title><![CDATA[Extending Substrate Runtime Modules]]></title>
            <link>https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/</link>
            <guid>https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/</guid>
            <pubDate>Fri, 28 Jun 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will show you how you can extend the SRML Contracts module to add additional authorization layers to your smart contract blockchain.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-show-you-how-you-can-extend-the-srml-contracts-module-to-add-additional-authorization-layers-to-your-smart-contract-blockchain">In this post, I will show you how you can extend the SRML Contracts module to add additional authorization layers to your smart contract blockchain.<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#in-this-post-i-will-show-you-how-you-can-extend-the-srml-contracts-module-to-add-additional-authorization-layers-to-your-smart-contract-blockchain" class="hash-link" aria-label="Direct link to In this post, I will show you how you can extend the SRML Contracts module to add additional authorization layers to your smart contract blockchain." title="Direct link to In this post, I will show you how you can extend the SRML Contracts module to add additional authorization layers to your smart contract blockchain.">​</a></h5>
<p>One of the best things about Substrate is the ability to easily execute on your ideas when developing blockchain systems. I want to show you a question from the first Substrate Developer Conference (Sub0) that lead to me investigating how one might extend the functionality of a runtime module with a "wrapper module".</p>
<p>Before we can jump in though, you will need to know a little about how the Substrate Contract module works.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="background">Background<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<p>The <a href="https://substrate.dev/rustdocs/v1.0/srml_contract/index.html" target="_blank" rel="noopener noreferrer">Contract module</a> is included in the Substrate Runtime Module Library (SRML) and provides your blockchain with the ability to execute Wasm smart contracts.</p>
<p>There is a two step process for deploying a smart contract using the Contract module:</p>
<ol>
<li>Putting the WebAssembly smart contract code on the blockchain.</li>
<li>Creating an instance of a smart contract with a new Contract account.</li>
</ol>
<p>This has a major advantage over existing smart contract platforms since you are able to create multiple instances of the same smart contract without needing to waste additional space with multiple instances of the contract code. For example, on Ethereum, each and every ERC-20 token uploads their own version of the ERC-20 contract. In Substrate, and with the Contracts module, a single ERC-20 Wasm smart contract can be uploaded, and many people can deploy their own tokens using customizable deployment parameters like initial balance, token name, etc...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="permissioned-access">Permissioned Access<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#permissioned-access" class="hash-link" aria-label="Direct link to Permissioned Access" title="Direct link to Permissioned Access">​</a></h2>
<p>So now that you are familiar with how to deploy contracts using the Contract module, let's hear the question that was asked at Sub0:</p>
<iframe width="720px" height="480px" src="https://www.youtube.com/embed/-EJHu0u6hT8?start=6405&amp;end=6573" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
<blockquote>
<p>Question: "Can you restrict which accounts can add code to the blockchain?"</p>
</blockquote>
<blockquote>
<p>Sergei: "Maybe you can write another module which just wraps the smart contract module, and just does this additional check..."</p>
</blockquote>
<p>While there are a few different ways you could approach solving this problem, it turns out <a href="https://github.com/pepyakin" target="_blank" rel="noopener noreferrer">Sergei</a>, as always, was absolutely correct about the best approach.</p>
<p>One <em>could</em> copy the entire Contract module and make changes directly to the source code (as I had originally suggested), but that means that any future updates and improvement to the Contract module would need to get added back into your fork of the module manually. This is definitely not a recommended approach, and one that I believe most users will naturally avoid anyway.</p>
<p>Rather, creating a "wrapper module" which somehow applies itself on top of the existing SRML Contract module, but allows for additional logic to be added, would be the best here. It would create clear separation between the vanilla module and the changes made by the end user, and would allow for the module to automatically stay up to date with the latest changes to Substrate.</p>
<p>So how would we do this?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-sudo-contract">Creating Sudo Contract<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#creating-sudo-contract" class="hash-link" aria-label="Direct link to Creating Sudo Contract" title="Direct link to Creating Sudo Contract">​</a></h2>
<p>I have created a Substrate runtime module called <a href="https://github.com/shawntabrizi/sudo-contract" target="_blank" rel="noopener noreferrer"><code>sudo-contract</code></a> which, as suggested, wraps the SRML Contract module, and provides a simple example on how you might execute similar wrapper modules.</p>
<p>As the name implies, <code>sudo-contract</code> uses both the SRML Sudo module and the SRML Contract module to make it so that only the "Sudo key" can put contract code on the blockchain. We did not change any other logic though, so there are no limits on who can deploy or call an instance of this smart contract. This combination of authorization to <code>put_code</code>, with open access to <code>create</code> and <code>call</code> enables for some practical use cases.</p>
<p>For example, imagine a DeFi (decentralized finance) platform controlled by a trusted smart contract development team like <a href="https://github.com/OpenZeppelin" target="_blank" rel="noopener noreferrer">OpenZeppelin</a>. This team would be able to provide a number of standardized, audited, and safe contracts for their users like an ICO contract, ERC-20 Contract, Multi-Signature Contract, etc... Users of this platform can choose from any of the standard contracts provided by the authorized team, and make their own instance of it for their needs.</p>
<p>With <code>sudo-contract</code>, this team would be able to tell their users that all smart contracts on their blockchain have been created and audited by their team. Thus, users can feel safe that there is no malicious code, backdoors, or generally broken contracts when using this platform.</p>
<p>This could provide a safer, and more consistent experience to all parties trying to take part in a larger decentralized financial system. Hopefully, you can imagine that the same can be done for other classes of smart contracts too!</p>
<p>So now that you are convinced of the utility of such a module, let's show you how you can build it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="wrapping-a-module">Wrapping a Module<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#wrapping-a-module" class="hash-link" aria-label="Direct link to Wrapping a Module" title="Direct link to Wrapping a Module">​</a></h3>
<p>The <code>sudo-contract</code> module needs to provide all the same functionalities of the SRML Contract module, but have additional authorization checks around just one of the functions: <code>put_code</code>.</p>
<p>As Sergei suggested, the best way to approach this is to write a "wrapper module", which basically means a module which exposes the same extrinsic calls as the Contract module and forwards those calls to the real Contract module.</p>
<p>For example, the Contract module exposes 4 dispatchable functions:</p>
<ul>
<li><code>update_schedule</code></li>
<li><code>put_code</code></li>
<li><code>create</code></li>
<li><code>call</code></li>
</ul>
<blockquote>
<p><strong>Note:</strong> We do not include special functions like <code>on_initialize</code>, <code>on_finalize</code>, <code>deposit_event</code>, etc... Only the ones which can be called via an extrinsic.</p>
</blockquote>
<p>In our <code>sudo-contract</code> module, one of these "wrapper functions" will look like this:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Simply forwards to the `create` function in the Contract module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[compact]</span><span class="token plain"> endowment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">BalanceOf</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[compact]</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Gas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    code_hash</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">CodeHash</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endowment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code_hash</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>All I have done here is copy the function signature for the <code>create</code> function, and then passed those parameters to the real <code>&lt;contract::Module&lt;T&gt;&gt;::create</code> function. You would do the same thing with each function until you have essentially created a "wrapped" module!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adding-authorization-checks">Adding Authorization Checks<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#adding-authorization-checks" class="hash-link" aria-label="Direct link to Adding Authorization Checks" title="Direct link to Adding Authorization Checks">​</a></h3>
<p>Creating a wrapper module like we have done above is not very useful as is, but using this pattern, we now have the ability to execute some additional logic before or after the main SRML Contract functions!</p>
<p>Our goal here is to add some additional authorization logic before the <code>put_code</code> function, where only the Sudo key can call this function. That is actually really easy and can be done like so:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Checks that sender is the Sudo `key` before forwarding to `put_code` in the Contract module.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">put_code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token attribute attr-name" style="color:#00a4db">#[compact]</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Gas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    code</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sender </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">sudo</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Sender must be the Sudo key to put_code"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> new_origin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">system</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">RawOrigin</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">put_code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">new_origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gas_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> code</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Here, we simply call into the Sudo module's storage to retrieve who the current Sudo key is, and check that the sender matches that key. If that check fails, we never make the downstream call to the SRML Contract module to actually put the code on the chain. Instead the module will return a runtime error:</p>
<blockquote>
<p>Sender must be the Sudo key to put_code</p>
</blockquote>
<p>and nothing will happen. It really is that easy!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-details">Other Details<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#other-details" class="hash-link" aria-label="Direct link to Other Details" title="Direct link to Other Details">​</a></h3>
<p>I won't go into a line by line instruction of creating the module, but there a few details I want to call out so that even new runtime developers can understand how some things work.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="accessing-other-modules">Accessing Other Modules<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#accessing-other-modules" class="hash-link" aria-label="Direct link to Accessing Other Modules" title="Direct link to Accessing Other Modules">​</a></h4>
<p>In my wrapper module, I have dependencies on both the SRML Contract module and SRML Sudo module. You can see in my code, I reference both modules to either call their functions or to read their storage. I am able to do this because I have imported these dependencies in my module's <code>Cargo.toml</code> file, and I have inherited the modules' traits into my own:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Trait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Trait</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">sudo</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Trait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will need to do this for any modules you wrap, and in our case this also implies that your runtime must use exactly these two modules.</p>
<p>We may look to revisit a wrapper module which does not depend on any specific module, but just one that has the traits, functions, and types expected. You could imagine this would be useful if another Contract module was released with alternative implementation details, but ultimately the same API. We would want our wrapper module to work for that module too!</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="calling-private-dispatchable-functions">Calling Private Dispatchable Functions<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#calling-private-dispatchable-functions" class="hash-link" aria-label="Direct link to Calling Private Dispatchable Functions" title="Direct link to Calling Private Dispatchable Functions">​</a></h4>
<p>A critical detail which makes this solution work so "easily" is that the dispatchable functions for the Contract module are marked <code>pub</code>, which means I can call them directly from my wrapper module. However, this is not a requirement for making a wrapper module since all dispatchable functions are made explicitly public through the <code>Call</code> type. What this really means is that your module can always "dispatch" a transaction to another module's function!</p>
<p>Here is an example of what that might look like:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">::</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">update_schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schedule</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dispatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This is exactly the same as calling the function directly, so no extra transactions will be recorded, no extra fees taken, etc...</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-sudo-contract">Adding Sudo Contract<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#adding-sudo-contract" class="hash-link" aria-label="Direct link to Adding Sudo Contract" title="Direct link to Adding Sudo Contract">​</a></h2>
<p>So I have already done the work for you to create the <code>sudo-contract</code> wrapper module. Now I want to share with you some of the nuances of adding it to your smart contract enabled runtime.</p>
<blockquote>
<p><strong>Note:</strong> If you want to add the <code>sudo-contract</code> module to your runtime, you should follow the <a href="https://github.com/shawntabrizi/sudo-contract" target="_blank" rel="noopener noreferrer">README</a> included with the module, since the next couple of sections may leave out smaller details.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="substrate-dependencies">Substrate Dependencies<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#substrate-dependencies" class="hash-link" aria-label="Direct link to Substrate Dependencies" title="Direct link to Substrate Dependencies">​</a></h3>
<p>I won't go into details about the challenges in creating a Substrate module as its own Rust library, but one thing you will need to be conscious of is the specific Substrate dependencies used by your runtime code.</p>
<p>In the <code>v1.0</code> branch of the <code>sudo-contract</code> module, I point all Substrate dependencies to the <code>v1.0</code> branch of Substrate. This means your runtime must <strong>also</strong> have all of its substrate dependencies point to the <code>v1.0</code> branch too. If your runtime is pointing to a specific git commit or a different branch, you will either need to update your runtime code or fork my wrapper module and update it to use exactly the same dependency.</p>
<p>You will also need to be sure to add this module to your runtime's <code>std</code> feature, so that it will use <code>std</code> features when building the native binaries for your runtime.</p>
<p>More details can be found in README for the <code>sudo-contract</code> module and the HOWTO of the <a href="https://github.com/shawntabrizi/substrate-module-template" target="_blank" rel="noopener noreferrer"><code>substrate-module-template</code></a>, which was used to create the <code>sudo-contract</code> module.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tricking-the-polkadot-ui">Tricking the Polkadot UI<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#tricking-the-polkadot-ui" class="hash-link" aria-label="Direct link to Tricking the Polkadot UI" title="Direct link to Tricking the Polkadot UI">​</a></h3>
<p>The next challenge we will overcome is how to trick the Polkadot UI into thinking our <code>sudo-contract</code> module, with the same public API, is the "real" Contract module of my chain.</p>
<p>The Polkadot UI is actually really simple when it comes to enabling and routing logic to module specific UI like the Contract module. All it does is check in the runtime metadata that the <code>name</code> of the module matches what it expects.</p>
<p>This metadata value is generated from the Rust dependency name chosen when importing the module into your project. So in the case of the SRML Contract module, you would normally import the module like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies.contract]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_features = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git = 'https://github.com/paritytech/substrate.git'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package = 'srml-contract'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">branch = 'v1.0'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Which would give it <code>"name": "contract"</code> in the metadata, which is exactly what the UI expects. So, we would be able to trick the UI by taking advantage of this and importing our module with the <code>contract</code> dependency name, and renaming the SRML Contract module:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies.srml-contract]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_features = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git = 'https://github.com/paritytech/substrate.git'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package = 'srml-contract'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">branch = 'v1.0'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies.contract]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_features = false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">git = 'https://github.com/shawntabrizi/sudo-contract.git'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package = 'sudo-contract'</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">branch = 'v1.0'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p><strong>Note</strong> that we imported our <code>sudo-contract</code> package from the <code>v1.0</code> branch, and our Substrate based depdencies are also coming from their <code>v1.0</code> branch, as described in the previous section.</p>
</blockquote>
<p>After making this change and updating our <code>std</code> feature appropriately, we will also need to update our runtime's <code>lib.rs</code> file.</p>
<p>Any references to the <code>contract</code> dependency which is intended for <code>srml-contract</code> will need to be updated, like the trait implementations:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// This is the srml-contract Trait</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">srml_contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Trait</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Currency</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Balances</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Call</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Event</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Event</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">Gas</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Note the updated names in these lines too!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">DetermineContractAddress</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">srml_contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">SimpleAddressDeterminator</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Runtime</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">ComputeDispatchFee</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">srml_contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">DefaultDispatchFeeComputor</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Runtime</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">TrieIdGenerator</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">srml_contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">TrieIdFromParentCounter</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Runtime</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token type-definition class-name">GasPayment</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// This is the sudo-contract Trait</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Trait</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Runtime</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With these changes, the Polkadot UI should think that the <code>sudo-contract</code> module is indeed the regular Contract module, and provide you with a great user experience for interacting with Smart Contracts, without any additional work from your side.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="making-srml-contract-un-callable">Making SRML Contract "Un-Callable"<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#making-srml-contract-un-callable" class="hash-link" aria-label="Direct link to Making SRML Contract &quot;Un-Callable&quot;" title="Direct link to Making SRML Contract &quot;Un-Callable&quot;">​</a></h3>
<p>The <code>sudo-contract</code> module would be pretty useless if it was possible to still call the contract module directly, bypassing this authorization check we just added. However, the whole point of this project is to keep the original module around so we aren't forking things.</p>
<p>Fortunately, it seems that Substrate was designed to be so modular and customizable that this scenario is already supported! <a href="https://github.com/paritytech/substrate/pull/2399#issuecomment-487597233" target="_blank" rel="noopener noreferrer">From Gav</a>:</p>
<blockquote>
<p>You can introduce a module entry into the runtime without the <code>Call</code> functionality which will prevent it from being routed to in a transaction.</p>
</blockquote>
<p>What he is saying here is that whereas we would normally import our SRML Contract module into the <code>construct_runtime!</code> macro like so:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token class-name">Contract</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">srml_contract</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token punctuation" style="color:#393A34">{</span><span class="token class-name">Module</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Call</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Storage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Config</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Event</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We can simply omit the <code>Call</code> type, and it will make our module "un-callable". This does not affect any of the other basic functionalities of our runtime like the module storage, module events, and even genesis configuration.</p>
<p>Then, when adding our <code>sudo-contract</code> module, we <em>do</em> include the <code>Call</code> type, but nothing else since our wrapper module does not have any storage or events of its own (but it could so don't think this is a limitation). Here is what our final <code>construct_runtime!</code> import would look like for these two modules:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Contract: srml_contract::{Module, Storage, Config&lt;T&gt;, Event&lt;T&gt;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SudoContract: contract::{Module, Call},</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-sudo-contract">Testing Sudo Contract<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#testing-sudo-contract" class="hash-link" aria-label="Direct link to Testing Sudo Contract" title="Direct link to Testing Sudo Contract">​</a></h2>
<p>So now that we have successfully added the <code>sudo-contract</code> module to our runtime, let's take a look at what happens when we use it.</p>
<p>I have a <a href="https://github.com/shawntabrizi/substrate-package/tree/sudo-contract" target="_blank" rel="noopener noreferrer"><code>sudo-contract</code> branch</a> in the <code>substrate-package</code> which you can use to run this wrapper module yourself, or double check the steps <a href="https://github.com/shawntabrizi/substrate-package/commit/c0c1e4604db279c5940f528c378575fa2c5aaf7a" target="_blank" rel="noopener noreferrer">in this PR</a> for adding it to your own runtime.</p>
<p>We build the Wasm runtime and the native binaries to start our node:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/build.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cargo build --release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./target/release/node-template purge-chain --dev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./target/release/node-template --dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When we run the node, we can interact with it using the Polkadot UI. We can immediately see that the UI recognizes that we have the Contract module included in our runtime:</p>
<p><img loading="lazy" alt="Screenshot of the Polkadot UI with Contract Tab" src="https://shawntabrizi.com/assets/images/sudo-contract-polkadot-ui-8de34e2d05e79d073f5217f4efa7d194.png" width="2244" height="1400" class="img_ev3q"></p>
<p>If we dig a little deeper into the details, we can see that the extrinsics section uses our <code>sudo-contract</code> version of the Contract module functions:</p>
<p><img loading="lazy" alt="Screenshot of the Contract Extrinsics" src="https://shawntabrizi.com/assets/images/sudo-contract-call-7a29538531aa49bd1436e51a97a513a4.png" width="2244" height="1400" class="img_ev3q"></p>
<blockquote>
<p>Notice that the comments with each function are the ones that we wrote in the wrapper module, and there are no other "contract" modules which can be called.</p>
</blockquote>
<p>Finally, if we look at the chain state tab, we will see that the UI and our runtime still manages the full storage of the SRML Contract module and that our module has no storage itself:</p>
<p><img loading="lazy" alt="Screenshot of the Contract Extrinsics" src="https://shawntabrizi.com/assets/images/sudo-contract-chain-state-01099038e8220bdb726769dfe8aa058a.png" width="2244" height="1400" class="img_ev3q"></p>
<p>So really we have set up our runtime exactly as we want.</p>
<p>Let's now try to use the Contract UI to create a new contract on our blockchain!</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="putting-code-on-the-chain">Putting Code On the Chain<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#putting-code-on-the-chain" class="hash-link" aria-label="Direct link to Putting Code On the Chain" title="Direct link to Putting Code On the Chain">​</a></h3>
<p>If our <code>sudo-contract</code> module is really working, then only the Sudo key will be able to put new contracts onto the blockchain. Since we are running a <code>--dev</code> chain, Alice is set as the Sudo key at the genesis of our blockchain.</p>
<p>So let's first try to put a new smart contract with <em>another</em> account. Let's fund Bob with enough units to deploy a contract, and try to upload the standard "flipper" contract. Here is what we will see in the UI:</p>
<p><img loading="lazy" alt="UI error message when Bob tries to upload contract" src="https://shawntabrizi.com/assets/images/sudo-contract-ui-error-60222c4ade300ecddbb0aadddbca5bcc.png" width="2244" height="1400" class="img_ev3q"></p>
<p>When we look at our node terminal to see what "went wrong" we find:</p>
<p><img loading="lazy" alt="Terminal error message when Bob tries to upload contract" src="https://shawntabrizi.com/assets/images/sudo-contract-terminal-error-013dfdb2ac8b2f1864ef3f703b96e6c6.png" width="1392" height="954" class="img_ev3q"></p>
<blockquote>
<p>"Runtime: Sender must be the Sudo key to put_code"</p>
</blockquote>
<p>So our wrapper module is indeed gating access to the underlying SRML Contract module.</p>
<p>Now we will try with Alice:</p>
<p><img loading="lazy" alt="Success when Alice tries to upload contract" src="https://shawntabrizi.com/assets/images/sudo-contract-ui-success-4acdcfe0aa2ace9c15c14e5f91d1a198.png" width="2244" height="1400" class="img_ev3q"></p>
<p>A success! Note that the <code>CodeStored</code> event which is emitted comes from <code>srmlContract</code>, which means ultimately the SRML Contract module is doing all of the work here. Our wrapper module is only doing the minimal it needs to in order to gate access. After this point, Bob or any other user can now create an instance of this contract.</p>
<p>We have successfully extended the SRML Contract module without making any forks or direct changes!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="https://shawntabrizi.com/blog/substrate/extending-substrate-runtime-modules/#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h2>
<p>While this post touches on a number of nuanced details about how we use Substrate to enable this end to end scenario, the big picture idea here should still be quite simple. You have now learned one approach to extending other Substrate runtime modules, and the possibilities with this are endless.</p>
<p>Here are some ideas you could try to hack on:</p>
<ul>
<li>Wrapper for the SRML Contract module which keeps track of all contracts that are uploaded with some additional metadata.</li>
<li>Wrapper for the SRML Balances module which adds a "pause" functionality to the blockchain, preventing calls to <code>transfer</code>.</li>
<li>Wrapper to the SRML Contract module which adds the ability for the Sudo key to "update" the Wasm code of a contract. (This will hopefully be the topic of a future post).</li>
</ul>
<p>Also, this implementation of <code>sudo-contract</code> is not perfect. If you wanted to improve it, consider adding any of the following:</p>
<ul>
<li>Adding module storage and some basic functions which allow you to control "privileged" accounts and remove the dependency on SRML Sudo.</li>
<li>Abstract away direct dependency on the SRML Contract module, and have the module work for wrapping any module which exposes the same dispatchable functions.</li>
<li>Add a second tier of authorization for <code>create</code> so that only some users can <code>put_code</code>, a larger (but still limited) set of users can <code>create</code>, but then all users can <code>call</code>.</li>
</ul>
<p>I hope that someone uses the <code>sudo-contract</code> module in their production blockchain. If you do end up using it, please let me know!</p>
<p>As always, if you like the content I produce and want to help me keep doing it, take a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donation page</a>.</p>]]></content:encoded>
            <category>runtime</category>
            <category>module</category>
            <category>rust</category>
            <category>sudo</category>
            <category>contracts</category>
            <category>ink</category>
        </item>
        <item>
            <title><![CDATA[Adding Fees to Your Substrate Runtime Module]]></title>
            <link>https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/</link>
            <guid>https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/</guid>
            <pubDate>Tue, 28 May 2019 00:14:03 GMT</pubDate>
            <description><![CDATA[In this post, I will show you how you can easily add a fee for calling a function within your Substrate runtime module.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-show-you-how-you-can-easily-add-a-fee-for-calling-a-function-within-your-substrate-runtime-module">In this post, I will show you how you can easily add a fee for calling a function within your Substrate runtime module.<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#in-this-post-i-will-show-you-how-you-can-easily-add-a-fee-for-calling-a-function-within-your-substrate-runtime-module" class="hash-link" aria-label="Direct link to In this post, I will show you how you can easily add a fee for calling a function within your Substrate runtime module." title="Direct link to In this post, I will show you how you can easily add a fee for calling a function within your Substrate runtime module.">​</a></h5>
<p>When using Substrate, you are afforded the flexibility to completely control the fee system within your runtime.</p>
<p>By default, a <a href="https://substrate.dev/rustdocs/v1.0/srml_balances/struct.Module.html#method.transaction_base_fee" target="_blank" rel="noopener noreferrer"><code>transaction_base_fee</code></a> is added to every transaction you make to your runtime. However, this blanket base fee does NOT take into account anything related to the complexity or storage used as a result of the transaction.</p>
<p>Substrate makes the following recommendation in the <code>Example</code> module:</p>
<blockquote>
<p>Ensure that calls into each of these [functions] execute in a time, memory and using storage space <strong>proportional to any costs paid for by the caller</strong> or otherwise the difficulty of forcing the call to happen.</p>
</blockquote>
<p>Thus, if your runtime module exposes functions which are heavy in computation or storage needs, you should be sure to add some <em>additional</em> fee on top of the base fee to ensure your blockchain is not attackable.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-simple-fee">A Simple Fee<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#a-simple-fee" class="hash-link" aria-label="Direct link to A Simple Fee" title="Direct link to A Simple Fee">​</a></h2>
<p>There are a lot of complicated methods you can use for calculating fees for functions. You can take a look at the <a href="https://github.com/paritytech/substrate/tree/v1.0/srml/contract" target="_blank" rel="noopener noreferrer">Contract module</a> for an example of that.</p>
<p>For this example, I will be showing you the most simple implementation of a fee which will be inline with the rest of your module code.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="withdrawing-from-balance">Withdrawing From Balance<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#withdrawing-from-balance" class="hash-link" aria-label="Direct link to Withdrawing From Balance" title="Direct link to Withdrawing From Balance">​</a></h3>
<p>The first tool we will use is the <a href="https://substrate.dev/rustdocs/v1.0/srml_support/traits/trait.Currency.html#tymethod.withdraw" target="_blank" rel="noopener noreferrer"><code>withdraw</code> function</a> provided by the <code>Currency</code> trait in the Balances module:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">withdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    who</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    liveness</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">ExistenceRequirement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NegativeImbalance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Removes some free balance from who account for reason if possible. If liveness is KeepAlive, then no less than ExistentialDeposit must be left remaining.</p>
<p>This checks any locks, vesting, and liquidity requirements. If the removal is not possible, then it returns Err.</p>
</blockquote>
<p>Withdraw is designed to be quite flexible. As you can see, it allows you to specify the reason for a withdrawal. In this case, we are taking a <em>fee</em>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// use support::traits::WithdrawReason</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Fee</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It can even make sure that removing these funds will not kill an account. For our fee system, this second point will be particularly important since we do not want users to accidentally destroy their account paying for fees!</p>
<p>For this, we simply pass:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// use support::traits::ExistenceRequirement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">ExistenceRequirement</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">KeepAlive</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Now we can really safely charge fees to a user upfront and let the logic of the Balances module handle the rest. For ease of reusability, we will create an internal function which can be called within our module to charge a fee to a user:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pay_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">balances</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Currency</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">withdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      amount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">ExistenceRequirement</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">KeepAlive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This function will either propagate an error from taking funds from the user, or will complete successfully and return <code>Ok(())</code>. We can then handle the error within our runtime.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="imbalance">Imbalance<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#imbalance" class="hash-link" aria-label="Direct link to Imbalance" title="Direct link to Imbalance">​</a></h4>
<p>One thing we glazed over at this point is the return type of the <code>withdraw</code> function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">NegativeImbalance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As you can see, it returns a <code>NegativeImbalance</code>, which is probably a type you have never seen before. Without going into <em>too</em> much detail, the <a href="https://github.com/paritytech/substrate/pull/2048" target="_blank" rel="noopener noreferrer">Imbalance system</a> within the Balances module is a way to ensure that the sum of all funds across all accounts is equal to the <code>TotalIssuance</code> managed by the Balances module.</p>
<p>So fortunately, this imbalances system <a href="https://stackoverflow.com/questions/56341343/is-handling-the-imbalance-type-mandatory-after-withdraw-or-deposit" target="_blank" rel="noopener noreferrer">does all of the hard work for us!</a> All we need to do is ignore this return type and we can be happy that the <code>TotalIssuance</code> is updated and this value is actually burned.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="charging-a-fee">Charging a Fee<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#charging-a-fee" class="hash-link" aria-label="Direct link to Charging a Fee" title="Direct link to Charging a Fee">​</a></h3>
<p>Now that we have created our <code>pay_fee</code> function, we need to call it within our runtime module. We will emulate a fixed fee system similar to the low level OPCODEs provided by Ethereum, where each function in our module can define some fixed cost to call the function.</p>
<p>This can be done easily by simply writing a function like so:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">decl_module!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Call</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Origin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">do_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> who </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1337</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">pay_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Do stuff after fee is paid successfully...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This function checks whether or not <code>pay_fee</code> returns successfully, and if not, it propagates the error up and stops execution of the runtime function.</p>
<p>In the situation where a user is unable to <code>withdraw</code> funds, we will see the error message:</p>
<blockquote>
<p>Runtime: too few free funds in account</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="converting-rust-primitives-to-substrate-specific-types">Converting Rust Primitives to Substrate Specific Types<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#converting-rust-primitives-to-substrate-specific-types" class="hash-link" aria-label="Direct link to Converting Rust Primitives to Substrate Specific Types" title="Direct link to Converting Rust Primitives to Substrate Specific Types">​</a></h4>
<p>You may notice that <code>pay_fee</code> and <code>withdraw</code> expect <code>fee</code> to be of type <code>T::Balance</code>.</p>
<p>Remember that Substrate is written to be <strong>very</strong> generic, so in the context of your runtime module, there are minimal assumptions about your blockchain's types.</p>
<p>For example, using this generic type system, you would be able to define one Substrate blockchain which uses <code>u64</code> for the <code>Balance</code> type, another which uses <code>u128</code>, and another which uses <code>u32</code>. Because we use this generic type system for all the core blockchain types, the same module can be used out of the box across all of these different blockchains!</p>
<p>But this flexibility also means you need to tell the Rust compiler what to do when trying to handle incompatible situations.</p>
<p>For example, what should the module do if we try to put a <code>u128</code> value into a <code>Balance</code> type which is represented as <code>u64</code>? Or if we try to convert that same balance to a <code>u32</code>?</p>
<p>Substrate <a href="https://stackoverflow.com/questions/56081117/how-do-you-convert-between-substrate-specific-types-and-rust-primitive-types" target="_blank" rel="noopener noreferrer">provides implementations</a> of <code>From</code>/<code>TryFrom</code> and <code>Into</code>/<code>TryInto</code> to handle such scenarios. The only assumption being made here is that all values are at least a <code>u32</code>.</p>
<p>These traits guarantee that the underlying types implement functions which will attempt to convert between types if possible.</p>
<p>Thus, if we ever need to convert some <code>u32</code> value to a <code>Balance</code>, we can simply call:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> my_balance</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> my_u32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the situation you need to convert some larger value, you will need to handle the situation where the <code>Balance</code> type is not compatible with type to be converted:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">u64_to_balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Option</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">try_into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that this returns an <code>Option</code>, thus your subsequent runtime logic needs to decide what to do when the conversion fails and the returned value is <code>None</code>.</p>
<p>Substrate also provides a <code>saturated_into</code> function which will always succeed, but will coerce your value into the type you want through saturation if necessary:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">u64_to_balance_saturated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">u64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">saturated_into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, it is very important that you be conscious when you do such things. From <a href="https://twitter.com/gavofyork" target="_blank" rel="noopener noreferrer">Gav</a>:</p>
<blockquote>
<p><code>SaturatedConversion</code> (<code>saturated_into</code> and <code>saturated_from</code>) should not be used unless you know what you're doing, you've thought and considered all options and your use-case implies that saturation is fundamentally correct. The only time I imagine this is the case is deep in runtime arithmetic where you are logically certain it will not overflow, but can't provide a proof because it would depend on consistent pre-existing state.</p>
</blockquote>
<p>Remember, as a runtime developer, Substrate provides you with numerous tools, but it is ultimately up to you to determine how to use them.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-minimal-complete-verifiable-example-module">A Minimal, Complete, Verifiable Example Module<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#a-minimal-complete-verifiable-example-module" class="hash-link" aria-label="Direct link to A Minimal, Complete, Verifiable Example Module" title="Direct link to A Minimal, Complete, Verifiable Example Module">​</a></h2>
<p>If you want to try out this simple fee system on your own Substrate chain, you can simply add a module like this to your runtime:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">support</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">decl_module</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">dispatch</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token namespace" style="opacity:0.7">traits</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token punctuation" style="color:#393A34">{</span><span class="token class-name">Currency</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">ExistenceRequirement</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">system</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token plain">ensure_signed</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// v1.0 branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// use runtime_primitives::traits::As;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Trait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">balances</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Trait</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property" style="color:#36acaa">decl_module!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Call</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Origin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">do_something</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> who </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1337</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// v1.0 branch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// let fee = T::Balance::sa(1337);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">pay_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fee</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Do stuff after fee is paid successfully...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">impl</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">pay_fee</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">balances</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Currency</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">_</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">withdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">who</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      amount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">WithdrawReason</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Fee</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token class-name">ExistenceRequirement</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">KeepAlive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we run a local node, we can interact with the module through the <a href="https://polkadot.js.org/apps/" target="_blank" rel="noopener noreferrer">Polkadot UI</a>:</p>
<p><img loading="lazy" alt="Image of Extrinsic Tab" src="https://shawntabrizi.com/assets/images/substrate-fee-extrinsic-044a3070a671072882b287f968ad9f2e.png" width="2476" height="1500" class="img_ev3q"></p>
<p>We have funded the Bob account with 2000 units, and we are charging a fee of 1337. When we call our function the first time, everything works as expected, and the 1337 unit fee (in addition to the base transaction fee of 1 unit) is removed from the account.</p>
<p><img loading="lazy" alt="Image of Fee Success" src="https://shawntabrizi.com/assets/images/substrate-fee-success-8bcf960f460759e6886e9be4ac99074a.png" width="2476" height="1500" class="img_ev3q"></p>
<p>However, when Bob does not have enough funds to make a second call, they will see a failure message:</p>
<p><img loading="lazy" alt="Image of Fee Failure" src="https://shawntabrizi.com/assets/images/substrate-fee-fail-23d785fb776c8d3da0d50b0df6ae9b26.png" width="2476" height="1500" class="img_ev3q"></p>
<blockquote>
<p>Note though that the 1 unit base transaction fee was still removed.</p>
</blockquote>
<p>If we look at our local node terminal, we can see the reason why this transaction failed:</p>
<p><img loading="lazy" alt="Image of Fee Error" src="https://shawntabrizi.com/assets/images/substrate-fee-error-b0332c67341e4562a0d0812e865054f8.png" width="1512" height="536" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="next-steps">Next Steps<a href="https://shawntabrizi.com/blog/substrate/adding-fees-to-your-substrate-runtime-module/#next-steps" class="hash-link" aria-label="Direct link to Next Steps" title="Direct link to Next Steps">​</a></h2>
<p>As mentioned, this is a very minimal and simplistic implementation of a fee system. However, this should give you the tools necessary to build your own advance fee system. Here are some cool ideas:</p>
<ul>
<li>Create some authorization layer where certain users get lower fees than the average user.</li>
<li>Allow fees to be paid using other tokens that your runtime manages.</li>
<li>Have your fee be calculated based on any input from the user. For example, if you let the user store some <code>Vec&lt;u8&gt;</code>, you can charge them some linear cost based on the length of the data.</li>
</ul>
<p>Do you have other ideas? Let me know!</p>
<p>As always, if you enjoy my content, take a quick look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donation page</a> to help support future work.</p>]]></content:encoded>
            <category>runtime</category>
            <category>module</category>
            <category>rust</category>
            <category>fees</category>
            <category>balance</category>
            <category>ethereum</category>
        </item>
        <item>
            <title><![CDATA[Substrate Smart Contracts Workshop]]></title>
            <link>https://shawntabrizi.com/blog/substrate/substrate-smart-contracts-workshop/</link>
            <guid>https://shawntabrizi.com/blog/substrate/substrate-smart-contracts-workshop/</guid>
            <pubDate>Sun, 28 Apr 2019 22:17:06 GMT</pubDate>
            <description><![CDATA[We recently held our very first Sub0 conference right next to the Parity office in Berlin.]]></description>
            <content:encoded><![CDATA[<p>We recently held our very first Sub0 conference right next to the Parity office in Berlin.</p>
<p>Sub0 was an event bringing together users from around the world who share our vision of the future and believe in the technologies we are developing at Parity... and there are quite a few things we are building.</p>
<p>One of the things we showed off for the first time during Sub0 was ink! (previously known as the PDSL), a Rust eDSL for building Wasm smart contracts on Substrate!</p>
<p>This smart contract platform is pretty much the child of two Parity developers: Robin (<a href="https://github.com/Robbepop" target="_blank" rel="noopener noreferrer">Robbepop</a>) and Sergei (<a href="https://github.com/pepyakin" target="_blank" rel="noopener noreferrer">Pepyakin</a>). They were so kind as to get me up to speed on what they had built, and it was surprisingly mature and well developed.</p>
<p>I spent a few weeks learning about the end to end smart contract system, including the Contract module provided by Substrate and the three different layers of the ink! language.</p>
<p>Then, the day before Sub0, I spent <a href="https://github.com/shawntabrizi/substrate-contracts-workshop/commit/c6e0223018c17841e342dccc47842a8e18afab55" target="_blank" rel="noopener noreferrer">2</a><a href="https://github.com/shawntabrizi/substrate-contracts-workshop/commit/7c26536795e80e0504575dfccf8f8c8871f3eaf4" target="_blank" rel="noopener noreferrer">4</a> hours building a brand new workshop based on the same structure as the <a href="https://github.com/shawntabrizi/substrate-collectables-workshop" target="_blank" rel="noopener noreferrer">Substrate Collectables Workshop</a>.</p>
<p><a href="https://github.com/shawntabrizi/substrate-contracts-workshop" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5cccc806a30b1-060bdd38db4f169d90a78f8e10ed3114.png" width="801" height="659" class="img_ev3q"></a></p>
<p>Through this tutorial we teach you how to:</p>
<ul>
<li>Set up the ink! development environment</li>
<li>Deploy and interact with the pre-built <code>flipper</code> contract</li>
<li>Write an "incrementer" contract</li>
<li>Write an ERC20 Token</li>
</ul>
<p>I am also looking to add instructions for building:</p>
<ul>
<li>An ERC721 Token</li>
<li>A non-token contract, maybe something that more directly interacts with a Substrate module</li>
</ul>
<p>Anyway, I would love for you all to try it out, and hopefully by the time you do, it will have been much more developed!</p>
<p>If you like the work I do, take a quick look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donation page</a> to help support future endeavors.</p>]]></content:encoded>
            <category>smart contracts</category>
            <category>rust</category>
        </item>
        <item>
            <title><![CDATA[The Sudo Story in Substrate]]></title>
            <link>https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/</link>
            <guid>https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/</guid>
            <pubDate>Thu, 14 Mar 2019 17:05:44 GMT</pubDate>
            <description><![CDATA[In this post, I will explain how the Sudo module is used to access permissioned functions in Substrate.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="in-this-post-i-will-explain-how-the-sudo-module-is-used-to-access-permissioned-functions-in-substrate">In this post, I will explain how the Sudo module is used to access permissioned functions in Substrate.<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#in-this-post-i-will-explain-how-the-sudo-module-is-used-to-access-permissioned-functions-in-substrate" class="hash-link" aria-label="Direct link to In this post, I will explain how the Sudo module is used to access permissioned functions in Substrate." title="Direct link to In this post, I will explain how the Sudo module is used to access permissioned functions in Substrate.">​</a></h5>
<p>If you have ever run a local Substrate node for testing or development, you have probably interacted with the Sudo module. More specifically, you might have noticed that the "Alice" account is special, and can do powerful things to your blockchain!</p>
<p>In this blog post, I will show you end to end how the Sudo module works, why "Alice" is able to use this module, and how it enables access to permissioned functions like the one which enables Substrate runtime upgrades.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-sudo">What is Sudo?<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#what-is-sudo" class="hash-link" aria-label="Direct link to What is Sudo?" title="Direct link to What is Sudo?">​</a></h2>
<blockquote>
<p><code>sudo</code> is a program for Unix-like computer operating systems that allows users to run programs with the security privileges of another user, by default the <strong>superuser</strong>. It originally stood for "superuser do"...</p>
<p>-- <cite>Wikipedia</cite></p>
</blockquote>
<p>In short, <code>sudo</code> is a term used to represent the execution of some highly privileged operation by some highly privileged user. If you are trying to relate this to smart contracts on Ethereum, this is very similar to <a href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/ownership/Ownable.sol" target="_blank" rel="noopener noreferrer">the "contract owner"</a>, an account who is allowed to call <code>onlyOwner</code> functions.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-sudo-module">The Sudo Module<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#the-sudo-module" class="hash-link" aria-label="Direct link to The Sudo Module" title="Direct link to The Sudo Module">​</a></h2>
<p>The Substrate runtime module library (SRML) provides a Sudo module which provides this same functionality, but at the runtime level of your blockchain. At the time of writing this post, the Sudo module is <a href="https://github.com/paritytech/substrate/blob/v1.0/srml/sudo/src/lib.rs" target="_blank" rel="noopener noreferrer">only 60 lines of code</a>, so you can easily look through the source code yourself to understand exactly what it does. But I will break it down for you just in case you are unfamiliar with the structure of Runtime modules.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-sudo-key">The Sudo Key<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#the-sudo-key" class="hash-link" aria-label="Direct link to The Sudo Key" title="Direct link to The Sudo Key">​</a></h3>
<p>The Sudo module has a single storage item: the "Sudo key".</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">decl_storage!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Store</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">Sudo</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/// The `AccountId` of the sudo key.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Key</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">config</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This holds the <code>AccountId</code> of the person who is the "superuser" of your blockchain. Notice that it has the <code>config()</code> parameter, which means that this value can be set using the "genesis configuration" of your blockchain. We will talk about that more below.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-sudo-module-functions">The Sudo Module Functions<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#the-sudo-module-functions" class="hash-link" aria-label="Direct link to The Sudo Module Functions" title="Direct link to The Sudo Module Functions">​</a></h3>
<p>The Sudo module has two dispatchable functions which allow users to interact with the module.</p>
<p>The first function available in the Sudo module is <code>set_key(origin, new)</code>, which allows only the Sudo key to change who the Sudo key is. This is not that interesting, so we won't go into details.</p>
<p>The second function is <code>sudo(origin, proposal)</code>, which allows only the Sudo key to dispatch a privileged call. This authorization check is done in the first two lines of the function:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sender </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"only the current sudo key can sudo"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then the function dispatches actually happens:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> proposal</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dispatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">system</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">RawOrigin</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Root</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">into</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>There are a few different things to note about this innocuous line:</p>
<ul>
<li>The <code>proposal</code> variable is another dispatchable function within your runtime, and is accepted as an input to the <code>sudo</code> function.</li>
<li>This <code>proposal</code> is called using <code>system::RawOrigin::Root</code>, which defines the <em>new</em> origin for the downstream call.</li>
</ul>
<p>At this point, you might be asking "What does this whole <code>RawOrigin::Root</code> mean?"</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="privileged-functions">Privileged Functions<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#privileged-functions" class="hash-link" aria-label="Direct link to Privileged Functions" title="Direct link to Privileged Functions">​</a></h2>
<p>The Sudo module wouldn't do much unless there were also "sudo-able" functions, and that is precisely what we will talk about next.</p>
<p>Substrate has the concept of "Privileged Functions" which are functions which specifically require <code>Root</code> origin. The <code>origin</code> of a call describes where the call has come from, and every dispatchable function should check at the beginning of the function that the call origin matches what is expected. The origin could be <code>Signed</code> as it was in the Sudo module, which represents a basic signed transaction, but Substrate also provides a <code>Root</code> origin which describes a call that comes from <em>within</em> the runtime itself. There is no way to produce a <code>Root</code> origin other than through internal runtime logic, and as such, we can treat functions that require this origin as privileged functions.</p>
<p>This is what a privileged function look like:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">decl_module!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token type-definition class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">enum</span><span class="token plain"> </span><span class="token type-definition class-name">Call</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">where</span><span class="token plain"> origin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Origin</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">privileged_function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ensure_root</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// do something...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However, macro magic makes this a bit more confusing. Generally, there is a rule for dispatchable functions where the first parameter must always be <code>origin</code>. However, when using the <code>decl_module!</code> macro, if you omit the <code>origin</code> parameter, then it will be added automatically, and <code>ensure_root(origin)?</code> will also be added. So an equivalent way to write the <code>privileged_function</code> above would be:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">privileged_function</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// do something...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>So these kinds of functions will only be callable by internal runtime logic like what is implemented in the Sudo module.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-substrate-runtime-upgrade">A Substrate Runtime Upgrade<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#a-substrate-runtime-upgrade" class="hash-link" aria-label="Direct link to A Substrate Runtime Upgrade" title="Direct link to A Substrate Runtime Upgrade">​</a></h2>
<p>So let's take a look at a real privileged function which is available within all Substrate runtimes, the runtime upgrade. From the <a href="https://github.com/paritytech/substrate/blob/v1.0/srml/system/src/lib.rs" target="_blank" rel="noopener noreferrer">System module</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/// Set the new code.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">pub</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">set_code</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">new</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">storage</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">unhashed</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">put_raw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token namespace" style="opacity:0.7">well_known_keys</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token constant" style="color:#36acaa">CODE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">new</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This single line of logic is enough to power the entire "upgrade" feature of Substrate forkless runtime upgrades. This privileged function checks that the caller must have <code>Root</code> origin, thanks to the <code>decl_module!</code> macro, then it puts the Wasm bytecode into a <code>well_known_key</code> called <code>CODE</code>.</p>
<p>Thus, when you use something like the Polkadot UI to do a runtime upgrade, it will look like this:</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5ccc8f228649c-0cc67199b8c5cbc0db31211ea72d25af.png" width="2108" height="966" class="img_ev3q"></p>
<p>Walking through the UI you will see that:</p>
<ul>
<li>We are making a transaction using "Alice", who has been set as the Sudo key.</li>
<li>We are calling the <code>sudo</code> function of the Sudo module.</li>
<li>The proposal we are making is the <code>setCode</code> function of the Consensus module.</li>
<li>Of which the input to <code>setCode</code> is the <code>wasm</code> file for our new runtime.</li>
</ul>
<p>When this transaction is dispatched, the following logic is executed:</p>
<ol>
<li>The <code>sudo</code> function checks that "Alice" is the Sudo key.</li>
<li>She is, so the rest of the function runs.</li>
<li>A <code>Root</code> origin call is dispatched to the <code>setCode</code> function.</li>
<li>The <code>setCode</code> function checks that the origin is <code>Root</code>.</li>
<li>It is, so the rest of the function runs.</li>
<li>The storage value is updated for the <code>CODE</code> well known key.</li>
</ol>
<p>And that is the magic of the Sudo module! The last thing we should probably talk about is how "Alice" became the Sudo module to begin with, and for that we need to look at the genesis configuration of our blockchain.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="initializing-the-sudo-key">Initializing the Sudo key<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#initializing-the-sudo-key" class="hash-link" aria-label="Direct link to Initializing the Sudo key" title="Direct link to Initializing the Sudo key">​</a></h2>
<p>Have you wondered why your substrate test network gives "Alice" a bunch of initial "balance units" and makes her the Sudo key for your runtime? Well, this is all controlled in your blockchain genesis configuration which is defined in a file called <a href="https://github.com/paritytech/substrate/blob/v1.0/node-template/src/chain_spec.rs" target="_blank" rel="noopener noreferrer"><code>chain_spec.rs</code></a>.</p>
<p>We can see that this code ultimately creates a <code>GenesisConfig</code> object with the following initial setting:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Some</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">SudoConfig</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> root_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we follow the logic back, this <code>root_key</code> is defined as <code>account_key("Alice")</code> which generates an <code>AccountId</code> using the seed string "Alice".</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">account_key</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token keyword" style="color:#00009f">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">AccountId</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">sr25519</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Pair</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">from_string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token macro property" style="color:#36acaa">format!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"//{}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"static values are valid; qed"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">public</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This works great for test networks since "Alice" can be treated as a well known account that is automatically configured in your UI. However, for a real network, this is probably not what you want to do. Instead, you should pass an <code>AccountId</code> directly to this genesis configuration, and keep the seed for this account VERY secret.</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5ccc92f09f522-7517ff126dc6e4788610fd73a96f9d43.png" width="1230" height="416" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-end">The End<a href="https://shawntabrizi.com/blog/substrate/the-sudo-story-in-substrate/#the-end" class="hash-link" aria-label="Direct link to The End" title="Direct link to The End">​</a></h2>
<p>That is the entire sudo story in Substrate. I hope you learned something new and that this shed light to some of the things happening behind the scenes of Substrate runtimes.</p>
<p>If you enjoyed this content and want to support me producing more, feel free to check out my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donation page</a>.</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Substrate at FOSDEM 2019]]></title>
            <link>https://shawntabrizi.com/blog/substrate/substrate-at-fosdem-2019/</link>
            <guid>https://shawntabrizi.com/blog/substrate/substrate-at-fosdem-2019/</guid>
            <pubDate>Mon, 11 Feb 2019 23:01:50 GMT</pubDate>
            <description><![CDATA[I had the amazing opportunity to speak about Substrate at the Free and Open source Software Developers' European Meeting (FOSDEM).]]></description>
            <content:encoded><![CDATA[<p>I had the amazing opportunity to speak about Substrate at the Free and Open source Software Developers' European Meeting (FOSDEM).</p>
<p>In my talk, I talk about:</p>
<ul>
<li>The basics of blockchains and blockchain development</li>
<li>Parity's history building blockchains</li>
<li>How Substrate came to be as a result of building the Polkadot Network</li>
<li>The basics of Substrate</li>
<li>The value of Rust and Wasm as next generation tools to build Substrate</li>
<li>How these same tools enable forkless runtime upgrades</li>
<li>A live demo of a forkless runtime upgrade</li>
<li>How you can learn to develop on Substrate using the Substrate Kitties Workshop</li>
</ul>
<p>You can check out the full talk on my YouTube channel:</p>
<iframe src="https://www.youtube.com/embed/ELubZ6Rl3iI" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" width="720px" height="480px" frameborder="0"></iframe>
<p>I still need to work on public speaking: being clear, talking slowly, and not getting too nervous. I hope that I can continue to speak about Substrate and not only spread word about this awesome technology we are developing, but also to work on these skills.</p>
<p>You can find my slides on the <a href="https://fosdem.org/2019/schedule/event/substrate/" target="_blank" rel="noopener noreferrer">FOSDEM site</a>.</p>]]></content:encoded>
            <category>blockchain</category>
            <category>parity</category>
            <category>programming</category>
            <category>speaking</category>
            <category>substrate</category>
            <category>video</category>
        </item>
        <item>
            <title><![CDATA[CryptoKitties on Substrate]]></title>
            <link>https://shawntabrizi.com/blog/substrate/cryptokitties-on-substrate/</link>
            <guid>https://shawntabrizi.com/blog/substrate/cryptokitties-on-substrate/</guid>
            <pubDate>Wed, 30 Jan 2019 22:57:52 GMT</pubDate>
            <description><![CDATA[You saw in my last post that I started to investigate Substrate runtime development by building a simple proof of existence blockchain.]]></description>
            <content:encoded><![CDATA[<p>You saw in my last post that I started to investigate Substrate runtime development by building a simple <a href="https://shawntabrizi.com/substrate/proof-of-existence-blockchain-with-substrate/" target="_blank" rel="noopener noreferrer">proof of existence</a> blockchain.</p>
<p>I wanted to take it a step further, and develop a more feature rich runtime module to see what the developer experience is like. Naturally, I decided to build CryptoKitties, or at least some subset of the game, on Substrate. If you are unfamiliar, CryptoKitties is one of the most popular Ethereum DApps which is notorious for almost breaking the Ethereum network with crazy high transaction fees.</p>
<p>The CryptoKitties game is something I am actually pretty familiar with thanks to the CryptoZombies tutorial that was created to teach new developers about smart contract development. I even wrote a summary of <a href="https://shawntabrizi.com/ethereum/shawn-notes-cryptozombies-lessons-1-5-in-solidity/" target="_blank" rel="noopener noreferrer">what I learned going through the tutorial</a> nearly a year ago.</p>
<p>The CryptoZombies tutorial was such an important part of my experience when I was first learning about Solidity, and really these kinds of 0 to 60 tutorials are so important to build a community of developers who can actually build on your platform.</p>
<p>Long story short, I created an extensive tutorial for building a CryptoKitties like runtime module on Substrate called the "Substrate Collectables Workshop".</p>
<p><a href="https://shawntabrizi.github.io/substrate-collectables-workshop/#/" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5c8ed01e77c2f-14adefd6c55fe654d242802adc4bbdb2.png" width="749" height="658" class="img_ev3q"></a></p>
<p>I took a lot of inspiration from the CryptoZombies tutorial and all the things they did right. Check it out, and tell me what you think!</p>
<p>Source is of course open source on <a href="https://github.com/shawntabrizi/substrate-collectables-workshop" target="_blank" rel="noopener noreferrer">GitHub</a>.</p>]]></content:encoded>
            <category>blockchain</category>
            <category>parity</category>
            <category>programming</category>
            <category>runtime</category>
            <category>substrate</category>
        </item>
        <item>
            <title><![CDATA[Proof of Existence Blockchain with Substrate]]></title>
            <link>https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/</link>
            <guid>https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/</guid>
            <pubDate>Tue, 01 Jan 2019 03:54:39 GMT</pubDate>
            <description><![CDATA[This post will show you how easy it is to build a proof of existence blockchain with a user interface using Parity's Substrate framework.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="this-post-will-show-you-how-easy-it-is-to-build-a-proof-of-existence-blockchain-with-a-user-interface-using-paritys-substrate-framework">This post will show you how easy it is to build a proof of existence blockchain with a user interface using Parity's Substrate framework.<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#this-post-will-show-you-how-easy-it-is-to-build-a-proof-of-existence-blockchain-with-a-user-interface-using-paritys-substrate-framework" class="hash-link" aria-label="Direct link to This post will show you how easy it is to build a proof of existence blockchain with a user interface using Parity's Substrate framework." title="Direct link to This post will show you how easy it is to build a proof of existence blockchain with a user interface using Parity's Substrate framework.">​</a></h5>
<p>2019 will surely be remembered as an exciting year for blockchain development and decentralized applications. Just in time for the new year, Parity's Substrate was <a href="https://www.parity.io/substrate-has-arrived/" target="_blank" rel="noopener noreferrer">officially released in beta</a>.</p>
<p>If you are unfamiliar with <a href="https://github.com/paritytech/substrate" target="_blank" rel="noopener noreferrer">Substrate</a>, it is a development framework enabling users to easily build custom blockchains. Whereas blockchain development would normally require you to develop peer-to-peer networking, a database layer, a JSON RPC, consensus algorithms, and more, Substrate provides you with enterprise ready, battle-test software which you can customize for your needs.</p>
<p>To illustrate the simplicity of developing on Substrate, I thought I would try to build one of a simplest practical blockchains that you can develop: <a href="https://en.wikipedia.org/wiki/Proof_of_Existence" target="_blank" rel="noopener noreferrer">a proof of existence blockchain</a>.</p>
<blockquote>
<p>Proof of Existence is an online service that verifies the existence of computer files as of a specific time via timestamped transactions in the bitcoin blockchain.</p>
</blockquote>
<p>The first proof of existence platform was built as a sort of "hack" on top of the Bitcoin network. At that time, it would be pretty impractical to build an entire blockchain platform for just this purpose, but with Substrate, not only is it practical, but it is actually easy!</p>
<p>You can find the repository for this ongoing project here:</p>
<p><a href="https://github.com/shawntabrizi/substrate-proof-of-existence" target="_blank" rel="noopener noreferrer">https://github.com/shawntabrizi/substrate-proof-of-existence</a></p>
<p>So let's jump right in!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-a-substrate-chain">Running a Substrate Chain<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#running-a-substrate-chain" class="hash-link" aria-label="Direct link to Running a Substrate Chain" title="Direct link to Running a Substrate Chain">​</a></h2>
<p>Out of the box, Substrate provides you with all the tools you need to run a blockchain. Along with the underlying infrastructure (networking, database, consensus, etc...), Substrate comes with a <a href="https://github.com/paritytech/substrate/tree/master/frame" target="_blank" rel="noopener noreferrer">library of runtime modules</a> which give you the features and functionalities of modern blockchains:</p>
<ul>
<li>Balances (tokens, transfers, etc...)</li>
<li>Democracy (stakeholder voting)</li>
<li>Contract (smart contract platform)</li>
<li>and more!</li>
</ul>
<p>Note that a 'runtime' is just logic that powers your blockchain. For example, the state transition function in <a href="https://github.com/ethereum/wiki/wiki/White-Paper#bitcoin-as-a-state-transition-system" target="_blank" rel="noopener noreferrer">Bitcoin</a> or <a href="https://github.com/ethereum/wiki/wiki/White-Paper#ethereum-state-transition-function" target="_blank" rel="noopener noreferrer">Ethereum</a> could be thought of as the runtimes of those blockchains. These modules, along with custom modules that you develop, can be put together on Substrate to build a custom blockchain.</p>
<p>Parity provides a bare-bones <a href="https://github.com/shawntabrizi/substrate-package" target="_blank" rel="noopener noreferrer">substrate node template</a> which integrates a few of these modules into an out-of-the-box working blockchain. This is <a href="https://substrate.readme.io/v1.0.0/docs/creating-a-custom-substrate-chain#section-prerequisites" target="_blank" rel="noopener noreferrer">all I needed to do</a> to set up a running chain:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://getsubstrate.io -sSf | bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substrate-node-new proof-of-existence "Shawn Tabrizi"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">substrate-ui-new proof-of-existence</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can then start the blockchain by going into the <code>proof-of-existence</code> folder and running:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./target/release/proof-of-existence --dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And finally you can interact with this chain using the <code>proof-of-existence-ui</code> by running:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">npm run dev</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" alt="An image of the Substrate UI" src="https://shawntabrizi.com/assets/images/Screen-Shot-2018-12-31-at-10.36.32-AM-6ec2f3efc32e895ae295d59c22ff1ba6.png" width="1624" height="1176" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="developing-the-proof-of-existence-runtime-logic">Developing the Proof of Existence Runtime Logic<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#developing-the-proof-of-existence-runtime-logic" class="hash-link" aria-label="Direct link to Developing the Proof of Existence Runtime Logic" title="Direct link to Developing the Proof of Existence Runtime Logic">​</a></h2>
<p>Now that we have things running, we want to add our own runtime logic on top to create a proof of existence blockchain. Fortunately, the logic we need to build is pretty simple and straightforward. Essentially, we just need to maintain some storage on the blockchain which establishes:</p>
<ul>
<li>An owner</li>
<li>A file hash (or <a href="https://en.wikipedia.org/wiki/File_verification" target="_blank" rel="noopener noreferrer">file digest</a>)</li>
<li>The timestamp of the verification</li>
</ul>
<p>Then, we need to create a function which allows a user to write to this storage and claim a file if it has not already been claimed before. For additional user-friendliness, we can also add a function which allows the specific owner of a file to revoke their claim, so that someone else may claim the file in the future.</p>
<p>Continuing to follow <a href="https://substrate.readme.io/v1.0.0/docs/creating-a-custom-substrate-chain#section-step-3-create-a-new-runtime-module" target="_blank" rel="noopener noreferrer">this tutorial</a> we can learn the basics of building a new runtime module. Here is a link to the entire proof of existence runtime that I wrote: <a href="https://github.com/shawntabrizi/substrate-proof-of-existence/blob/e4011fca36f19b0d015c82f9badeb5ef644ea165/proof-of-existence/runtime/src/proof_of_existence.rs" target="_blank" rel="noopener noreferrer">proof-of-existence/runtime/src/proof_of_existence.rs</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a-closer-look">A Closer Look<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#a-closer-look" class="hash-link" aria-label="Direct link to A Closer Look" title="Direct link to A Closer Look">​</a></h3>
<p>Let's take a look at a few of the different parts:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property" style="color:#36acaa">decl_storage!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">trait</span><span class="token plain"> </span><span class="token type-definition class-name">Store</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Trait</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">POEStorage</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token class-name">Proofs</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proofs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> map </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">AccountId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Moment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can see our storage structure is quite simple. Just a mapping between a <code>Vec&lt;u8&gt;</code> (bytearray) to a tuple of <code>AccountID</code> and <code>Moment</code> (the substrate equivalent of time).</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">create_claim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> digest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Proofs</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"This digest has already been claimed"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sender </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">timestamp</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">balances</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">decrease_free_balance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">As</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">sa</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">POE_FEE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Proofs</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">insert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">digest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">clone</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">deposit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RawEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ClaimCreated</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the user calls the <code>create_claim()</code> function, they provide a signed message including the digest they want to claim. We check that the digest has not already been claimed and that the messaged is signed, where we can also derive the AccountID of the sender.</p>
<p>In my version of the runtime, we charge the user a fee to create a claim. For that operation, we call <code>decrease_free_balance()</code> which will also check whether or not the full amount can be deducted from the account. If the account does not have enough funds, it will throw an error, which stops the transaction.</p>
<p>Note that only after we have done all these checks do we modify the storage and <code>insert()</code> the claim. This is important because if you modify the storage, and the transaction fails at some later point, the storage will remain modified. Substrate warns about this in <a href="https://github.com/paritytech/substrate/blob/v1.0/srml/example/src/lib.rs" target="_blank" rel="noopener noreferrer">their documentation</a>:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Since this is a dispatched function there are two extremely important things to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// remember:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - MUST NOT PANIC: Under no circumstances (save, perhaps, storage getting into an</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// irreparably damaged state) must this function panic.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - NO SIDE-EFFECTS ON ERROR: This function must either complete totally (and return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// `Ok(())` or it must have no side-effects on storage and return `Err('Some reason')`.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The revoke function is basically the same, but going the other direction:</p>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">revoke_claim</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> digest</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token class-name">Vec</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u8</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Proofs</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"This digest has not been claimed yet"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> sender </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ensure_signed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">origin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _time</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">proofs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token macro property" style="color:#36acaa">ensure!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"You must own this claim to revoke it"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">Proofs</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">balances</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Module</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">increase_free_balance_creating</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">T</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">Balance</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> </span><span class="token class-name">As</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">u64</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">sa</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">POE_FEE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">Self</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">deposit_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token class-name">RawEvent</span><span class="token punctuation" style="color:#393A34">::</span><span class="token class-name">ClaimRevoked</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> digest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>We importantly check that the owner of the file is the same as the sender requesting to revoke the claim. After we remove the mapping from storage, we then return the funds which were initially spent to create the claim.</p>
<p>Both the <code>create_claim()</code> and the <code>revoke_claim()</code> function ends with an event being generated, which reports to the outside world when a user makes or revokes a claim. This event can be used to detect a successful transaction, or lack thereof.</p>
<p>In addition to the <code>proof_of_existence.rs</code> file we created, we also needed to modify other parts of the <code>substrate-node-template</code> to integrate this new module into our blockchain. You can learn more about those details by <a href="https://substrate.readme.io/v1.0.0/docs/creating-a-custom-substrate-chain#section-step-4-integrate-our-new-module-into-our-runtime" target="_blank" rel="noopener noreferrer">completing the tutorial</a> that we previously referenced.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-user-interface-for-our-chain">Creating a User Interface for Our Chain<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#creating-a-user-interface-for-our-chain" class="hash-link" aria-label="Direct link to Creating a User Interface for Our Chain" title="Direct link to Creating a User Interface for Our Chain">​</a></h2>
<p>Now that we have completed our custom runtime, we need a way to allow our users to easily interact with this new functionality. For that, we will modify the <a href="https://github.com/paritytech/substrate-ui/tree/substrate-node-template" target="_blank" rel="noopener noreferrer">substrate-ui</a> that we generated earlier.</p>
<p>The <a href="https://substrate.readme.io/v1.0.0/docs/creating-a-custom-substrate-chain#section-step-7-updating-our-substrate-ui" target="_blank" rel="noopener noreferrer">custom runtime tutorial</a> already showed you some of the basics of modifying the <code>substrate-ui</code>, but for our needs, we will need to write some custom React components.</p>
<p>Here is what our segment in the <code>app.jsx</code> file will look like:</p>
<div class="language-jsx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-jsx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> raw </span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Segment</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">margin</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript string" style="color:#e3116c">'1em'</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">padded</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Header</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">as</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag attr-value" style="color:#e3116c">h2</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Icon</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">name</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag attr-value" style="color:#e3116c">lock</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Header.Content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">			Proof of Existence</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">			</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">Header.Subheader</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Claim ownership of your digital files</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Header.Subheader</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Header.Content</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Header</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">paddingBottom</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript string" style="color:#e3116c">'1em'</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">style</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">fontSize</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript string" style="color:#e3116c">'small'</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text">Owner</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">SignerBond</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">bond</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeAccount</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">If</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">condition</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeAccount</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">ready</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">then</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;</span><span class="token tag script language-javascript tag" style="color:#00009f">span</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">			</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;</span><span class="token tag script language-javascript tag class-name" style="color:#00009f">Label</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f">Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">				</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;</span><span class="token tag script language-javascript tag class-name" style="color:#00009f">Label.Detail</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">					</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;</span><span class="token tag script language-javascript tag class-name" style="color:#00009f">Pretty</span><span class="token tag script language-javascript tag" style="color:#00009f"> </span><span class="token tag script language-javascript tag attr-name" style="color:#00a4db">value</span><span class="token tag script language-javascript tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript tag script language-javascript" style="color:#00009f">runtime</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript tag script language-javascript property-access" style="color:#00009f">balances</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript tag script language-javascript method function property-access" style="color:#d73a49">balance</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript tag script language-javascript property-access" style="color:#00009f">poeAccount</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript tag" style="color:#00009f"> </span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">/&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">				</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag script language-javascript tag class-name" style="color:#00009f">Label.Detail</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">			</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag script language-javascript tag class-name" style="color:#00009f">Label</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript plain-text" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript plain-text" style="color:#00009f">		</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag script language-javascript tag" style="color:#00009f">span</span><span class="token tag script language-javascript tag punctuation" style="color:#393A34">&gt;</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">FileDigestBond</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">bond</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeDigest</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag attr-value" style="color:#e3116c">Select File</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">		</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">DigestTag</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">value</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f">runtime</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">proof_of_existence</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">proofs</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeDigest</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag attr-name" style="color:#00a4db">account</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeAccount</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"> </span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">div</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text">	</span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag class-name" style="color:#00009f">TransactButton</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">content</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag attr-value" style="color:#e3116c">Claim File</span><span class="token tag attr-value punctuation" style="color:#393A34">"</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">icon</span><span class="token tag attr-value punctuation attr-equals" style="color:#393A34">=</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag attr-value" style="color:#e3116c">lock</span><span class="token tag attr-value punctuation" style="color:#393A34">'</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">		</span><span class="token tag attr-name" style="color:#00a4db">tx</span><span class="token tag script language-javascript script-punctuation punctuation" style="color:#393A34">=</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript punctuation" style="color:#393A34">{</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">			</span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">sender</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> </span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeAccount</span><span class="token tag script language-javascript punctuation" style="color:#393A34">,</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">			</span><span class="token tag script language-javascript literal-property property" style="color:#36acaa">call</span><span class="token tag script language-javascript operator" style="color:#393A34">:</span><span class="token tag script language-javascript" style="color:#00009f"> calls</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">proof_of_existence</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript method function property-access" style="color:#d73a49">createClaim</span><span class="token tag script language-javascript punctuation" style="color:#393A34">(</span><span class="token tag script language-javascript keyword" style="color:#00009f">this</span><span class="token tag script language-javascript punctuation" style="color:#393A34">.</span><span class="token tag script language-javascript property-access" style="color:#00009f">poeDigest</span><span class="token tag script language-javascript punctuation" style="color:#393A34">)</span><span class="token tag script language-javascript" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag script language-javascript" style="color:#00009f">		</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag script language-javascript punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f"></span><br></span><span class="token-line" style="color:#393A34"><span class="token tag" style="color:#00009f">	</span><span class="token tag punctuation" style="color:#393A34">/&gt;</span><span class="token plain-text"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain-text"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag class-name" style="color:#00009f">Segment</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> endraw </span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-components">Custom Components<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#custom-components" class="hash-link" aria-label="Direct link to Custom Components" title="Direct link to Custom Components">​</a></h3>
<p>You can see we added two new components: the <code>FileDigestBond</code> and the <code>DigestTag</code>.</p>
<p>The <code>FileDigestBond</code> is very similar to the <code>FileUploadBond</code> which is provided as a part of the <code>substrate-ui</code>, but instead of returning the content of the file, it will return the digest by simply hashing that content. We can clone the <code>FileUploadBond</code> component, and modify a small section like so:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> file</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fileReader </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">FileReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fileReader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method-variable function-variable method function property-access" style="color:#d73a49">onloadend</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token arrow operator" style="color:#393A34">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fileContents </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">target</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> fileDigest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">XXH</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">h64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileContents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">buffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">props</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">bond</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">trigger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileDigest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">setState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">digest</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> fileDigest </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  fileReader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readAsArrayBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then to convey the current ownership status of a file, we create a fully custom <code>DigestTag</code> component which will show who owns a file (if anyone) and when they claimed it. Here is what that looks like:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports maybe-class-name">React</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"react"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">ReactiveComponent</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"oo7-react"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> </span><span class="token imports maybe-class-name">Label</span><span class="token imports"> </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"semantic-ui-react"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">import</span><span class="token plain"> </span><span class="token imports punctuation" style="color:#393A34">{</span><span class="token imports"> ss58Encode </span><span class="token imports punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword module" style="color:#00009f">from</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"oo7-substrate"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword module" style="color:#00009f">export</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">DigestTag</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">extends</span><span class="token plain"> </span><span class="token class-name">ReactiveComponent</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">constructor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"value"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"account"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token function" style="color:#d73a49">readyRender</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">// Check if time is 0, which implies not claimed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">number</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">Label</span><span class="token plain"> basic color</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"green"</span><span class="token plain"> pointing</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"left"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token maybe-class-name">Unclaimed</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> owner </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ss58Encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ss58Encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">this</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">account</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> owner</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">Label</span><span class="token plain"> basic color</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"green"</span><span class="token plain"> pointing</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"left"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token literal-property property" style="color:#36acaa">Owner</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token maybe-class-name">You</span><span class="token operator" style="color:#393A34">!</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">emsp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">emsp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token maybe-class-name">When</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toLocaleDateString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token maybe-class-name">Label</span><span class="token plain"> basic color</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"red"</span><span class="token plain"> pointing</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">"left"</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token literal-property property" style="color:#36acaa">Owner</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">owner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">substring</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"…"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">emsp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">emsp</span><span class="token punctuation" style="color:#393A34">;</span><span class="token maybe-class-name">When</span><span class="token operator" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">" "</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toLocaleDateString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">span</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token operator" style="color:#393A34">/</span><span class="token maybe-class-name">Label</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If we put everything together, and run it, we will get something like this:</p>
<p><img loading="lazy" alt="GIF of using the Proof of Existence UI" src="https://shawntabrizi.com/assets/images/poe-example-3b2b31a4563e95431c752ecbc789a98d.gif" width="600" height="400" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="final-thoughts-and-next-steps">Final Thoughts and Next Steps<a href="https://shawntabrizi.com/blog/substrate/proof-of-existence-blockchain-with-substrate/#final-thoughts-and-next-steps" class="hash-link" aria-label="Direct link to Final Thoughts and Next Steps" title="Direct link to Final Thoughts and Next Steps">​</a></h2>
<p>You can see that with relatively little effort, the Substrate framework allows you to build custom blockchains. Substrate itself provides you with all the infrastructure required to set up a node. The Substrate Runtime Module Library (SRML) gives you a package of pre-built tools and features that you can easily add to your blockchain. The <code>substrate-node-template</code> can help you immediately get started with development, and the <code>substrate-ui</code> can enable you or other users to quickly interact with your chain.</p>
<p>Obviously I have picked a very simple project to implement here, but this process has itself been very eye opening to the power of the platform, and has allowed me to become more familiar with these cutting edge tools. But we are not done here. As someone tinkering around, I feel pretty satisfied with my local setup, but this is a platform built to for production ready, scalable blockchains.</p>
<p>The next steps for me will be to investigate:</p>
<ul>
<li>UI for revoking a claim</li>
<li>Token distribution patterns (maybe a timed faucet?)</li>
<li>Setting up bootnodes on a cloud provider</li>
<li>Creating/distributing binaries for others to run a node</li>
<li>???</li>
</ul>
<p>As I tackle these different problems, I will make additional posts to keep you updated with what I learn along the way. You can always follow this project right on my GitHub: <a href="https://github.com/shawntabrizi/substrate-proof-of-existence" target="_blank" rel="noopener noreferrer">https://github.com/shawntabrizi/substrate-proof-of-existence</a>. If you enjoy this content, or are looking forward to reading more about Substrate and blockchain development, feel free to check out my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>. Thanks!</p>]]></content:encoded>
            <category>blockchain</category>
            <category>programming</category>
            <category>runtime</category>
            <category>substrate</category>
        </item>
        <item>
            <title><![CDATA[Verify Ethereum Contracts Using Web3.js and Solc]]></title>
            <link>https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/</link>
            <guid>https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/</guid>
            <pubDate>Fri, 30 Nov 2018 18:20:58 GMT</pubDate>
            <description><![CDATA[This tutorial will show you how you can verify the source code of an Ethereum contract using Web3.js and Solc-JS, similar to Etherscan.io.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="this-tutorial-will-show-you-how-you-can-verify-the-source-code-of-an-ethereum-contract-using-web3js-and-solc-js-similar-to-etherscanio">This tutorial will show you how you can verify the source code of an Ethereum contract using Web3.js and Solc-JS, similar to Etherscan.io.<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#this-tutorial-will-show-you-how-you-can-verify-the-source-code-of-an-ethereum-contract-using-web3js-and-solc-js-similar-to-etherscanio" class="hash-link" aria-label="Direct link to This tutorial will show you how you can verify the source code of an Ethereum contract using Web3.js and Solc-JS, similar to Etherscan.io." title="Direct link to This tutorial will show you how you can verify the source code of an Ethereum contract using Web3.js and Solc-JS, similar to Etherscan.io.">​</a></h5>
<p>Recently I have been looking into the process of contract verification for Solidity contracts deployed to the Ethereum network. Many of you might be familiar with this <a href="https://etherscan.io/verifyContract2" target="_blank" rel="noopener noreferrer">process on Etherscan.io</a> where users can submit the source code to their contracts in order to <a href="https://etherscan.io/contractsVerified" target="_blank" rel="noopener noreferrer">get a "verified contract" status</a> on the site.</p>
<p>At first I thought this process would be pretty trivial since the bytecode for any contract is publicly available through the Web3 APIs, and the Solc compiler is pretty straightforward to use. However, if you try and do the naive approach, you will not get results that match! There are some small details about contract verification that are not really well documented today, and I hope to address that in this post, teaching you what I learned looking into these issues myself.</p>
<p>Before I dive in, I want to give a big shout out to the ConsenSys Diligence project <a href="https://github.com/ConsenSys/bytecode-verifier" target="_blank" rel="noopener noreferrer">bytecode-verifier</a>, whose source code ultimately helped me unblock some of the problems I was running into. Unfortunately this project is a bit out of date and won't work with the latest Solidity contracts, but we will address those problems here. (As of this writing, they support up to v0.4.21) I have written my own minimal version of the same fundamental program <a href="https://github.com/shawntabrizi/ethereum-bytecode-verifier-console" target="_blank" rel="noopener noreferrer">here</a> with the updates I mention in this post.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-right-solidity-compiler-version">Using the Right Solidity Compiler Version<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#using-the-right-solidity-compiler-version" class="hash-link" aria-label="Direct link to Using the Right Solidity Compiler Version" title="Direct link to Using the Right Solidity Compiler Version">​</a></h2>
<p>The first issue I ran into while trying to automate the contract verification process was the problem of using the right Solc version for a given contract. As you may know, the Solidity compiler and even the Solidity programming language is constantly getting updated through <a href="https://github.com/ethereum/solidity/releases" target="_blank" rel="noopener noreferrer">new releases of the software</a>. Depending on which compiler version you use, the resulting bytecode of your contract may change. If you are trying to verify an Ethereum contract, it is important that you have knowledge of which version you need to use to get the correct results. Unfortunately, the common practice for solidity developers is to include a carrot (<code>^</code>) in their <code>pragma solidity</code> statement (e.g. <code>pragma solidity ^0.4.16</code>). This allows the same source code to be compiled with Solidity compilers greater than 0.4.16 without throwing an error. This means to get the right results, you will need to know what compiler version was used to actually generate the bytecode, and not rely completely on the source code.</p>
<p>Another issue is that there is no backwards compatibility in the Solidity compiler. This can be quite annoying if you are trying to automate this process since you will need to have multiple Solc binaries downloaded and managed on your computer. Fortunately Solc-JS can come to the rescue here.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="using-a-legacy-version-of-solidity-with-solc-js">Using a Legacy Version of Solidity with Solc-JS<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#using-a-legacy-version-of-solidity-with-solc-js" class="hash-link" aria-label="Direct link to Using a Legacy Version of Solidity with Solc-JS" title="Direct link to Using a Legacy Version of Solidity with Solc-JS">​</a></h3>
<p>Solc-JS is a set of JavaScript bindings for the Solidity compiler. Built into the library is a version manager <a href="https://github.com/ethereum/solc-js#using-a-legacy-version" target="_blank" rel="noopener noreferrer">briefly documented here</a>:</p>
<blockquote>
<p>In order to compile contracts using a specific version of Solidity, the <code>solc.loadRemoteVersion(version, callback)</code> method is available. This returns a new solc object that uses a version of the compiler specified.</p>
</blockquote>
<p>Here is a minimal example of how this function could be used:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> solc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">'solc'</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> solc_version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v0.4.16+commit.d7661dd9"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">solc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">loadRemoteVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solc_version</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> solc_specific</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> solc_specific</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"contract t { function g() {} }"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In the background, the Solc-JS bindings manages loading and using the right Solidity compiler, and simply gives you the binary output you would expect! You can find all the builds of solidity <a href="https://ethereum.github.io/solc-bin/bin/list.json" target="_blank" rel="noopener noreferrer">here</a> and simply replace the <code>solc_version</code> variable with what you need.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="compiling-a-contract-with-multiple-solidity-files">Compiling a Contract with Multiple Solidity Files<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#compiling-a-contract-with-multiple-solidity-files" class="hash-link" aria-label="Direct link to Compiling a Contract with Multiple Solidity Files" title="Direct link to Compiling a Contract with Multiple Solidity Files">​</a></h2>
<p>The next thing we may commonly encounter when trying to do contract verification is handling projects which separate their code into multiple distinct files, and connects them using an <code>import</code> statement. Fortunately, the Solc-JS library also handles this. Note that when a contract does an <code>import</code> to another solidity file, it is really just concatenating the files, so if this part gives you trouble, or you want to simplify your process a bit, you can just merge all the different solidity files into a single file with multiple contracts. This is how the source code is shown on Etherscan.io.</p>
<p>If you do want to compile Solidity contracts broken up into multiple files, this code snippet should work for you assuming all the files are in the same directory:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> solc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"solc"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"fs"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> solc_version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v0.4.16+commit.d7661dd9"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contracts_directory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"./contracts"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contract_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"MyContract"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contract_filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"MyContract.sol"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> is_optimized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readdirSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contracts_directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">".sol"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> file_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> contracts_directory </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readFileSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"utf8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">solc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">loadRemoteVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solc_version</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> solc_specific</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      solc_specific</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lowlevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compileMulti</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> input </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is_optimized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> bytecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      output</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"contracts"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">contract_filename </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> contract_name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"runtimeBytecode"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You will note that we had to also specify the name of the final contract we want to compile and the name of the file which contains that contract code. There are probably ways to simplify this in your automation, but for the sake of making things general and easy to understand, all of these variables are defined upfront.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="getting-the-bytecode-of-an-existing-ethereum-contract">Getting the Bytecode of an Existing Ethereum Contract<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#getting-the-bytecode-of-an-existing-ethereum-contract" class="hash-link" aria-label="Direct link to Getting the Bytecode of an Existing Ethereum Contract" title="Direct link to Getting the Bytecode of an Existing Ethereum Contract">​</a></h2>
<p>So now that we know how to generate the bytecode from the smartcontract's source, we need to be able to retrieve the existing bytecode which is on the blockchain to compare it to. Web3.js provides a function called <a href="https://web3js.readthedocs.io/en/1.0/web3-eth.html#getcode" target="_blank" rel="noopener noreferrer"><code>getCode()</code></a> which returns the bytecode of a contract at a specific address. It looks like this:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"0xd5677cf67b5aa051bb40496e68ad359eb97cfbf8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x600160008035811a818181146012578301005b601b6001356025565b8060005260206000f25b600060078202905091905056"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Dead simple.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-naive-approach-does-not-work">The Naive Approach Does Not Work<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#the-naive-approach-does-not-work" class="hash-link" aria-label="Direct link to The Naive Approach Does Not Work" title="Direct link to The Naive Approach Does Not Work">​</a></h2>
<p>So what would happen if we use these two new skills and tried to verify a known Ethereum contract? For no particular reason, we will try and verify the source code for the ChainLink Token (LINK).</p>
<p>If you copy the code and compiler settings of the <code>LinkToken</code> contract <a href="https://etherscan.io/address/0x514910771af9ca656af840dff83e8264ecf986ca#code" target="_blank" rel="noopener noreferrer">from Etherscan</a> and use Solc-JS to compile it. You should get the following bytecode:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">606060405236156100b75763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166306fdde0381146100bc578063095ea7b31461014757806318160ddd1461017d57806323b872dd146101a2578063313ce567146101de5780634000aea014610207578063661884631461028057806370a08231146102b657806395d89b41146102e7578063a9059cbb14610372578063d73dd623146103a8578063dd62ed3e146103de575b600080fd5b34156100c757600080fd5b6100cf610415565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561010c5780820151818401525b6020016100f3565b50505050905090810190601f1680156101395780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561015257600080fd5b610169600160a060020a036004351660243561044c565b604051901515815260200160405180910390f35b341561018857600080fd5b610190610499565b60405190815260200160405180910390f35b34156101ad57600080fd5b610169600160a060020a03600435811690602435166044356104a9565b604051901515815260200160405180910390f35b34156101e957600080fd5b6101f16104f8565b60405160ff909116815260200160405180910390f35b341561021257600080fd5b61016960048035600160a060020a03169060248035919060649060443590810190830135806020601f820181900481020160405190810160405281815292919060208401838380828437509496506104fd95505050505050565b604051901515815260200160405180910390f35b341561028b57600080fd5b610169600160a060020a036004351660243561054c565b604051901515815260200160405180910390f35b34156102c157600080fd5b610190600160a060020a0360043516610648565b60405190815260200160405180910390f35b34156102f257600080fd5b6100cf610667565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561010c5780820151818401525b6020016100f3565b50505050905090810190601f1680156101395780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561037d57600080fd5b610169600160a060020a036004351660243561069e565b604051901515815260200160405180910390f35b34156103b357600080fd5b610169600160a060020a03600435166024356106eb565b604051901515815260200160405180910390f35b34156103e957600080fd5b610190600160a060020a0360043581169060243516610790565b60405190815260200160405180910390f35b60408051908101604052600f81527f436861696e4c696e6b20546f6b656e0000000000000000000000000000000000602082015281565b600082600160a060020a03811615801590610479575030600160a060020a031681600160a060020a031614155b151561048457600080fd5b61048e84846107bd565b91505b5b5092915050565b6b033b2e3c9fd0803ce800000081565b600082600160a060020a038116158015906104d6575030600160a060020a031681600160a060020a031614155b15156104e157600080fd5b6104ec85858561082a565b91505b5b509392505050565b601281565b600083600160a060020a0381161580159061052a575030600160a060020a031681600160a060020a031614155b151561053557600080fd5b6104ec85858561093c565b91505b5b509392505050565b600160a060020a033381166000908152600260209081526040808320938616835292905290812054808311156105a957600160a060020a0333811660009081526002602090815260408083209388168352929052908120556105e0565b6105b9818463ffffffff610a2316565b600160a060020a033381166000908152600260209081526040808320938916835292905220555b600160a060020a0333811660008181526002602090815260408083209489168084529490915290819020547f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925915190815260200160405180910390a3600191505b5092915050565b600160a060020a0381166000908152600160205260409020545b919050565b60408051908101604052600481527f4c494e4b00000000000000000000000000000000000000000000000000000000602082015281565b600082600160a060020a038116158015906106cb575030600160a060020a031681600160a060020a031614155b15156106d657600080fd5b61048e8484610a3a565b91505b5b5092915050565b600160a060020a033381166000908152600260209081526040808320938616835292905290812054610723908363ffffffff610afa16565b600160a060020a0333811660008181526002602090815260408083209489168084529490915290819020849055919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591905190815260200160405180910390a35060015b92915050565b600160a060020a038083166000908152600260209081526040808320938516835292905220545b92915050565b600160a060020a03338116600081815260026020908152604080832094871680845294909152808220859055909291907f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259085905190815260200160405180910390a35060015b92915050565b600160a060020a03808416600081815260026020908152604080832033909516835293815283822054928252600190529182205461086e908463ffffffff610a2316565b600160a060020a0380871660009081526001602052604080822093909355908616815220546108a3908463ffffffff610afa16565b600160a060020a0385166000908152600160205260409020556108cc818463ffffffff610a2316565b600160a060020a03808716600081815260026020908152604080832033861684529091529081902093909355908616917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9086905190815260200160405180910390a3600191505b509392505050565b60006109488484610a3a565b5083600160a060020a031633600160a060020a03167fe19260aff97b920c7df27010903aeb9c8d2be5d310a2c67824cf3f15396e4c16858560405182815260406020820181815290820183818151815260200191508051906020019080838360005b838110156109c35780820151818401525b6020016109aa565b50505050905090810190601f1680156109f05780820380516001836020036101000a031916815260200191505b50935050505060405180910390a3610a0784610b14565b15610a1757610a17848484610b23565b5b5060015b9392505050565b600082821115610a2f57fe5b508082035b92915050565b600160a060020a033316600090815260016020526040812054610a63908363ffffffff610a2316565b600160a060020a033381166000908152600160205260408082209390935590851681522054610a98908363ffffffff610afa16565b600160a060020a0380851660008181526001602052604090819020939093559133909116907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9085905190815260200160405180910390a35060015b92915050565b600082820183811015610b0957fe5b8091505b5092915050565b6000813b908111905b50919050565b82600160a060020a03811663a4c0ed363385856040518463ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018084600160a060020a0316600160a060020a0316815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610bbd5780820151818401525b602001610ba4565b50505050905090810190601f168015610bea5780820380516001836020036101000a031916815260200191505b50945050505050600060405180830381600087803b1515610c0a57600080fd5b6102c65a03f11515610c1b57600080fd5b5050505b505050505600a165627a7a72305820c3685b0297ec9fe5313ede11d56d6f42a2fc15071d0a3ef0e337bc6e3d3877380029</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>However if we get the bytecode from Ethereum, it is different!</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"0x514910771AF9Ca656af840dff83E8264EcF986CA"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">then</span><span class="token punctuation" style="color:#393A34">(</span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">log</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0x606060405236156100b75763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166306fdde0381146100bc578063095ea7b31461014757806318160ddd1461017d57806323b872dd146101a2578063313ce567146101de5780634000aea014610207578063661884631461028057806370a08231146102b657806395d89b41146102e7578063a9059cbb14610372578063d73dd623146103a8578063dd62ed3e146103de575b600080fd5b34156100c757600080fd5b6100cf610415565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561010c5780820151818401525b6020016100f3565b50505050905090810190601f1680156101395780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561015257600080fd5b610169600160a060020a036004351660243561044c565b604051901515815260200160405180910390f35b341561018857600080fd5b610190610499565b60405190815260200160405180910390f35b34156101ad57600080fd5b610169600160a060020a03600435811690602435166044356104a9565b604051901515815260200160405180910390f35b34156101e957600080fd5b6101f16104f8565b60405160ff909116815260200160405180910390f35b341561021257600080fd5b61016960048035600160a060020a03169060248035919060649060443590810190830135806020601f820181900481020160405190810160405281815292919060208401838380828437509496506104fd95505050505050565b604051901515815260200160405180910390f35b341561028b57600080fd5b610169600160a060020a036004351660243561054c565b604051901515815260200160405180910390f35b34156102c157600080fd5b610190600160a060020a0360043516610648565b60405190815260200160405180910390f35b34156102f257600080fd5b6100cf610667565b60405160208082528190810183818151815260200191508051906020019080838360005b8381101561010c5780820151818401525b6020016100f3565b50505050905090810190601f1680156101395780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b341561037d57600080fd5b610169600160a060020a036004351660243561069e565b604051901515815260200160405180910390f35b34156103b357600080fd5b610169600160a060020a03600435166024356106eb565b604051901515815260200160405180910390f35b34156103e957600080fd5b610190600160a060020a0360043581169060243516610790565b60405190815260200160405180910390f35b60408051908101604052600f81527f436861696e4c696e6b20546f6b656e0000000000000000000000000000000000602082015281565b600082600160a060020a03811615801590610479575030600160a060020a031681600160a060020a031614155b151561048457600080fd5b61048e84846107bd565b91505b5b5092915050565b6b033b2e3c9fd0803ce800000081565b600082600160a060020a038116158015906104d6575030600160a060020a031681600160a060020a031614155b15156104e157600080fd5b6104ec85858561082a565b91505b5b509392505050565b601281565b600083600160a060020a0381161580159061052a575030600160a060020a031681600160a060020a031614155b151561053557600080fd5b6104ec85858561093c565b91505b5b509392505050565b600160a060020a033381166000908152600260209081526040808320938616835292905290812054808311156105a957600160a060020a0333811660009081526002602090815260408083209388168352929052908120556105e0565b6105b9818463ffffffff610a2316565b600160a060020a033381166000908152600260209081526040808320938916835292905220555b600160a060020a0333811660008181526002602090815260408083209489168084529490915290819020547f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925915190815260200160405180910390a3600191505b5092915050565b600160a060020a0381166000908152600160205260409020545b919050565b60408051908101604052600481527f4c494e4b00000000000000000000000000000000000000000000000000000000602082015281565b600082600160a060020a038116158015906106cb575030600160a060020a031681600160a060020a031614155b15156106d657600080fd5b61048e8484610a3a565b91505b5b5092915050565b600160a060020a033381166000908152600260209081526040808320938616835292905290812054610723908363ffffffff610afa16565b600160a060020a0333811660008181526002602090815260408083209489168084529490915290819020849055919290917f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92591905190815260200160405180910390a35060015b92915050565b600160a060020a038083166000908152600260209081526040808320938516835292905220545b92915050565b600160a060020a03338116600081815260026020908152604080832094871680845294909152808220859055909291907f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259085905190815260200160405180910390a35060015b92915050565b600160a060020a03808416600081815260026020908152604080832033909516835293815283822054928252600190529182205461086e908463ffffffff610a2316565b600160a060020a0380871660009081526001602052604080822093909355908616815220546108a3908463ffffffff610afa16565b600160a060020a0385166000908152600160205260409020556108cc818463ffffffff610a2316565b600160a060020a03808716600081815260026020908152604080832033861684529091529081902093909355908616917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9086905190815260200160405180910390a3600191505b509392505050565b60006109488484610a3a565b5083600160a060020a031633600160a060020a03167fe19260aff97b920c7df27010903aeb9c8d2be5d310a2c67824cf3f15396e4c16858560405182815260406020820181815290820183818151815260200191508051906020019080838360005b838110156109c35780820151818401525b6020016109aa565b50505050905090810190601f1680156109f05780820380516001836020036101000a031916815260200191505b50935050505060405180910390a3610a0784610b14565b15610a1757610a17848484610b23565b5b5060015b9392505050565b600082821115610a2f57fe5b508082035b92915050565b600160a060020a033316600090815260016020526040812054610a63908363ffffffff610a2316565b600160a060020a033381166000908152600160205260408082209390935590851681522054610a98908363ffffffff610afa16565b600160a060020a0380851660008181526001602052604090819020939093559133909116907fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9085905190815260200160405180910390a35060015b92915050565b600082820183811015610b0957fe5b8091505b5092915050565b6000813b908111905b50919050565b82600160a060020a03811663a4c0ed363385856040518463ffffffff167c01000000000000000000000000000000000000000000000000000000000281526004018084600160a060020a0316600160a060020a0316815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610bbd5780820151818401525b602001610ba4565b50505050905090810190601f168015610bea5780820380516001836020036101000a031916815260200191505b50945050505050600060405180830381600087803b1515610c0a57600080fd5b6102c65a03f11515610c1b57600080fd5b5050505b505050505600a165627a7a72305820c5f438ff94e5ddaf2058efa0019e246c636c37a622e04bb67827c7374acad8d60029</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Ignoring the <code>0x</code> at the front, we can still find that the end of each bytecode is different: <code>...37bc6e3d3877380029</code> vs <code>...27c7374acad8d60029</code>.</p>
<p>So what's going on?</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="contract-metadata">Contract Metadata<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#contract-metadata" class="hash-link" aria-label="Direct link to Contract Metadata" title="Direct link to Contract Metadata">​</a></h2>
<p>What you are seeing here are some of the artifacts of the <a href="https://solidity.readthedocs.io/en/v0.4.24/metadata.html" target="_blank" rel="noopener noreferrer">contract metadata</a> which gets generated by the solidity compiler. At the end of the bytecode, the Solidity compiler appends a Swarm hash of the metadata file that gets generated at compile time. This section always starts with with <code>a165627a7a72305820</code> which is <a href="https://solidity.readthedocs.io/en/v0.4.24/metadata.html#encoding-of-the-metadata-hash-in-the-bytecode" target="_blank" rel="noopener noreferrer">translated from <code>0xa1 0x65 'b' 'z' 'z' 'r' '0' 0x58 0x20</code></a>.</p>
<p>So ultimately we don't want to directly compare the two resulting bytecodes, but the specific parts of the bytecode which represent the smart contract's logic. Fortunately, just like this Swarm hash which is appended at the end of the contract, there is also a common substring in the bytecode which indicates the beginning of the contract: <code>6060604052</code>. This bytecode translates to the assembly code which initializes the <a href="https://solidity.readthedocs.io/en/v0.4.24/assembly.html#conventions-in-solidity" target="_blank" rel="noopener noreferrer">"free memory pointer"</a>:</p>
<p>PUSH1 0x60 PUSH1 0x40 MSTORE</p>
<p>So now, if we only compare the bytecode starting with <code>6060604052...</code> and ending with <code>...a165627a7a72305820</code> we will actually find that these two bytecodes match!</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="handling-changes-to-metadata-from-different-solidity-versions">Handling Changes to Metadata from Different Solidity Versions<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#handling-changes-to-metadata-from-different-solidity-versions" class="hash-link" aria-label="Direct link to Handling Changes to Metadata from Different Solidity Versions" title="Direct link to Handling Changes to Metadata from Different Solidity Versions">​</a></h2>
<p>Unfortunately this is not the end of the story. As the Solidity compiler has changed, so has some of the rules around the contract metadata. For example, before Solidity v0.4.7, there was no metadata! So if we tried to do the naive approach on a very old contract, it would have worked!</p>
<p>Also, after Solidity v0.4.22, the free memory pointer initialization changes from <code>6060604052...</code> to <code>6080604052...</code>. I am not sure <a href="https://ethereum.stackexchange.com/questions/63117/when-did-the-ethereum-free-memory-pointer-change-6060-6080" target="_blank" rel="noopener noreferrer">why this changed</a>, but it means we will need to add a few conditionals to our general source code verification program.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="generally-working-verification-code">Generally Working Verification Code<a href="https://shawntabrizi.com/blog/ethereum/verify-ethereum-contracts-using-web3-js-and-solc/#generally-working-verification-code" class="hash-link" aria-label="Direct link to Generally Working Verification Code" title="Direct link to Generally Working Verification Code">​</a></h2>
<p>So now that we know how to get the results we want, we can write some code to automate this process. Here is a minimal working example:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> solc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"solc"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> fs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"fs"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token maybe-class-name">Web3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"web3"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> web3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Web3</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token class-name">Web3</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">providers</span><span class="token class-name punctuation" style="color:#393A34">.</span><span class="token class-name">HttpProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"https://mainnet.infura.io"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> solc_version </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"v0.4.16+commit.d7661dd9"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contracts_directory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"./contracts"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contract_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LinkToken"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contract_filename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"LinkToken.sol"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> is_optimized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> contract_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"0x514910771AF9Ca656af840dff83E8264EcF986CA"</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> input </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> files </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readdirSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contracts_directory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> item </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> files</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">file</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">".sol"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> file_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> contracts_directory </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> item</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">item</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">readFileSync</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">file_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"utf8"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">solc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">loadRemoteVersion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solc_version</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">err</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> solc_specific</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      solc_specific</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">lowlevel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">compileMulti</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">stringify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token literal-property property" style="color:#36acaa">sources</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> input </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is_optimized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> compiled_bytecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token string" style="color:#e3116c">"0x"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      output</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"contracts"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">contract_filename </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">":"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> contract_name</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">"runtimeBytecode"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> blockchain_bytecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> web3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">eth</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">contract_address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processed_compiled_bytecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processBytecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">compiled_bytecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    processed_blockchain_bytecode </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processBytecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockchain_bytecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">processed_blockchain_bytecode </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> processed_compiled_bytecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Verified!"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token console class-name">console</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Not Verified"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processBytecode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">bytecode</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Semantic versioning</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> solc_minor </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    solc_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">v</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">[</span><span class="token regex regex-source language-regex char-class" style="color:#36acaa">+-</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">]</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">gi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> solc_patch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseInt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    solc_version</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex" style="color:#36acaa">v</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+?</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">[</span><span class="token regex regex-source language-regex char-class" style="color:#36acaa">+-</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#393A34">]</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">gi</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">match</span><span class="token punctuation" style="color:#393A34">(</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-source language-regex special-escape escape" style="color:#36acaa">\.</span><span class="token regex regex-source language-regex char-set class-name" style="color:#36acaa">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#36acaa">+</span><span class="token regex regex-delimiter" style="color:#36acaa">/</span><span class="token regex regex-flags" style="color:#36acaa">g</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solc_minor </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> solc_patch </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">22</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> starting_point </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">lastIndexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"6080604052"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ending_point </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a165627a7a72305820"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">starting_point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ending_point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">solc_minor </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> solc_patch </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> starting_point </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">lastIndexOf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"6060604052"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> ending_point </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">search</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"a165627a7a72305820"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">slice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">starting_point</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ending_point</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> bytecode</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>And the result?</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">C:\Temp\solc\node_project&gt;node index.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Verified!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As I mentioned before, the main source which unblocked me trying to do this process was the <a href="https://github.com/ConsenSys/bytecode-verifier" target="_blank" rel="noopener noreferrer">ConsenSys/bytecode-verifier</a> project. However, their code is a bit out of date, and also contains some non-essential parts. I attempted to simply the code in my own version of the blockchain verifier: <a href="https://github.com/shawntabrizi/ethereum-bytecode-verifier-console" target="_blank" rel="noopener noreferrer">shawntabrizi/ethereum-bytecode-verifier-console</a>.</p>
<p>This code has not been battle tested, but I plan on iterating on it and using it for a larger project I am working on. Feel free to grab it and modify it as you need!</p>
<p>I hope that this post has taught you something new and possibly helped you answer similar questions that I had! If you enjoyed this content, feel free to check out my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>.</p>]]></content:encoded>
            <category>bytecode</category>
            <category>etherscan</category>
            <category>javascript</category>
            <category>solidity</category>
            <category>verification</category>
            <category>web3</category>
        </item>
        <item>
            <title><![CDATA[Combining Rocket with Reqwest to Call an API with Rust]]></title>
            <link>https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/</link>
            <guid>https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/</guid>
            <pubDate>Mon, 22 Oct 2018 03:28:05 GMT</pubDate>
            <description><![CDATA[This post will be a short code snippet to show how you can combine the Dynamic Segments example from Rocket and the Calling a Web API example from the Rust Cookbook.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="this-post-will-be-a-short-code-snippet-to-show-how-you-can-combine-the-dynamic-segments-example-from-rocket-and-the-calling-a-web-api-example-from-the-rust-cookbook">This post will be a short code snippet to show how you can combine the <a href="https://rocket.rs/guide/requests/#dynamic-segments" target="_blank" rel="noopener noreferrer"><em>Dynamic Segments</em> example from Rocket</a> and the <a href="https://rust-lang-nursery.github.io/rust-cookbook/web/clients/apis.html" target="_blank" rel="noopener noreferrer"><em>Calling a Web API</em> example from the Rust Cookbook</a>.<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#this-post-will-be-a-short-code-snippet-to-show-how-you-can-combine-the-dynamic-segments-example-from-rocket-and-the-calling-a-web-api-example-from-the-rust-cookbook" class="hash-link" aria-label="Direct link to this-post-will-be-a-short-code-snippet-to-show-how-you-can-combine-the-dynamic-segments-example-from-rocket-and-the-calling-a-web-api-example-from-the-rust-cookbook" title="Direct link to this-post-will-be-a-short-code-snippet-to-show-how-you-can-combine-the-dynamic-segments-example-from-rocket-and-the-calling-a-web-api-example-from-the-rust-cookbook">​</a></h5>
<p>I wanted to start playing around with Rust, so I was given a project to build a web application which would interact with downstream apis and present a simple user interface. Unfortunately, it seems that some of these common use cases are not easily documented for new users like me!</p>
<p>Let’s fix that 🙂</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="creating-a-simple-webpage-in-rust">Creating a simple webpage in Rust<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#creating-a-simple-webpage-in-rust" class="hash-link" aria-label="Direct link to Creating a simple webpage in Rust" title="Direct link to Creating a simple webpage in Rust">​</a></h2>
<p>We will create a simple webpage which will call a downstream API, and return a result on the page. We will be using Rocket as our web framework and Reqwest as our HTTP client since Rocket only provides an HTTP server.</p>
<p>Our example will follow exactly the basic examples from these two sources, but combine them to work together in an easy to understand way.</p>
<p>The Rocket tutorial shows you how you can set up dynamic segments to be able to allow your program to accept a path segment as a variable in your function. In the tutorial we use this to be able to say “Hello, NAME”. The Reqwest tutorial shows you how you can check if a certain user exists on GitHub by querying their GitHub Users Endpoint using a HEAD request.</p>
<p>So let’s combine this to create a site where you can navigate to <code>/check/&lt;username&gt;</code> and it will tell you if the user exists on GitHub or not!</p>
<p>I won’t be diving into the code line by line, since you can read from the tutorials what the different pieces do, but I do want to give you a working code snippet which does just what I said:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cargotoml">Cargo.toml<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#cargotoml" class="hash-link" aria-label="Direct link to Cargo.toml" title="Direct link to Cargo.toml">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">…</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[dependencies]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rocket = “0.3.17”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rocket_codegen = “0.3.17”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reqwest = “0.9.3”</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="srcmainrs">src/main.rs<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#srcmainrs" class="hash-link" aria-label="Direct link to src/main.rs" title="Direct link to src/main.rs">​</a></h3>
<div class="language-rust codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-rust codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token attribute attr-name" style="color:#00a4db">#![feature(plugin)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#![plugin(rocket_codegen)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">crate</span><span class="token plain"> </span><span class="token module-declaration namespace" style="opacity:0.7">reqwest</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">extern</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">crate</span><span class="token plain"> </span><span class="token module-declaration namespace" style="opacity:0.7">rocket</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">rocket</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">http</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">RawStr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">time</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">use</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">reqwest</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">ClientBuilder</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[get(</span><span class="token attribute attr-name string" style="color:#e3116c">"/"</span><span class="token attribute attr-name" style="color:#00a4db">)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">index</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token lifetime-annotation symbol" style="color:#36acaa">'static</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">str</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">"Navigate to http://localhost:8000/check/&lt;type your GitHub name here&gt; to check that everything is working!"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token attribute attr-name" style="color:#00a4db">#[get(</span><span class="token attribute attr-name string" style="color:#e3116c">"/check/&lt;user&gt;"</span><span class="token attribute attr-name" style="color:#00a4db">)]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token class-name">RawStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-&gt;</span><span class="token plain"> </span><span class="token class-name">Result</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token class-name">String</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token class-name">Box</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token namespace" style="opacity:0.7">std</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token namespace" style="opacity:0.7">error</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token class-name">Error</span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> request_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">format!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"https://api.github.com/users/{}"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">Duration</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> client </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">ClientBuilder</span><span class="token punctuation" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">timeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">build</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">let</span><span class="token plain"> response </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">head</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">request_url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">?</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">is_success</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token macro property" style="color:#36acaa">format!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} is a user!"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token class-name">Ok</span><span class="token punctuation" style="color:#393A34">(</span><span class="token macro property" style="color:#36acaa">format!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"{} is not a user!"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fn</span><span class="token plain"> </span><span class="token function-definition function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token namespace" style="opacity:0.7">rocket</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">::</span><span class="token function" style="color:#d73a49">ignite</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"/"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token macro property" style="color:#36acaa">routes!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> check</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">launch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing-your-webpage">Testing your webpage<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#testing-your-webpage" class="hash-link" aria-label="Direct link to Testing your webpage" title="Direct link to Testing your webpage">​</a></h2>
<p>After you have copied these items into your project, you can simply run <code>cargo run</code> to spin up your local web server.</p>
<p><img loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAh4AAAHTCAIAAADnP4bqAAAfOUlEQVR4nO3dQWwc970fcJ57aU8P71YDBXRq5VNRIKd3e4AT9mbfCPtSHqzY1oUO5EvrqA8IEPoJAQqlgBuv5AQNGDgHkqbkh/ciKpZDSSYd46EPz5QMwxL1YlUWKzoWSXN1EHsYcnZ2d2Z2ZvdH7Yr8fPA7kLO7/52dnZnv/v8zOzv2vfc2jv3vb5VSSqmQ+t57G2Pfe2/jmX/3V0++fvCf/8u/+u+7So1s/cVf/vuhbBpKPe0lWpQqLNGiVH815GhpNh8pNbIlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoVVN1re/sXM27+YGcrWpNRIlWhRqrDqRssHf/fhB3/34VC2JqVGqkSLUoUlWpTqr0SLOrR1/vy7P//5/+yefvbszy9e/KBKC6JFHVyVr3tPck7W1r7q46byGuVomZ8YOz59Y5CdS9rC4E2119zE2NjY2NjY8embA01Jp0/MP/k976Gvs2d//txz33/rrbeyE6enp5977vvnz79bpQXRog6umsX5UXLTAVVuhPSdK8+IlsotlDc7PzE2Mdd5U88pSd2cPh4aeypTSZCk6ZL8Oz09XfHhokUdXDVHKVqe6QqSQXLlGdFSuYVM3Zg+fnz6RvNRs/lobmJsYq6t23Fj+vjx6ZuVpqSt6bIcZKXpUjdXmr2i5e1fzCRZUl7OGVO51RyxaHkmEycD5sozT0203Jg+PrZnYi69w810ajJxf8BpbH8n3h4tc3t3b9utdzabbXM+bW9sYr45NzG2lyhpP2OvI9IWFXMTYxPzVaYkf9+YPp55RepAKgmVurnSFC2Hscrf8Sc8J33cdNC1tvbV4LnyzFMSLfMT6a7/xvTxvYk3p493HbTIeWCrhb1gmJsYaw1MdTXbedgjE2+taGllUvLwAaIlHSVTB1hptHQcd+lZBsTUwVVTtBxQVY2WG9PHM/vfvTGo9ol71eq2dEdLOq7Vs9lsYlUaEOs/WuYmCtJRhVU6DtZx3KVKiRZ1cNUcvWg5YgNiFaOlNSU7YFUzWpqPms1HSZ9kYu5RbrTkhESfx1ocwD/w6ji+UjddRIs6uGqOWLQcwcP4HSNXaX60D4ilA1atQbPSaMlvdq/29/55A2KZkbG5ibHj0zczD+/OrdIpDuAfZCUnH3ccX3HysRqRao5StBzVk49bx9uzH/Nbh9kn5h61jsAfn5io0mvJbTZzJkCSNHsT2g7jP2o9Ls2G/Qe2jsn3muIA/kHX+fPvnj378+7pvjKpRqHK170nOSdH7SuTh7vmJ9KTAtSolstTKtVfiRalCstF9ZXqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr0SLUoUlWpTqr/ai5S/+8j88+fqP/+mvh77vUKqk/vW/+bdD2TSUetprL1qGvg0rpZQ6NCValFJKBZdoUY92dppKHc0a+tZ3WKt2tGxubq2t3VleXvnoo48WFxdnZ+dmZ+cWFxc/+uij5eWVtbU7m5tbQ39Vqmdlt67vvttR6mjWUYiZL7+89eSftEa03L+/fu3a9dnZuevXr9+6dfveva83NjYeP378+PHjjY2Ne/e+vnXr9vXr12dn565du37//vrQF6gqqmyibG9/p9RRrmzGDH3bPIga3Wj55ps/Ly+vLCxcuHXr9s5O83GpnZ3mrVu3FxYuLC+vfPPNn4e+WFVHJaHypz99tbR09dKlRaXU1avX7t69mwTM0LfQ8BrRaFlbu7OwcGF1dbVnqHQEzOrq6sLChbt37w59yaq00v7KlStXNjc3d4Hd3W+//XZpaemw9l1GMVpu3vx8YeFCOvBV18bGxsLChZs3Px/6wlVJJbmyvf3dpUuLw96cYYRcurSYDI6JlpAqi5abNz9fXLxcq7OS231ZXLwsXUakkmjZ2toWLZB16dLi1ta2aImqwmhJxsEGzJXE5uamkbERqZ2d5vb2d6IFOiTRsr39nWgJqfxo+eabPw8yDtYtGRlzVH+4lY6GbW5uiRbIunRpcXNz61COiY1QtCwvr6yurkblSmJ1dXV5eWXoS/kol2iBIqIltnKi5f799aihsKydnebCwoWj9n2XBw82Tpz44YkTP3zwYPiXPBAtHClnz549e/ZsxTsPGC0vv3zixIkfDn0bz61RiZarV6/dunWrZ1Q8fPjw1VdfffXVV6uny61bt65evdbHXF6+/PvLl3+/tbUd+MofPNh4991fnjjxw+ee+/5zz33/9dd/9Nvf/jYNgJAVJcmVpP1RSJc+omVra2t+fv706dOTk5OTk5OnT5+en5/f2trqf3PnyLtx48Ybb7wxWcEbb7xx48aN/p5laWkpaWRpaanK/QeMlmQzH+4GXlQjES2bm1uzs3M9uyxJrvzgBz945ZVXqkfLzk5zdnauj7m8fPn3c3Pzgeny4YdXXnjhhWRtyNYLL7zw4YdXmhErSporL7984uWXT4xCutSNlqWlpZMnTzYajbW1tWTK2tpao9F47bXXKm6u0O3UqVNVciVNlwGfpWILoxYtr7/+o449RveUilU9WpI9VUlV/8DdGS1ra3euX/+4eq48fPiwerQ8fvz4+vWP19bu1F00W1vbgely8eIHyWJ68803kyB58GDjww+vvP76j5Lpn3zyxwFXlGyuPHiw8eDBxiikS61oWVpaeu2119JQyVpbW5Mu9K16riT6eIqky3Lq1KkkYKqsqyMYLR17jO4pFSswWl5++UTFpjqjZXl5pXw0bJBcefz48a1bt/o7mB+VLg8ebCT9lYsXP+i+dXp6Oum7DLKidORKOnHo6VI9Wra2tk6ePJnNldOnT58+fTr9N0mXCiNjF18ce/Fiz826t7SdL888++yZLwNazHNn/sx/23Nm/k7mhuXG/vTGcvYBn/zyb37yk5/89Kc//dvf/GN2+mcL75w/f/5Xv/rVr//h8wOa16fXgUbL+vp6OuC2tLSUZEwysLa+vl7ywFGLlu49Rt/7kJEYELty5cq9e18fUK48fvz43r2vr1y50t+8hqTL+fPvJv2VojukfZf+VpTcXClaV55wVY+Wubm5mZmZ7JSOaNnd3W00GnNzc7229JGMloKZWm60kuPO/Jncv5cbrdC58/7P/uaXnyR//+Nv/vad332V/H3vyq/fWfgs+fvzf/j1+ytle7QjKM2MtbW15DNKNkiSvvLa2lqtaPn000/feuutkydPpo86depUclN2/O3kyZNvvfXWp59+2t3CqEVL7h6jv33ISETL4uJi0ddZtre3B8yVx48fb2xsLC4u9j27g6dL8sZ89tlq7vSO6mNVSI/b577xDx5sDPGofvVoOX36dO5QWNba2lpH2OR5iqLlzvyZTFel9d9yI9tVaeXM8vkfn/8knf7V37/zs/f+z+7u7u4/zb89/1k6/f7H7/9m8YvB5neIkh5A9nB6lSnlstGyu98DzuZKMrFWtKRnmrz22mvT09MzMzPZ2ZuZmZmenk6fJXe9rRstb775ZnYrzu4xkv1AyefXWruUwdNlJKJldnauKBVeeeWVH1RWcuZYyZH8JDYq1uXLv+/jBRdlRne0VB9VzG2kfAZqHRCLqurR0r09d/dacu/WJbsX//LMs2N72tIhMz2588UXu+7XES3pPbIRkd9+ZuqLF7uf7M78mf1+SH7vpD1xWv/fmf/Zz97/l9b0r373zjuLd3d3/+/vf/3rK/da0++vvP/+H/9fr+U0qroPhleZUi7bh8imSzZXsv2PKm1WOR+s/D51o6XjyEe61aefL19//Uchm22aJWmD3VPKayQO40dFS8mZY6MZLSGVngyWPkX6b/qWpLnVR3QNWINES+5GXidavjzzbCsIvjzz7P7ev2P6mYu7uxfPZAJl727t7ew/4OKL6Z8F7X955tl06sWLF9Nm00jKRMtu5mBLa1J7p6UVLcuNH59fyUzfj5Z/mn17/p8z05/uaEk/6afjS1WmlEt7GB3pkpsrFXrGe8qTo2f21I2Wjt5DOlZRNB7ed3VnVd30GonD+CUDYltbW0m6vPrqq4dvQCywstHSPbx2oNlWXoMMiHVHS70Bsewufne3Na6VCYeyhxcNiKX/FbWfCbGcVtvcmT/TfqwliZejHS03btxIzrPKji/1nFJuZmZmMiN7wkhHrkxOTnYc8yuX5kfH0ZRPP/20Z5+mj2Mt2XRJP0EeUK6kbfaRXiMxINbzMP6A6TL6h/EHr0MQLd2H8bujpd5h/Fb/I5GJlu5DJ9lBq4rRUtR+prVWmuRGS3Y4LPv/0R4QOwjr6+uT7ZJ06c6VycnJ8tO6uk1PT09OTnaE3I0bNyYnJ6enp0se2N9h/DRdsp/rRypXmiMSLVVOPh4kXb744ouhn3z8/PPPP1dw8vF77703eOp0B0nyRZnuW59w1Tr5uONLLYOefNzZOymOlrZ7Vu61FLWf225utGTPD9vdzURN12H8/cP7nYfx3/nd3d3dnMP4769Ilg4dHZcitbosiWS0LVl119fXk2RKTgoo72T3fYZYNl1GMFeaIxItFb8y2Xe6jNpXJtORsc8+W33zzTeT6X3MYbYOQa9lt9dXJk+ePFntK5PFx1oyh0vSEPjyzJmLmbDJPKZXtBS1f/HF/OfMOday3MgcYsmOjmVDJ3vy8cr5H+eefPzP8287+bin7BGXXNWPsmSlfZ1z584lf587dy7tJ5U8cJCTj5N0CcyV5v7QfbbN7ikVayQO41e/0EuaLtVzZXQu9HLx4gdJ36Wjnn/++eT7+YNU0lQSWh3R8tlnq09LtOzup8u5c+eyQ+Hnzp2r81X87F68deJXe0+lY3prOOzZM2eq9lqK2u86+yx7z44zxLLfjOzuweR9k/LOhf+x95XJ//X3X2Wm3/vDzN5XJmc/vl9tQR1FJX2XPvoru3lDbdWH10btysfdWdV3eo3EYfxmnctTvvLKK7WuITZql6c8f/7dbE/2/Pl3Qz505IZWtl566aXAF1K9+rs85dzcXPbylHNzcy5PSZT19fWZmZnsCjYzM1P3+EoqOaaSaDQayYBYo9FIJ5acaFA3WgI/4B90jcSAWNNF9QeuTz7540svvVSSK5988sehzJiL6nO4bW1tnTp16uzZsx3htL6+fvbs2VOnTpV8KgqPlif/7YKiGpVoafopsENaogWKjNqAWGCNULT4AeNDWaIFioiW2MqPlmbz0dranahhsc3NzYWFC3fv3h36Ij7iJVqgiGiJrcJoaTYf3bz5+eLi5QHTZXNzc3Hx8s2bnw99+SrRAkVES2yVRUuz+ejmzc8HGRlLxsHkyujUzk5ze/u7ra1t0QJZly4tbm1tb29/d8hypTma0dLcHxlbXV2t1X3Z2Wmurq4aBxu1SjouW1vbf/jDHx4+fDjszRlGwrfffru0tLS1tX34uizNkY2WZvPRN9/8eXl5ZWHhwu3bt3sGzM5O8/bt2wsLF5aXVxy3H7VKx8Tu3PmXpaWrly4tKqWuXbv2pz99dShHw5qjHC1J3b+/fvXqtdnZuY8/Xr59+/a9e1+nA2UbGxv37n39xRdffPzx8uzs3NWr147C91eextrZaaYdl83NrYcPNx8+3Pz224dKHc1KNoHNza20yyJaQqpGtCS1ubm1tnZneXnlypUri4uLs7Nzs7Nzi4uLV65cWV5eGfDqW+oJVBItSd9la2s7yRiljmYlm0DSXzmUXZbm0xIt6hBU2ndJAkapo1xpqBzKXBlWiZYjWsmGlM0YpY5gZTeEoW+Vh6lEi2qLGaWOVA196zustRctt2+vKaWUUiG1Fy3DPq0cgMNDtAAQTLQAEEy0ABBMtAAQTLQAEEy0ABBMtAAQTLQAEEy0ABBMtBwKjfFjUys1phNr1JbzqM0PR0+PaFmZOjY2Nra3mjbGxxIDrLYrU8cO1UrfGB8bGxtvDHcmVqaO5c5C+/T9t++gln9u+0NdPsnaO9Y9B+maPOD01vP0eolxy6Ex3vM9rDA/R1L6No4dm2pMjWeXYdX90v4qNd5o/7vs7odqh1dd717LytT4sdaaOhIfhxrjMVtOTDvFrRTdEjX/aXM1uiwH/QZ2tx/3auu11BhPN/q2fW1mLzLQ9MwTVVqkkcuh9AlLbm6MZ/eEwevhaGsLj8Z4lT1+/vLJTq30oWIE9pjDUClaphrpEswsqNZnwrHuacemVtr/KfnUnLlfI5Pyee1nP3l0fY7M3FRltSlsJ3tbhW2vMT7e6P5YW9R+/vS9j6KN9CV3vIBkWVTomvScnremF73elczsTI1n9q8lizk/WvI/9hc9b2v6+Ph+c2XvV/7yye4C2lbb7MfV1p3qTs88dc6knOVWuBwK19v8dtJXk1lMjbYH5a4PHb2d8vWzNc/Jf/+1bP3sY7vrbD/7X/fsJP+0jaBkH7r3sPJNtXgPn79fKl7fcqOlbD6PTa1UHvBJ2pnK627nbHfJezo+nqz8e3fI2wUNI92qRctKuoFlt9FGI7Oe5m7GOet511uceWz7Z4mi9gs+TbQ13BivsjQL2hlrm/+e7WTnuv3V1eq1tA+ZdLzi4mipe5Qlb/nnvt6VqWPta2l6Q+H7kv+8BcuncDl3fHppe1eLdh+5yyc/AzujovV6600vmlC43AqXQ/56W9hOW7R0LZDCjw65HwPylmdBlhatn7W3u+L2i9aH7K68cxgrfWUrU1M5L6bggd3yl1v+FpeNnOy7kjuf7Qs/Z4vJa7+1R+y1P9y/d7q67M9GH/vDWFWjZX9WG20fnnJTPZMnOe9X56TOnXFRB6VXtHR+yqjS4chvp/PzcI91smTVrxstHR/dK/SYanZZdvOWf/7rLXndhe9LXvtFy6dkOWcioY9Fkmmxta9pTGX2WoHR0r2ci5db0XLIX2/L1ru9x+TsLLrmp/TITO/1s30XmfdmDLbdVVkfSqOl18bZfc/M2tW+T6keLfnzUxwt9Vbiwtebu93tz3em/9T3+xKrerQkM52+A+2f5zuWV/Jv7v6tPFra1oDC9vPeneprWXk7Q4yW8n1+fkP1uiwVnqZXtJS+77lPXTtaajxbibYG24OrbRC1tZerNz35L2d0t160FC/n0mgZn8p2akrmZ+/+BdMLlmfr42T+YETmwf1sd3ntH3C09FzfDjBaam7XRetJ/pZQFC19vS+h6kRL2/kOnd2X7jduKnc9Lx1RyGwDZe1nP1KmG1gf557ltlOUdSWtFEdL7uhG0fOOFQ/+FA341Oyy7PZY/sXrcqa/Xfa+V4+Wwudtm965X89fnr2PtbR/+pvKrNDZ5mtOz1/OBcutcH6K1tvCdtLlkLMQCt/33N5L8fLcbYyPNzpX5vz1s79zPvPaL9juWjd0HXyvs//s6m9WiZa85VMcLbnz2TmWWWFALP+jWP52VxQtfb4vgSqdfNxaK9vHQFvjjVNd51Z2LsPsKEdHBy3T0Pj4eNsCLGi/4KzS9k5gtfGk3L5x9Vb277vXS+sYqCg6+zVvemN872WOdTTSekDnrrNOl6XS8i9ZENkZzXtfCtovWz75z1v2JhaeTdzrWEvhaQIdS7TO9N4HhjOPKF1Pil5y7vJPQ6Jz2+x9KlJXvhQuz9ywKVw/a293ee0Xr4eZY+Ct03w617cKz5o7myXbRd7yqbQ+t+Zz78P4VGaTqfAW5befs91l7p1+7M8cE+vnfYkzYl+ZPLJn6tV+6dU+7HJQRm05R89PV4cgeNMc/oANB2skoqVROdQPK0uAEZHb1wtcPwv7khwuIxEtABwmogWAYKIFgGCiBYBgogWAYL2ipf3KQYdf3OstvcTGEObn6dDr9R70Ob+jc05x+foTNZ85Xy+BCBV6LQd76e2OKxBWcrBz9MQufl7xmevPz9NysfSo13tYPYlveVX4ejj0oWK01LgYePHFrgsv8lznA37xxa7bbqu0uQz14ueVX1fR/NT+0YEKT529sEU6oftr3zXe99bk3DvVeL3709qWfclFyLPznf2xhl6LIe+CH+lcjpfv7TtW+b05yLn8QOdX7vO2l4L1J3Y5HOEvKXOgKkVLrYuB7+7ur8z7F7dJLkDb6yLPNfIl5GL4Q774eeXXVTQ/dX90oPhJC96Xgh9HqPu+d11XrT1E8mao6EcKiqbkXoS8UfRjDeVKn7FCF7vwMohl62fBxeHrXTy/v+UgWjgYNQfEel8MvONumVZK7t9+r57resQVi4d78fOi+/caIOp9ke3idkrnMa+l3B9HqPu+t89PlStDl1zpdjd/l9rrcn51dqC5FzOu8/3xZHb29+KZZClZPwuXW/H6E7UcRAsHo+9oKd1159xY6RLCA/RaDjpaQi9+Xnj/6rvauj86UKR0OeX8OELd971teu5vL+Q/aVGD/e1Sq1+xqnxXW6k3PD61kvw06/jUSuaXrvqKlsL156CXAwym72gp3cry1uDSrbLe6VQhF8Mf3sXP672uCruMSj86UKT0fcn5cYS673vrRZRc8bDKRcs7H5NtOuf+BT/W0Ev5jw6U/l5Bep+pqf1fZj12rHNl6J7Rrv86nzr3TTzo5QCDqXTy8ViNi4GXXey6+P41V/jBL4bf9YA0V2q+3oJ2MmnZeRS81uuqd5Ht8uVTaTnkXFA+Z7dW733fv72roRqvd6CL9rf9WEO+wour178yeboD70jh3PWzcLkVrD/By6HOYSiowVcmeSKGOxTjiELCcuBJES0crCFeRN1PFSQsB5480QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAMNECQDDRAkAw0QJAsL1oUUoppQLr/wND3Cq2bCTjlAAAAABJRU5ErkJggg==" width="542" height="467" class="img_ev3q"></p>
<p>The index page at <code>http://localhost:8000/</code> will tell you to navigate to <code>http://localhost:8000/check/&lt;username&gt;</code> where you should fill in the GitHub username you want to check. For me, this is: <code>http://localhost:8000/check/shawntabrizi</code>, which gives me the following confirmation!</p>
<p><img loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAh4AAAHTCAIAAADnP4bqAAAcBUlEQVR4nO3dT2xbB57YcZ17aU+LvTVAAZ9a5VQUmFNvBTJRb8lNSC7VIZ4kvigD59TAxQIDMDAwKJwC6SztzKCBppmDqJGVLdaWx0pkO5In2WAmkeTN2qaTOE40kmOLsujNmj086fHxz6NI6meLkT4f/A7xE/n4R+L76r1HKkM/eW/9yP+5Z4wxxoTMT95bH/rJe+tP/bv//OTn2f/63/7V/6gZM7DzV3/97/flpWHMj32kxZjckRZj+pt9Tku1+tCYgR1pMaa/kRZjckdajOlvpMWY3JEWY/obaTEmd6TFmP5GWozJHWkxpr+RFmNyR1qM6W+kxZjckRZj+htpMSZ3ek3L27+aePtXE/vyajJmoEZajMmdXtPy/t9dfP/vLu7Lq8mYgRppMSZ3pMWY/kZazIGdM2feeeut/9W6/NSpt2Zm3u9mDdJiHt90/tl7kvekXP66jy91nkFOy9To0HBheS8bl3QNe19V45RGh4aGhoaGhgsre1qSLh+dCn0G8q/Y/rain5893slklgvDbS+Qt7xlTp1665lnfvrmm29mFxYKhWee+emZM+90cyelxTy+qeb3o8OXHtO0TUjfXXlKWvra/LWudmp0aLTU/KVdlySzUhjOu2/hacm7rceUls6rfRI9S0KS1iX5Z6FQ6PLq0mIe31QHKS1PtYRkL115Slr62TguF4aHC8vVh9Xqw9Lo0GipYVdguTA8XFjpakm6tva7LNF3u9NtHdi0VDN16bUr1d3S8vavJpKWdB7vGTNtpzpgaXkqk5M9duWpH01algvDQ9tGS+kFVtKlycKdA05DOxvxxrSUti/esFlvXm12nVPp+oZGp6ql0aHtoqS/+2/viDSkojQ6NDrVzZLkv5cLw/mPaNe7newG5Vxx+x4Otbutrm6o6fnc7mjrt2Z0antJIXvEr/HZy/vuNN/o1OjQ8Ojo8NDQaGnnVjLfpeS6PTcpiUqvXZGWAzmdv+NP+J708aXHPeXy13vvylM/krRMjaab/vpx9pXCcMtJizZXzGxhkzCURofqB6ZaVtt8KiKzFaunpb5xT66+h7SkR8naPqK8u12/S8OFlZwrDheWVwrD2RJnbqvNw2y9oZYnIb1WaXR4ePvh7DyuTMPa3tWcb+v2jda/rVOjjZnJXD3viGIPaWk677LHtLSOA2Km+5GWxzXdpmW5MJzZ2G3/7ty4sL7JHtr5vbk5LenGaNfVZjfTXR0Q6z8t221Ic5WzTW++20MNv8XnXHG4qTfNt5X3MBtrmn0+dx54aXS4UEr+O7sD17qGxmcv97uTef7z7knePlPXXSkUCk3nXaTF7O8MYFoO2QGxLtNSX9K6ves6LdWH1er2EZiWLV39q82R6PNcS+NJ9R7SkvfAs1ccGh4ezuyatDmBn/MwW28ovW7yH1Oj21EZLdUru1taOn13koUd09Kwm9VDWprOr/RaF2kxj28GLS2H8DR+05GrdAvV/Ft5u6MrnX+nbl1tUz/aHRDLHBkrjQ4NF1YyV2/dLndc0nBUKu+4Vpu73Xix3Ctu371q7gn8Ng8ze/ir+fl8uFwYzh4KGx0dbXfwqt3T3v67k7l7bQ52tb65rre0JG8+bjq/4s3HZkBmoNJyWN98XD8K1HTwPXsueufU9PDoaDd7LW1XmznXXNqJR8tp/MyJ5XR7vXPF+rmN3ZY0nsBv+4h2vdvZU+Jtr7iSHPk613RbzQ+z7Q21Pp+Nnylp+HxJ+7taf/Zyvjujo8ONz1Kb9dTv7Pa5mW7TcubMO6dOvdU2OT4yafZ9Ov/sPcl7ctg+MnmwJzmsdPBu60CNP09pTH8jLcbkjj+qb0x/Iy3G5I60GNPfSIsxuSMtxvQ30mJM7kiLMf2NtBiTO9JiTH8jLcbkjrQY099IizG5Iy3G9DfSYkzuSIsx/Y20GJM70mJMf7Odlr/66//w5Oc//qf/su/bDmM6zL/+N/92X14axvzYZzst+/4aNsYYc2BGWowxxgSPtJiHW1tVYw7n7Pur76BOz2nZ2KiUy7cWFhY/+OCD2dnZycnS5GRpdnb2gw8+WFhYLJdvbWxU9v1RmV0n++p68GDLmMM5hyEz16/fePI32kNavvtu9fLlK5OTpStXrty4cfPOnW/X19cfPXr06NGj9fX1O3e+vXHj5pUrVyYnS5cvX/nuu9V9f0JN3mSLsrn5wJjDPNnG7Ptr83HM4Kbl7t3vFxYWp6fP3rhxc2ur+qijra3qjRs3p6fPLiws3r37/b4/raZpkqh89dXX8/OXzp+fNcZcunT59u3bSWD2/RUaPgOalnL51vT02aWlpV2j0hSYpaWl6emzt2/f3vdn1qST7q/Mzc1tbGzUgFrt3r178/PzB3XfZRDTsrJybXr6bHrgq1fr6+vT02dXVq7t+5Nrkkm6srn54Pz52f1+OcMAOX9+Njk4Ji0h0yktKyvXZmcv9LSz0nb3ZXb2groMyCRpqVQ2pQWyzp+frVQ2pSVqctOSHAfbY1cSGxsbjowNyGxtVTc3H0gLNEnSsrn5QFpCpn1a7t79fi/HwVolR8ac1d/fSY+GbWxUpAWyzp+f3dioHMhjYgOUloWFxaWlpaiuJJaWlhYWFvf9WT7MIy2QR1pip01avvtuNepQWNbWVnV6+uxh+7zL2tr60aM/O3r0Z2tr+/8nD6SFQ+XUqVOnTp3q8sJ7TMtLLx09evRn+/4abzuDkpZLly7fuHFj11Tcv3//lVdeeeWVV7qvy40bNy5dutzHvbxw4Q8XLvyhUtkMfORra+vvvPPro0d/9swzP33mmZ++9trPf/e736UBCPlBSbqSrH8Q6tJHWiqVytTU1IkTJ8bGxsbGxk6cODE1NVWpVPp/uXPoLS8vv/7662NdeP3115eXl/u7lfn5+WQl8/Pz3Vx+j2lJXub7+wLPm4FIy8ZGZXKytOsuS9KVZ5999uWXX+4+LVtb1cnJUh/38sKFP5RKU4F1uXhx7vnnn09+GrLz/PPPX7w4V434QUm78tJLR1966egg1KXXtMzPzx87dqxYLJbL5WRJuVwuFouvvvpqly9XaHX8+PFuupLWZY+30uUaBi0tr73286YtRuuSLqf7tCRbqg7T/S/czWkpl29dufJR9125f/9+92l59OjRlSsflcu3en1qKpXNwLrMzLyfPE1vvPFGEpK1tfWLF+dee+3nyfKrV/+4xx+UbFfW1tbX1tYHoS49pWV+fv7VV19No5JVLpfVhb5135VEHzeR7LIcP348CUw3P6sDmJamLUbrki4nMC0vvXS0y1U1p2VhYbHz0bC9dOXRo0c3btzo72R+VF3W1taT/ZWZmfdbv1ooFJJ9l738oDR1JV2473XpPi2VSuXYsWPZrpw4ceLEiRPpP5O6dHFkbOaFoRdmdn1Z7y5dz/WTTz998nrAGtu5NXXyv287OXUr84WF4s7y4kL2Cld//Te/+MUvCoXCyd/+Q3b552f/9syZM7/5zW/ePXet9Wa+vHruk69aF1e+vnbtmwchD2SgPda0rK6upgfc5ufnk8YkB9ZWV1c7XHHQ0tK6xeh7GzIQB8Tm5ubu3Pn2MXXl0aNHd+58Ozc31999DanLmTPvJPsreRdI9136+0Fp25W8n5UnPN2npVQqTUxMZJc0paVWqxWLxVKptNsrfSDTknOnFor1ctyaOtn2vxeK9eh8Of3Lv/n11eS//+G3J4vnbyf/fWfu3b89+3ny39fOvTt9tXGLdvezD89dbVOWw5eWcrmc/I6SDUmyr1wul3tKy8cff/zmm28eO3Ysvdbx48eTL2WPvx07duzNN9/8+OOPW9cwaGlpu8XobxsyEGmZnZ3N+zjL5ubmHrvy6NGj9fX12dnZvu/u3uuSfGM+/3yp7fKm6eNHIT1v3/Ybv7a2vo9n9btPy4kTJ9oeCssql8tNsWnnR5SWW1MnM7sq9X8tFLO7KvXOLJw5ceZquvzrvy/+8nd/qtVqtT///u3ff54uX12Y/r+z/5S5mbufXfxw6W67uzWIaUn2ALKn07tZ0lk2LbWdPeBsV5KFPaUlfafJq6++WigUJiYmsndvYmKiUCikt9L257bXtLzxxhvZV3F2i5FsBzr8/trTJmXvdRmItExOlvKq8PLLLz/btQ7vHOtwJj/JRpdz4cIf+njAec1oTUv3RxXbrqTzHejphFjUdJ+W1tdz615L24u1yG7Fr598emhbQx0yy5MLz7zQcrmmtKSXyCai/fozS1+Yab2xW1Mnd/ZD2u+dNBan/u9bU7/85fSX9eVfny8WL3xTq31z8d13576tL1+9Oj39x7+k/1z/7OLFnbLc++Lq/JUrVxYXFz/55NpfttOy/uU//uP169fL5TuZvx66tfH99xsbGw8ePPjhX3Z7ykO1ngzvZkln2X2IbF2yXcnuf3Szzm7eD9b5Mr2mpenMR/qqT3+/fO21n4e8bNOWpCtsXdJ5BuI0flRaOrxzbDDTEjLpm8HSm0j/mX5L0m71ka49zl7S0vZF3ktarp98uh6C6yef3tn6Ny0/OVOrzZzMBGX7Yo3r2bnCzAvpf+as//rJp9OlMzMz6WrTJGXSUsucbKkvatxpqadloXjizGJm+U5a/jz59u8/yyxvTMvNy//v4md3a7Va7ftrH83N/+mbZHHl1q2/1CpfX/tsebmcdOf+nfJX3yVx+efK3bX7D36o1Wq12g8/PPznvOf6cUh/00+PL3WzpLN0D6OpLm270sWe8bbO5di1Pb2mpWnvIT1WkXc8vO9pbVWv9RqI0/gdDohVKpWkLq+88srBOyAWONm0tB5ee6xt6zx7OSDWmpbeDohlN/G1Wv24ViYOna6ed0As/Vfe+jMRa7PWBremTjaea0nyEpqWm5dnFpJmffXJ3Nyn3zTcgcYDYlt/+eab9Ye1Wu3B3bW7lR92Fv/LDw9b7vljtLy8nLzPKnt8adclnU1MTIxlZN8w0tSVsbGxpnN+naX9aDqb8vHHH++6T9PHuZZsXdLfIB9TV9J19lGvgTggtutp/D3WZfBP4+99DkBaWk/jt6alt9P49f2PRCYtradOsgetukxL3voza6vXpG1asofDsv+OPCB24/LM5e1VffXJ3EfX7jXcg/y0rK19v3NA7OHDJ5qWx2F1dXWsUVKX1q6MjY11fltXq0KhMDY21hS55eXlsbGxQqHQ4Yr9ncZP65L9vX6gulIdkLR08+bjvdTliy++2Pc3Hz/33HPP5Lz5+L333tt7dVpDknxQpvWrT3h6evNx04da9vrm4+a9k/y0NFyy672WvPW3XW/btGTfH1arZVLTchp/5/R+82n84vlvarU2p/GnryZlWfv03Mzlm9vLe0pLZq/lYGjaccnT0y5LIjnalvzorq6uJmVK3hTQeSe773eIZesygF2pDkhauvzIZN91GbSPTKZHxj7/fOmNN95IlvdxD7NzAPZaart9ZPLYsWPdfWQy/1xL5nRJGoHrJ0/OZGKTuc5uaclb/8wL7W+zzbmWhWLmFEv26Fg2Otk3Hy+eOdH2zcef/f7tdm8+Xvv03Lk/rafPzFefzs1d/WI7LjvnWtqlpfbg3lp6ruXgyJ5xaav7syxZ6b7O6dOnk/8+ffp0up/U4Yp7efNxUpfArlR3Dt1n19m6pMsZiNP43f+hl7Qu3XdlcP7Qy8zM+8m+S9M899xzyefz9zLJqpJoNaXl88+Xfixpqe3U5fTp09lD4adPn+7lo/jZrXj9jV+NeypNy+uHw54+ebLbvZa89be8+yx7yaZ3iGU/Gdm6B9Puk5RfzvzP7Y9M/u+//zqz/M6Hv93+yGRpYed4zton5859ul7Luv2n+Z13iP35ViU3LbXsO8QePjw4jemw79LH/kqt3aG27g+vDdpfPm5tVd/1GojT+NVe/jzlyy+/3NPfEBu0P0955sw72T3ZM2feCfmlo220svPiiy8GPpDup78/T1kqlbJ/nrJUKvnzlH24/sHkuU/X9vteDJzV1dWJiYnsD9jExESv51dSyTmVRLFYTA6IFYvFdGGHNxr0mpbAX/Af9wzEAbGqP6q/57l69Y8vvvhih65cvfrHfblj/qj+/vmnDyY/uLHfd+LAq1Qqx48fP3XqVFOcVldXT506dfz48Q6/FYWn5cl/uiBvBiUtVf8rsAM60gJ5Bu2AWOAMUFr8D4wP5EgL5JGW2Gmflmr1Ybl8K+qw2MbGxvT02du3b+/7U3zIR1ogj7TETm5aqtWHKyvXZmcv7LEuGxsbs7MXVlau7fvza6QF8khL7HRKS7X6cGXl2l6OjCXHwXRlcGZrq7q5+aBS2ZQWyDp/frZS2dzcfHDAulIdzLRUd46MLS0t9bT7srVVXVpachxs0CbZcalUNj/88MP79+/v98sZBsK9e/fm5+crlc2Dt8tSHdi0VKsP7979fmFhcXr67M2bN3cNzNZW9ebNm9PTZxcWFp23H7RJj4nduvXl/Pyl8+dnjTGXL1/+6quvD+TRsOogpyWZ775bvXTp8uRk6aOPFm7evHnnzrfpgbL19fU7d7794osvPvpoYXKydOnS5cPw+ZUf42xtVdMdl42Nyv37G/fvb9y7d9+YwznJS2Bjo5LuskhLyPSQlmQ2Nirl8q2FhcW5ubnZ2dnJydLkZGl2dnZubm5hYXGPf33LPIFJ0pLsu1Qqm0ljjDmck7wEkv2VA7nLUv2xpMUcgEn3XZLAGHOYJ43KgezKfo20HNJJXkjZxhhzCCf7Qtj3V+VBGmkxDZkx5lDNvr/6Dupsp+XmzbIxxhgTMttp2e+3lQNwcEgLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYP2mpTgyNDQ0Uoy/Q/1ZHD8yNHRkfLGfK/Z0tcd9+R+LxfEjA/TtBwbMHvZaiiOPe9vS0y0URw7kNnxQFUekBcjTVVqKI0PbRkbqG/DiyEgx/UpmM7M4fmTn4pnLNlxq+yJHxheTvZ/x9Crpeuq32XwD7dZf205Leq36V5JFR8YXm+/EzmWbi9R0y82Poeudo/zLt38+8+Q83g43mjzC5HqNT1Hb28084Mylc5+3nS8rOZCni7RkNiKL40caN7U7/8huaBaLxcxGq74hb9w0LY6PpNfNbu4bN4XtfjFuv/5kA5i9cy21S764OD6eXWnrJrJ+q8WR1o15r5vUdutv/3zmyXm8HW4xm+GRTEHa3m7DHWx6xD09bwA7utlryfzanN2y5W3CGn/tz2z6R4r1HmWukLuevANieetv3Ozmr7ZpZTmbyHZd6XT5HG0un/N8dlhF2723/IvnPPC2t9u8d9i0A9r78wbQ67mW7Fnp9puwxvPWmcssjo+MLy6Oj4wXx0fGFzNf6C0tuetv3tbtKS05Xcm9fL7Ol9/9LH/u4+1wi7s/8PpaOzw1u3wRIM/uaWnYNi6OH9klCcWmg/jZy4yPj48keyxH6qvpmJYj9WBtryl3/dnjc60HxHpJS7YrLdfcc1pyn8/dr9/4fO5+jYanJO92O9VNWoC+dJOWdkdLdpaOFOsHWra3UPUrHBkfH2m8zs5h+yPZrV/OemrZQzgNB+Ja17/95uPxzJcWm1fRuKLm5elXmr+Q/nafc/kcuZdv/3x29Q1oej53vcKR8WL9Tdkdbrfdl/Ket8xVHBEDcvjIJADBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEg2HZajDHGmMD5/wnb8PpmPYG6AAAAAElFTkSuQmCC" width="542" height="467" class="img_ev3q"></p>
<p>If I use a username which doesn't exist like <code>http://localhost:8000/check/shawnfabreezy</code>, again I get the expected message:</p>
<p><img loading="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAh4AAAHTCAIAAADnP4bqAAAdi0lEQVR4nO3dT2xUB57gcR9y2kvvaTS3jbQSp13ntFopp5XmsFK62dMkfdixErW0PoSQcHEichg1YjWrkSqDlJkmK2V7CtKtTZNNt8blGKd7B0zjxEBskkw2HWzTNGBCgMRtE3AZlydD7eHZ5Vd/Xrmq/DMuzOej3wE/u179set9671XNj1Pvruw63/fMcYYY0LmyXcXep58d+Hxf/ufHvz84L/8t3/138vGdO38yZ/+u215ahjzsI+0GJM50mJMZ7PNaSmVVozp2pEWYzobaTEmc6TFmM5GWozJHGkxprORFmMyR1qM6WykxZjMkRZjOhtpMSZzpMWYzkZajMkcaTGms5EWYzKn3bS8+dNjb/702LY8m4zpqpEWYzKn3bS8/+vT7//69LY8m4zpqpEWYzJHWozpbKTF7Ng5evStN974n/XLDx9+Y2Tk/VbWIC1m66b5z96DvCWzs1918Knm081pGerr6c1Nb2bjUlnD5ldVPYW+np6enp6e3tzMppZUlvcNhT4C2RdsfF3Rj0/NA9Wbm96S7+8Gc/jwG0899f3XXnstvTCXyz311PePHn2rlTVIi9m6KWX3o8mntmgaJqTjrjwuLS2voflqh/p6+gq1n9pwSTIzud6s2xaelqzr2qKt/FBfT09fYeu+vxtPEpJKXZIPc7lcixeXFrN1U+qmtDxeF5LNdOVxaWl5DamZzvWuvQwv9PX0Fap2BaZzvb25mZaWVNbWeJcl+mY3u66tS0uT1T6ItJRSdWm3K6WN0vLmT48lLWk+3jNmGk6py9LyeConm+zK4w9NWqZzvT2rUq+CZypLk4VrB5x61jbi1WkprH551Wa9drXpdQ5V1tfTN1Qq9K0d2Km89l/dEalKRaGvp2+olSXJv6dzvdn3aMObnewGZVxw9Rb2NLqulq6o5vFc7Wj9t6ZvaHVJLn3Eb/3RS1bY+LtTyPX29Dz22GNPvv77UmmlVDrxau+f//jHf/Fnf/Y/zpZWSl8W/vJHP3rhhb0vv/z2F8k9nfv4H44cfeedd95775ObpZU7X372+eefX7r0h5s3b90t3mtel3a7Ii07cpp/xx/wLengU1s9s7Nfbb4rjz8kaUkdV5nO9a4unMn11p20aHDB1BY2CUOhr2f9wFTdamtPRaS2oetpWd+4JxffRFoqR8ka3qOsm71+k3pzMxkX7M1Nz+R60yVOXVeDu1l/RXUPQuVShb7e3tW7s3a/Ug1reFMzvq2rVzr9N09+78k3fp+kpfe//vxqqbRSKp372x8OjFxfKZVWSv/v7Tc++LpUmvnNT37x2R9XSqWV0vVPPrp8Z22dd+ZvLtzL/lmqpKXmvMsm01I/DoiZ1kdatmpaTct0rje1sVt97Vy9cH2TXXmhXJuWyjZuw9WmN9MtHRDrPC2rbajkKmObXnuzU/qGsi7YW9Ob2uvKupvVNU0/nmt3vNDXmysk/07vwNWvofrRy/zurJRKK8f7v7f310la/vznV1ZKpZXStV8N/PCHP1rda3nlwK8ulL4+94ufHD6yutcyPPq7W8llv73xh/nFDbqSy+VqzrtIi9ne6cK0PGIHxFpMy/qS+u1dy2kprZRKK8nWu/rI0vo0iESH51qqT6q3kZasO56+YE9vb29q16TBCfyMu1l/RZXLJv8Y6luNSl9hvbIbpaXZd2elVJp5/cmGafm7j9P36+tzv/jJ/71c83MyP3vpxp1SzcK6rqQ/bL0u0mK2brotLY/gafyaI1eVLVTtq/K1oyuVg2ZN09J4tTX9aHRALHVkrNDX05ubSV28frvcdEnVUams41oNbnb1l2VecPXmlTJP4De4m+nDX7WP58p0rjd9KKyvr7IntFFaGn93Kjfvb578Xv+vS9VpKZ372x/+8C9Hvkrf09/85PA/fDafWjJ39fPZbzN+hJI3H9ecX/HmY9Ml01VpeVTffLx+FCj90nv9RHFfYWX91HRvX18rey0NV5s611xYi0fdafyV1Hn0te312gXXz21stKT6BH7De7ThzU6fEm94wZnkyNeJmuuqvZsNr6j+8azKTNW/Nz4g1vi709fX29PT89hjj/UfT74snZb0afxXDvzqQqmUPo0/PPq7W99c/Gj9NP5i7Wn8o0ffOnz4jYbJ8SuTZtun+c/eg7wlj9qvTO7sSQ4r7bzr2lHjz1Ma09lIizGZ44/qG9PZSIvZMVMKX6e0GNPZSIsxmSMtxnQ20mJM5kiLMZ2NtBiTOdJiTGcjLcZkjrQY09lIizGZIy3GdDbSYkzmSIsxnY20GJM50mJMZ7Oalj/503//4Oc//Mf/vO3bDmOazPf+9b/ZlqeGMQ/7rKZl25/DxhhjdsxIizHGmOCRFrOyvFwy5tGcbX/27dRpOy2Li8XZ2WsTE5MffPDB6Ojo4GBhcLAwOjr6wQcfTExMzs5eW1wsbvu9MhtO+tl1796yMY/mPAqZuXz5yoO/0jbS8s03c2fPnhscLJw7d+7Klau3bn29sLBw//79+/fvLyws3Lr19ZUrV8+dOzc4WDh79tw338xt+wNqsiZdlKWle8Y8ypNuzLY/N7diujctt29/OzExOTx8/MqVq8vLpftNLS+Xrly5Ojx8fGJi8vbtb7f9YTU1k0Tl+vWvxsfPnDw5aow5c+bsjRs3ksBs+zM0fLo0LbOz14aHj09NTW0YlZrATE1NDQ8fv3HjxrY/sqYylf2VsbGxxcXFMlAu37lzZ3x8fKfuu3RjWmZmLg4PH68c+GrXwsLC8PDxmZmL2/7gmmSSriwt3Tt5cnS7n87QRU6eHE0OjklLyDRLy8zMxdHRU23trDTcfRkdPaUuXTJJWorFJWmBtJMnR4vFJWmJmsy0JMfBNtmVxOLioiNjXTLLy6WlpXvSAjWStCwt3ZOWkGmcltu3v93McbB6yZExZ/W3dypHwxYXi9ICaSdPji4uFnfkMbEuSsvExOTU1FRUVxJTU1MTE5Pb/ig/yiMtkEVaYqdBWr75Zi7qUFja8nJpePj4o/b7LvPzC3v2vLBnzwvz89v/Jw+khUfK4cOHDx8+3OIXbzItzz+/Z8+eF7b9Od5wuiUtZ86cvXLlyoapuHv37osvvvjiiy+2XpcrV66cOXO2g1t56tRvT536bbG4FHjP5+cX3nrrZ3v2vPDUU99/6qnvv/zyK7/85S8rAQj5QUm6kqy/G+rSQVqKxeLQ0NDBgwf7+/v7+/sPHjw4NDRULBY7f7rzyJuenn711Vf7W/Dqq69OT093di3j4+PJSsbHx1v5+k2mJXmab+8TPGu6Ii2Li8XBwcKGuyxJV37wgx/s3bu39bQsL5cGBwsd3MpTp35bKAwF1uX06bFnnnkm+WlIzzPPPHP69Fgp4gel0pXnn9/z/PN7uqEu7aZlfHx83759+Xx+dnY2WTI7O5vP51966aUWn65Qb//+/a10pVKXTV5Li2votrS8/PIrNVuM+iUtTutpSbZUTab1F9y1aZmdvXbu3Eetd+Xu3butp+X+/fvnzn00O3ut3YemWFwKrMvIyPvJw3TgwIEkJPPzC6dPj7388ivJ8vPnP97kD0q6K/PzC/PzC91Ql7bSMj4+/tJLL1WikjY7O6sudKz1riQ6uIpkl2X//v1JYFr5We3CtNRsMeqXtDiBaXn++T0trqo2LRMTk82Phm2mK/fv379y5UpnJ/Oj6jI/v5Dsr4yMvF//2Vwul+y7bOYHpaYrlYXbXpfW01IsFvft25fuysGDBw8ePFj5MKlLC0fGRp7teXZkw6f1xirruXzoiScOXQ5YYyPXhg79eNWhoWupT0zk15bnJ9IXOP+zv/rrv/7rXC536J1/Si+/cPzvjx49+vOf//ztExfrr+bL8yc+vV6/uPjVxYs374Xcka62pWmZm5urHHAbHx9PGpMcWJubm2tywW5LS/0Wo+NtSFccEBsbG7t16+st6sr9+/dv3fp6bGyss9saUpejR99K9leyvqCy79LZD0rDrmT9rDzgaT0thULh2LFj6SU1aSmXy/l8vlAobPRM78q0ZNyoifx6Oa4NHWr474n8enS+HH79r352Pvn3P71zKH/yRvLvW2Nv//3xC8m/L554e/h89Rbt9hcfnjjfoCyPXlpmZ2eT1yjpkCT7yrOzs22l5ZNPPnnttdf27dtXudT+/fuTT6WPv+3bt++111775JNP6tfQbWlpuMXobBvSFWkZHR3N+nWWpaWlTXbl/v37CwsLo6OjHd/czdcl+cZcuDDVcHnNdPCjUDlv3/AbPz+/sI1n9VtPy8GDBxseCkubnZ2tiU0jD1Farg0dSu2qrH80kU/vqqx3ZuLowaPnK8u/+sf867/8vFwul3/33pvvXagsn5sY/j+jf0hdze0vTn84dbvRzerGtCR7AOnT6a0saS6dlvLaHnC6K8nCttJSeafJSy+9lMvljh07lr55x44dy+VylWtp+HPbbloOHDiQfhantxjJdqDJ69e2Nimbr0tXpGVwsJBVhb179/6gZU3eOdbkTH6SjRbn1KnfdnCHs5pRn5bWjyo2XEnzG9DWCbGoaT0t9c/n+r2Whl9WJ70Vv3zoiZ5VVXVILU++eOTZuq+rSUvlK9KJaLz+1NJnR+qv7NrQobX9kMZ7J9XFWf/42tDrrw9/ub78q5P5/Kmb5fLN02+/Pfb1+vK588PDH/+x8uHCF6dPr5XlzqXz4+fOnZucnPz004t/XE3Lwpe///3ly5dnZ2+l/nro8uK33y4uLt67d++7f9noIQ9VfzK8lSXNpfch0nVJdyW9/9HKOlt5P1jzr2k3LTVnPirP+srry5dffiXkaVtpSWWF9UuaT1ecxo9KS5N3jnVnWkKm8mawylVUPqx8Syrd6iBdm5zNpKXhk7ydtFw+9MR6CC4femJt61+z/NBIuTxyKBWU1S+rXs/aBUaerfwzY/2XDz1RWToyMlJZbSVJqbSUUydb1hdV77Ssp2Uif/DoZGr5Wlp+N/jme1+kllen5erZ35z+4na5XC5/e/GjsfHPbyaLi9eu/bFc/OriF9PTs0l37t6avf5NEpd/Lt6ev3vvu3K5XC5/993KP2c91luh8kq/cnyplSXNVfYwaurSsCst7Bmval6ODdvTblpq9h4qxyqyjod3PPWtardeXXEav8kBsWKxmNTlxRdf3HkHxAInnZb6w2tb2rbms5kDYvVpae+AWHoTXy6vH9dKxaHZxbMOiFU+ylp/KmIN1lrl2tCh6nMtSV5C03L17MhE0qzrn46NfXaz6gZUHxBb/uPNmwsr5XL53u3528Xv1hb/y3crdbd8C01PTyfvs0ofX9pwSXPHjh3rT0m/YaSmK/39/TXn/Jqr9KPmbMonn3yy4T5NB+da0nWpvILcoq5U1tlBvbrigNiGp/E3WZfuP42/+dkBaak/jV+flvZO46/vfyRSaak/dZI+aNViWrLWn1rbek0apiV9OCz9ceQBsStnR86urur6p2MfXbxTdQuy0zI//+3aAbGVlQealq0wNzfXXy2pS31X+vv7m7+tq14ul+vv76+J3PT0dH9/fy6Xa3LBzk7jV+qSfl3fVV0pdUlaWnnz8WbqcunSpW1/8/HTTz/9VMabj999993NV6c+JMkvytR/9gFPW28+rvmlls2++bh27yQ7LVVf2fJeS9b6G663YVrS7w8rl1OpqTuNv3Z6v/Y0fv7kzXK5wWn84fNJWeY/OzFy9urq8rbSktpr2RlqdlyytLXLkkiOtiU/unNzc0mZkjcFNN/J7vgdYum6dGFXSl2SlhZ/ZbLjunTbr0xWjoxduDB14MCBZHkHtzA9O2CvpbzRr0zu27evtV+ZzD7XkjpdUonA5UOHRlKxSV1mo7RkrX/k2cbX2eBcy0Q+dYolfXQsHZ30m48njx5s+ObjL957s9Gbj+c/O3Hi84XKI3P9s7Gx85dW47J2rqVRWsr37sxXzrXsHOkzLg21fpYlrbKvc+TIkeTfR44cqewnNbngZt58nNQlsCultUP36XXWL2lxuuI0fut/6KVSl9a70j1/6GVk5P1k36Vmnn766eT38zczyaqSaNWk5cKFqYclLeW1uhw5ciR9KPzIkSPt/Cp+eiu+/sav6j2VmuXrh8OeOHSo1b2WrPXXvfss/ZU17xBL/2Zk/R5Mo9+k/HLk71Z/ZfJ//eNXqeW3Pnxn9VcmCxNrx3PmPz1x4rOFctqNz8fX3iH2u2vFzLSU0+8QW1nZOY1psu/Swf5KudGhttYPr3XbXz6ub1XH9eqK0/ildv485d69e9v6G2Ld9ucpjx59K70ne/ToWyEvOhpGKz3PPfdc4B1pfTr785SFQiH95ykLhYI/T9mByx8MnvhsfrtvRdeZm5s7duxY+gfs2LFj7Z5fqUjOqSTy+XxyQCyfz1cWNnmjQbtpCXyBv9XTFQfESv6o/qbn/PmPn3vuuSZdOX/+4225Yf6o/vb5wweDH1zZ7hux4xWLxf379x8+fLgmTnNzc4cPH96/f3+TV0XhaXnwv12QNd2SlpL/CmyHjrRAlm47IBY4XZQW/4HxjhxpgSzSEjuN01IqrczOXos6LLa4uDg8fPzGjRvb/hA/4iMtkEVaYiczLaXSyszMxdHRU5usy+Li4ujoqZmZi9v++BppgSzSEjvN0lIqrczMXNzMkbHkOJiudM8sL5eWlu4Vi0vSAmknT44Wi0tLS/d2WFdK3ZmW0tqRsampqbZ2X5aXS1NTU46DddskOy7F4tKHH3549+7d7X46Q1e4c+fO+Ph4sbi083ZZSl2bllJp5fbtbycmJoeHj1+9enXDwCwvl65evTo8fHxiYtJ5+26byjGxa9e+HB8/c/LkqDHm7Nmz169/tSOPhpW6OS3JfPPN3JkzZwcHCx99NHH16tVbt76uHChbWFi4devrS5cuffTRxOBg4cyZs4/C7688jLO8XKrsuCwuFu/eXbx7d/HOnbvGPJqTPAUWF4uVXRZpCZk20pLM4mJxdvbaxMTk2NjY6Ojo4GBhcLAwOjo6NjY2MTG5yb++ZR7AJGlJ9l2KxaWkMcY8mpM8BZL9lR25y1J6WNJidsBU9l2SwBjzKE8lKjuyK9s10vKITvJESjfGmEdw0k+EbX9W7qSRFlOVGWMeqdn2Z99OndW0XL06a4wxxoTMalq2+23lAOwc0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASBYp2nJ7+7p6dmdj79BNSYHdvWsaXJ1kwO7enp2DUxu+e2JMjmw62G6uV1jcmDXg/ixAzZnE3st+d1b/xzP7255A9zGlz6qHsR3bKvld0sLdL+W0pLfXdlx2L2+Ac/v3p2vfCb1dE/taKS+tuqrVr9k18BksvczULnI+nrS+ytV62q0/vJqWiq3Z/0zyaJdA5O1NyJ1t6p3eDKWpxanPrW++vqPmj+a9V/V+HHOXknDx636lja6sxvtAq7KeJyb3Z78+uUaP3JV96vx45z9/Vr9tFcQ0P1aSEvqyTw5sKs6F+ub1PUn/GQ+n9p4rG0Yal8xTw7sTm2O17+qesPRaEPSeP3Jhih94+pql3xycmAgX7fq/O6GdyW9PHUP0kvT96TR/cxSf8+yHufsNTR83KpuXPVxt/b2WjIe5ya3J/26YHeqIA3vV+bjXG78/apfG9C1WtlryTjfkbUpqX6BnNr0786v9yh1gcz1lDM2JFnrr33pnr3a2pWk1pS1PH3B+iis747VXVGGBvesxfNK9ddaHeqshLd9QKzx49zm7Sln3K+mj3OTh1Fa4GHQ5rmW9KvgxpuSzNfJkwO7ByYnB3YP5Ad2D0ymPtFeWjLXX7/D0zQtWVuv5nFo0JX0hdrYdjffRLZyln9r09L+/s4GD3jNWps+zq0XGuhKG6elahs4ObBrgyTkaw6mp79mYGBgd7LHsmt9NW2mJXP96eNz9QfE6jdVWVvv7K16uiv1N3R3vq0NYt09y3ycs9fQ8HGrXnHN7uTapzZ+o1X293HjS1R9K7LuV7N6Sgs85FpJS6OjFmtLd+fXD3hUndhOFgzsrr7M2uHzXemtUOP1ZJ53brT+1TcfD6Q+VX/Sv+7ATuO7lrE8820F69fTyj5B7Woq68+6Mc2/Kw0e/yYHsiYbn/ZvfhV138cNL7BrIL/+ZvAm96vRp5p9v8q1LyCALuVXJoN4oQ2wRlo2q82T7wA7n7QAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAIJi0ABJMWAIJJCwDBpAWAYNICQDBpASCYtAAQTFoACCYtAASTFgCCSQsAwaQFgGDSAkAwaQEgmLQAEExaAAgmLQAEkxYAgkkLAMGkBYBg0gJAMGkBIJi0ABBMWgAItpoWY4wxJnD+PyKOMA1Fz1tSAAAAAElFTkSuQmCC" width="542" height="467" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="more-to-come">More to come!<a href="https://shawntabrizi.com/blog/code/combining-rocket-with-reqwest-to-call-an-api-with-rust/#more-to-come" class="hash-link" aria-label="Direct link to More to come!" title="Direct link to More to come!">​</a></h2>
<p>I hope that you found this little tutorial helpful. Getting started with Rust can be a little frustrating due to many compile time checks which occur, but sometimes you just need some running code to really get started. If you want to support this blog and other posts like this, feel free to check out <a href="https://shawntabrizi.com/donate/">my donations page</a>.</p>]]></content:encoded>
            <category>programming</category>
            <category>reqwest</category>
            <category>rocket</category>
            <category>rust</category>
        </item>
        <item>
            <title><![CDATA[Running Parity Substrate on Mac OS X]]></title>
            <link>https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/</link>
            <guid>https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/</guid>
            <pubDate>Thu, 11 Oct 2018 23:06:45 GMT</pubDate>
            <description><![CDATA[This guide will show you the steps to successfully connect to the Substrate testnet, BBQ Birch using Mac OS X.]]></description>
            <content:encoded><![CDATA[<p>This guide will show you the steps to successfully connect to the Substrate testnet, BBQ Birch using Mac OS X.</p>
<p>All of the instructions on this page are commands which should be copied into your <a href="https://support.apple.com/guide/terminal/welcome/mac" target="_blank" rel="noopener noreferrer">Terminal application</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h2>
<p>First we need to install <a href="https://www.rust-lang.org/" target="_blank" rel="noopener noreferrer">Rust</a>. Open the terminal app on your Mac, and run the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://sh.rustup.rs -sSf | sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Follow the instructions that appear to complete the installation.</p>
<blockquote>
<p>At the end of this installation, you will need to run <code>source $HOME/.cargo/env</code> or log out and back into your computer to have your terminal understand <code>rustup</code>/<code>cargo</code> commands.</p>
</blockquote>
<p>To enable <a href="https://www.hellorust.com/news/native-wasm-target.html" target="_blank" rel="noopener noreferrer">Rust to compile to WebAssembly</a>, run the following:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rustup update nightly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rustup target add wasm32-unknown-unknown --toolchain nightly</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cargo install --git https://github.com/alexcrichton/wasm-gc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Install the <a href="https://brew.sh/" target="_blank" rel="noopener noreferrer">Homebrew</a> package manager for OS X:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/usr/bin/ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Follow the instructions that appear to complete the installation.</p>
<p>Finally install some general packages required for running this software:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">brew install cmake pkg-config openssl git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Click each package to learn more about it: <a href="https://cmake.org/" target="_blank" rel="noopener noreferrer">cmake</a>, <a href="https://www.freedesktop.org/wiki/Software/pkg-config/" target="_blank" rel="noopener noreferrer">pkg-config</a>, <a href="https://www.openssl.org/" target="_blank" rel="noopener noreferrer">openssl</a>, <a href="https://git-scm.com/" target="_blank" rel="noopener noreferrer">git</a></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="installing-substrate">Installing Substrate<a href="https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/#installing-substrate" class="hash-link" aria-label="Direct link to Installing Substrate" title="Direct link to Installing Substrate">​</a></h2>
<p>Navigate to the folder of your choice, and clone the Substrate repository there:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">git clone https://github.com/paritytech/substrate.git</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd substrate</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Then build the WebAssembly binaries required for Substrate:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">./scripts/build.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Finally build the Rust native code:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo build</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>Optional: If you want to make sure everything got installed correctly, you can run the full suite of Substrate tests:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo test --all</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-substrate-testnet-bbq-birch">Running the Substrate Testnet: BBQ Birch<a href="https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/#running-the-substrate-testnet-bbq-birch" class="hash-link" aria-label="Direct link to Running the Substrate Testnet: BBQ Birch" title="Direct link to Running the Substrate Testnet: BBQ Birch">​</a></h2>
<p>To start syncing your BBQ Birch node, simply type:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cargo run</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img loading="lazy" src="https://i.imgur.com/jxqqr9Q.png" alt="Screenshot of BBQ Birch running in Terminal" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-next">What next?<a href="https://shawntabrizi.com/blog/substrate/running-parity-substrate-on-mac-os-x/#what-next" class="hash-link" aria-label="Direct link to What next?" title="Direct link to What next?">​</a></h2>
<p>More documentation to come on interacting with the network!</p>]]></content:encoded>
            <category>bbq birch</category>
            <category>osx</category>
            <category>parity</category>
            <category>polkadot</category>
            <category>substrate</category>
        </item>
        <item>
            <title><![CDATA[4 Things I Learned in 4 Years at Microsoft]]></title>
            <link>https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/</link>
            <guid>https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/</guid>
            <pubDate>Thu, 27 Sep 2018 17:02:50 GMT</pubDate>
            <description><![CDATA[I am in the midst of a turning point in my life. This month I left Microsoft to join Parity Technologies, a start-up company focusing on blockchain infrastructure and the future of the decentralized web.]]></description>
            <content:encoded><![CDATA[<p>I am in the midst of a turning point in my life. This month I left Microsoft to join <a href="https://www.parity.io/" target="_blank" rel="noopener noreferrer">Parity Technologies</a>, a start-up company focusing on blockchain infrastructure and the future of the decentralized web.</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5bad0b7eeb066-d833d6887d81c703756b04107f148fe3.png" width="951" height="1079" class="img_ev3q"></p>
<p>It feels a bit like when I graduated from university, and in a way it is exactly the same! I spent 4 years at Microsoft, met new friend, lived in a new city, and learned new things literally every day. As a recent graduate of 'Microsoft University', I thought it would be important to reflect on some of the big picture items I learned during my time there. These learnings will be more opinions rather than facts, but nonetheless, things that I will bring with me to this next adventure and continue to develop as I grow in this new role.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="customer-obsession-isnt-just-a-phrase">Customer Obsession Isn't Just a Phrase<a href="https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/#customer-obsession-isnt-just-a-phrase" class="hash-link" aria-label="Direct link to Customer Obsession Isn't Just a Phrase" title="Direct link to Customer Obsession Isn't Just a Phrase">​</a></h2>
<p>I joined Microsoft the same year that <a href="https://en.wikipedia.org/wiki/Satya_Nadella" target="_blank" rel="noopener noreferrer">Satya Nadella</a> became CEO. I distinctly remember his internal speeches when he emphasized the importance of "customer obsession". In his own words from his book <em>Hit Refresh</em>:</p>
<blockquote>
<p>First, we need to obsess about our customers. At the core of our business must be the curiosity and desire to meet a customer’s unarticulated and unmet needs...</p>
</blockquote>
<p>As a new employee to a large company, I was a little skeptical of this attitude being more talk than action, but I can tell you from my personal experience, customer obsession isn't just a phrase. I actually spent a full 2 months at Microsoft learning about the <a href="https://en.wikipedia.org/wiki/Moneyball" target="_blank" rel="noopener noreferrer">"moneyball"</a>/<a href="https://en.wikipedia.org/wiki/The_Signal_and_the_Noise" target="_blank" rel="noopener noreferrer">"signal"</a> process, and it really has shaped the way that I approach product development and project management. The successful product teams I saw at Microsoft were always able to answer the following questions:</p>
<ul>
<li>What is the top frustration of your customers?</li>
<li>What are some solutions to those frustrations?</li>
<li>How are you experimenting and measuring those solutions?</li>
</ul>
<p>The key aspect of these questions is that it starts at the customers who use your products. Many times product owners use their own anecdotal experiences to determine what they should be working on and what their customers are experiencing, but this is a setup for failure. When you are too close to a product, all of your view points become skewed, and you lose sight of what the average customer experiences. I have seen teams spend all their efforts adding new features to a product, when in fact, there were so many problems with sign-up and onboarding that people would likely never even get that far before they gave up! I am not saying that you should mindlessly do everything your customers say, but you do in fact need to understand their perspective and allow that to shape your short and long term plans.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="be-your-number-one-customer">Be Your Number One Customer<a href="https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/#be-your-number-one-customer" class="hash-link" aria-label="Direct link to Be Your Number One Customer" title="Direct link to Be Your Number One Customer">​</a></h2>
<p>I mentioned in the previous learning that product owners are often too close to what they are working on to be able to independently understand how their product is actually used. But this is not a bad thing; in fact, I think this is critical in driving a successful product. As a product owner, you need to be your number one customer. You need to be a power user; the person that begs for more features; the person who understands all the bugs and complexities of your software; the person who has built hacks or scripts to overcome limitations. This is a perspective needed to grow your product beyond its current scope and provide vision for what it could become.</p>
<p>Too often at Microsoft, I found people who spent their 9-5 working on a product they never used themselves! Whether they wrote code or wrote specs, these people had a task to get done, and usually a small list of check boxes to determine when they were complete. You can imagine that this leads to disorienting products where features are stitched together in a UI rather than building an end to end story for the user. Furthermore, you can't expect these individuals to be able to talk on the same frequency as their users, so how can they engage them to learn more?</p>
<p>One of the criticisms I have toward working at Microsoft is that they are very enterprise oriented, and as a result, it is especially hard for individuals to become power users. For example, if you are working on enterprise identity systems, then your customers are people managing thousands of accounts within their organization, with dozens of custom RBAC settings, and even things like on-prem federation. It is not likely that a college hire will be able to easily emulate these behaviors, but in my experience, it is so critically important to try! I think to truly excel at your role, you need to immerse yourself in your product, and this might even require working on extra projects where you take on the "customer" role. Additionally, this might also mean that not everyone is a perfect fit for every job. To be most successful, you should look for teams where becoming the number one user is natural, rather than forced.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="product-people-and-pay">Product, People, and Pay<a href="https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/#product-people-and-pay" class="hash-link" aria-label="Direct link to Product, People, and Pay" title="Direct link to Product, People, and Pay">​</a></h2>
<p>Continuing from the last learning, the product you choose to work on can be an important factor to your success; but that is not the only factor. When choosing a team or job, you need to consider three main factors: product, people, and pay. This is one of those things that each person will need to evaluate for themselves, but I can share some of what I learned about myself in this regard.</p>
<p>When graduating from college, the only factor that seemed relevant to me was pay. Being broke for 22 years straight meant that my bias toward making a good income and the ability to start saving outweighed most any other factor I could think of. I was and still am a Microsoft fanboy, so it helps that I did not have to look far to find a good fit, but even when I was talking with Microsoft, I don't remember thinking for a single moment about what I would actually work on. Just that I would have a stable, well paying job. However, salary at Microsoft is pretty fixed and independent of what you work on. So over time, I started to consider the other two factors.</p>
<p>I was fortunate to start my career on a product I found pretty interesting. Identity, authentication, and authorization are technologies that everyone interacts with in the modern day. It is a subset of software security, and if done wrong, can either make customers hate you or lead to compromised accounts. I was generally happy working on the team, and found myself becoming an expert in certain topic areas due to my natural interests in the space. But the grass is always greener on the other side, and I wanted to try my hand on more cutting edge technologies like machine learning. I set out to find another role at Microsoft which would allow me to explore that technology, and I eventually switched to the Azure health and supportability team who was using ML to correlate large outages to specific and shared root causes. Unfortunately, it panned out that I did not get to touch ML while on the team, and that really made it evident how much product really was a factor for my happiness. If I go to work unexcited about what I am learning, or what our mission is, then it will be an uphill battle until the end of the day.</p>
<p>By switching teams, I also learned how much I undervalued the people I worked with. The team I moved to had a much different employee composition, and while I will avoid the specific details I never made close friends with people on this team like I did over in Identity. But that wasn't even the main problem. More importantly I learned how much managers and working relationships affected my happiness on a team. It will always happen that you are given a task that you won't enjoy, but it needs to come from people that you respect and enjoy working with. When things get hard, you need to know the people around you are there to support you rather than make things worse. These things sound obvious, but it is incredibly hard to evaluate the people on your team until you actually start working with them. This means that if you find people you like, don't keep that a secret. Even if your paths diverge, you never know when they will cross again, and you should keep them close. But also, don't be afraid to join new teams and try new things. While the goal is to maximize each variable for your needs, you will never quite have a metric to measure and compare until you have had a range of experiences.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="you-cant-fuck-up">You Can't Fuck Up<a href="https://shawntabrizi.com/blog/personal/4-things-i-learned-in-4-years-at-microsoft/#you-cant-fuck-up" class="hash-link" aria-label="Direct link to You Can't Fuck Up" title="Direct link to You Can't Fuck Up">​</a></h2>
<p>This is probably the lesson which I have the most to learn about, but my current outlook on life is that you can't fuck up. Even before I went to university, I knew I wanted to work in tech and in the world of software. However, life would have it that I ended up studying physics and math rather than computer science. At the time, I was so concerned that I would not be able to get a job out of undergrad due to my lack of formal computer science training. I really felt that I had fucked up 4 years of my life.</p>
<p>But I was wrong; everything turned out fine! I literally applied for one job, went end to end through the interview process, and landed a gig at my dream company. Then, when I switched teams at Microsoft, I gave up being a topic expert to explore interesting tech. That didn't pan out the way I hoped, and I thought I would be fucked again, but here I am, starting a new role outside of Microsoft having grown more as a result of my experiences. In my time at Microsoft, I have seen people literally 'fail upward'; and while I am not claiming that is what happened to me, I certainly feel that having had these experiences, even negative, has made me grown as a person.</p>
<p>Again, these are my anecdotal experiences, and I am very willing to be shown wrong as I continue learn. But, I think my current attitudes toward work and life are very much shaped by these lessons. I am very excited for this next chapter, and I can't wait to keep learning.</p>]]></content:encoded>
            <category>lessons</category>
            <category>life</category>
            <category>microsoft</category>
            <category>parity</category>
        </item>
        <item>
            <title><![CDATA[Getting Twitter posts for Ethereum using an Oracle]]></title>
            <link>https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/</link>
            <guid>https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/</guid>
            <pubDate>Mon, 27 Aug 2018 05:16:09 GMT</pubDate>
            <description><![CDATA[This post will show you how to use the Oraclize.it blockchain oracle to get and store Twitter posts for Ethereum smart contracts.]]></description>
            <content:encoded><![CDATA[<h5 class="anchor anchorWithStickyNavbar_LWe7" id="this-post-will-show-you-how-to-use-the-oraclizeit-blockchain-oracle-to-get-and-store-twitter-posts-for-ethereum-smart-contracts">This post will show you how to use the Oraclize.it blockchain oracle to get and store Twitter posts for Ethereum smart contracts.<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#this-post-will-show-you-how-to-use-the-oraclizeit-blockchain-oracle-to-get-and-store-twitter-posts-for-ethereum-smart-contracts" class="hash-link" aria-label="Direct link to This post will show you how to use the Oraclize.it blockchain oracle to get and store Twitter posts for Ethereum smart contracts." title="Direct link to This post will show you how to use the Oraclize.it blockchain oracle to get and store Twitter posts for Ethereum smart contracts.">​</a></h5>
<p>I recently created a end to end working dApp called <a href="https://github.com/shawntabrizi/Ethereum-Twitter-Bounty" target="_blank" rel="noopener noreferrer">"Ethereum Twitter Bounty"</a> as the final project for the <a href="https://consensys.net/academy/2018developer/" target="_blank" rel="noopener noreferrer">ConsenSys 2018 Developer Program</a>. In short, this dApp is a bounty contract which allows people to to pay or get paid to make specific Twitter posts. Imagine a decentralized marketing service where companies or individuals can allow normal users to virally market their product by sharing it with their peers on social networks like Twitter.</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5b838a8f8a429-8c53abe431d3d123735d75f01c759206.png" width="2526" height="1014" class="img_ev3q"></p>
<p>The dApp is broken up into two different contracts: one that fetches and stores Twitter posts on the blockchain and one that manages the bounties and validates the fulfillment conditions.</p>
<p>Fulfillment in this contract is pretty straight-forward: we just need to check that the contents of one post is equal to the contents of another. But before we can even do that, we need to fetch the Twitter posts from the internet, and make them accessible to our blockchain contracts.</p>
<p>That is what we will be going over in this blog post.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ethereum-oracles">Ethereum Oracles<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#ethereum-oracles" class="hash-link" aria-label="Direct link to Ethereum Oracles" title="Direct link to Ethereum Oracles">​</a></h2>
<p>Smart Contracts cannot natively talk to the outside world. Any data which you want a smart contract to access must be available on the blockchain. This is a really common problem that comes up when developing new dApps. Things like the current USD price of Ether, generating random numbers, and finding out the result of a real-world event involves the use of an <strong>Oracle</strong>: an external service which provides data to the blockchain.</p>
<p>Oracles are actually pretty easy to understand. They simply listen for requests coming from the blockchain for their services, get the data requested, and return it back to the blockchain in the form of a transaction. Anyone could build their own Oracle service and use it for their own personal needs, but that can be pretty complicated or cumbersome for a user who simply wants to create an Ethereum smart contract and not maintain their own cloud service. Additionally, if you are building a decentralized application which uses a custom made oracle, who is to trust that you are not manipulating the results? You start to lose all of the benefits of smart contracts once you delegate results and processes to the outside world.</p>
<p>This is where <a href="http://www.oraclize.it/" target="_blank" rel="noopener noreferrer">Oraclize.it</a> comes in. They are an open platform for fetching external data, and providing cryptographic proofs of the results. This is particularly important because smart contracts are often in control of a lot of money, and when it comes to triggering contract code, users should be certain of the data flowing into the contract. Oraclize.it also provides all of the libraries and samples required to get started very quickly, which was super convenient for building my final project.</p>
<p>However, <a href="http://docs.oraclize.it/" target="_blank" rel="noopener noreferrer">their documentation</a> was a little lacking, specifically when it came to trying out my specific scenario! Here is what they wrote about fetching Twitter posts using their HTML parser:</p>
<blockquote>
<p>HTML Parser: helper is useful for HTML scraping. The desired XPATH can be specified as argument of <code>xpath(..)</code> as shown in the example:</p>
<p><code>html(https://twitter.com/oraclizeit/status/671316655893561344).xpath(//*[contains(@class, 'tweet-text')]/text())</code></p>
</blockquote>
<p>You can actually try this out really quickly on their <a href="http://app.oraclize.it/home/test_query" target="_blank" rel="noopener noreferrer">Test Query</a> page, and on their particular example, it does work okay... but as soon as you try another Twitter posts, things break down quickly. Here is an example of why this XPATH query is bad:</p>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5b833f04ca84f-2f03ef51a5128490d6696442a01892e3.png" width="1282" height="578" class="img_ev3q"></p>
<p>You can see that it is capturing much more than just the original twitter post. All of the replies to the main post also contain the <code>tweet-text</code> class which means that they get picked up by the Oraclize query. Not only does this cost a TON more gas to save to the blockchain, it adds a ton of data which will make it incredibly complicated to validate when a user makes a copy of the post for our scenario. Additionally, some parts of the post like #hashtags and @mentions do not show up, which are also really important for my scenario. So I had to hunt for a better way to parse these posts.</p>
<p>Ultimately, we just need to be more specific about where we grab the text from. Here is an upgraded XPATH query which selects only the main tweet text:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">html(https://twitter.com/&lt;username&gt;/status/&lt;id&gt;).xpath(//div[contains(@class, 'permalink-tweet-container')]//p[contains(@class, 'tweet-text')]//text())</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The results are much better, but still a little strange... Take a look at this example:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="twitter-post">Twitter Post<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#twitter-post" class="hash-link" aria-label="Direct link to Twitter Post" title="Direct link to Twitter Post">​</a></h4>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5b834588d4946-3719e2710536173ac51c9e73799e77db.png" width="603" height="488" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="oraclize-result">Oraclize Result<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#oraclize-result" class="hash-link" aria-label="Direct link to Oraclize Result" title="Direct link to Oraclize Result">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "This time, the vacuum tunnel will be a bit longer &amp; SpaceX will provide some advance funding for student teams with most promising designs. Bonus award for all race pods that exceed half the speed of sound!",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "https://",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "twitter.com/hyperloop/stat",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "us/1032818998243520512",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "\u00a0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "\u2026"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Note that we only get content from the main post now (yay!), but we still get this strange array format where things like the linked post are broken up into multiple pieces. To demonstrate more of the weird behavior, look at this other example:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="twitter-post-1">Twitter Post<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#twitter-post-1" class="hash-link" aria-label="Direct link to Twitter Post" title="Direct link to Twitter Post">​</a></h4>
<p><img loading="lazy" src="https://shawntabrizi.com/assets/images/img_5b83469aa1592-f5cb81534c012b3e5659ab8c978df968.png" width="608" height="435" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="oraclize-result-1">Oraclize Result<a href="https://shawntabrizi.com/blog/ethereum/getting-twitter-posts-for-ethereum-using-an-oracle/#oraclize-result-1" class="hash-link" aria-label="Direct link to Oraclize Result" title="Direct link to Oraclize Result">​</a></h4>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "Amazing news! At ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "HyperloopUPV",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " we will do our best to be on the top of the ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "SpaceX",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "Hyperloop",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " competition this time! ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "boringcompany",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "hyperloop",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "\n",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "HyperloopSpain",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "@",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "UPV",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "SpaceX",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "ElonMusk",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  " ",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "#",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "BreakaPod"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>It is evident that things like #hashtags and @mentions, while present now, are broken up into different pieces. It is pretty easy to repair this on the front end by treating it as a JavaScript array, and then joining the parts:</p>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token known-class-name class-name">JSON</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">"Amazing news! At #HyperloopUPV we will do our best to be on the top of the @SpaceX #Hyperloop competition this time! @boringcompany @hyperloop</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">#HyperloopSpain @UPV #SpaceX #ElonMusk #BreakaPod"</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This final result is perfect, and accurately represents what we want. Unfortunately, on the blockchain, the data is still in this array format, and there is no clean, low gas way to change it that I am aware of.</p>
<p>For my purposes, this can cause some validation issues if there are white-space differences between what the user posts and what the fulfiller used to create their bounty. To avoid this, my suggestion is to keep the posts relatively simple. This will also reduce the amount of gas required to store the post on the blockchain.</p>
<p>The final contract code for my "Twitter Oracle" can be found <a href="https://github.com/shawntabrizi/Ethereum-Twitter-Bounty/blob/master/twitter-bounty/contracts/TwitterOracle.sol" target="_blank" rel="noopener noreferrer">here</a>. Here is a relevant snippet:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/// @notice This function initiates the oraclize process for a Twitter post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// @dev This contract needs ether to be able to call the oracle, which is why this function is also payable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/// @param _postId The twitter post to fetch with the oracle. Expecting "&lt;user&gt;/status/&lt;id&gt;"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">function oraclizeTweet(string _postId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">whenNotPaused</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Check if we have enough remaining funds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (oraclize_getPrice("URL") &gt; address(this).balance) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emit LogInfo("Oraclize query was NOT sent, please add some ETH to cover for the query fee");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        emit LogInfo("Oraclize query was sent, standing by for the answer..");</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Using XPath to to fetch the right element in the JSON response</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        string memory query = string(abi.encodePacked("html(https://twitter.com/", _postId, ").xpath(//div[contains(@class, 'permalink-tweet-container')]//p[contains(@class, 'tweet-text')]//text())"));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bytes32 queryId = oraclize_query("URL", query, 6721975);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        queryToPost[queryId] = _postId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In this code, you can see I have specified a custom gas limit which is extremely high. The default gas limit for the <code>oraclize_query</code> is 200,000 gas, which was causing "out of gas" errors when trying to store the data in the smart contract. I changed the value to be the gas limit for ganache-cli (6,721,975 gas), which is probably not very smart for production, but I did not really invest time into thinking about what a reasonable gas limit would be, and I just wanted to make sure not to run into errors when avoidable.</p>
<p>Take note of another key implementation detail. I get a <code>queryId</code> as a result of <code>oraclize_query</code>. Then I store this value in a mapping, where the value is the Twitter URL (<code>postId</code>) that is being oraclized. This is important because the oraclization process is asynchronous, so when I get a result back from Oraclize.it, I need to know which post the text is for. I then check the mapping I created for the result with a matching <code>queryId</code>, fetch the <code>postId</code>, and then create a mapping using the <code>postId</code> as the key, and the resulting post text as the value. A little tricky, but totally works! :)</p>
<p>Anyway, I hope you learned something from my little exploration into oraclizing Twitter posts for Ethereum dApp development. Try out my app locally by following the instructions on the <a href="https://github.com/shawntabrizi/Ethereum-Twitter-Bounty" target="_blank" rel="noopener noreferrer">GitHub page</a>. If you know of a better way to solve this problem, let me know! Otherwise, if you enjoyed this content, feel free to take a look at my <a href="https://shawntabrizi.com/donate/" target="_blank" rel="noopener noreferrer">donations page</a>.</p>]]></content:encoded>
            <category>blockchain</category>
            <category>ethereum</category>
            <category>oraclize</category>
            <category>programming</category>
            <category>smart contract</category>
            <category>solidity</category>
            <category>twitter</category>
        </item>
    </channel>
</rss>