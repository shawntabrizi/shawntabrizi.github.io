"use strict";(self.webpackChunkshawntabrizi=self.webpackChunkshawntabrizi||[]).push([[51080],{81922:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>l});var o=s(85893),n=s(11151);const r={title:"Refresh Tokens for Azure AD V2 Applications in Flask",date:new Date("2017-08-17T07:45:38.000Z"),authors:"shawntabrizi",slug:"/aad/refresh-tokens-azure-ad-v2-applications-flask/",categories:["AAD"],tags:["access token","authentication","azure active directory","flask","microsoft graph","python","refresh token"]},a=void 0,i={permalink:"/blog/aad/refresh-tokens-azure-ad-v2-applications-flask/",source:"@site/blog/2017-08-16-refresh-tokens-azure-ad-v2-applications-flask.md",title:"Refresh Tokens for Azure AD V2 Applications in Flask",description:"I have been working on a few projects recently that used Flask, a Python web framework, and Azure Active Directory to do things related to the Microsoft Graph. Using flask_oauthlib and the Azure AD V2 endpoint, it has been really easy to set up basic authentication for my web apps.",date:"2017-08-17T07:45:38.000Z",formattedDate:"August 17, 2017",tags:[{label:"access token",permalink:"/blog/tags/access-token"},{label:"authentication",permalink:"/blog/tags/authentication"},{label:"azure active directory",permalink:"/blog/tags/azure-active-directory"},{label:"flask",permalink:"/blog/tags/flask"},{label:"microsoft graph",permalink:"/blog/tags/microsoft-graph"},{label:"python",permalink:"/blog/tags/python"},{label:"refresh token",permalink:"/blog/tags/refresh-token"}],readingTime:3.095,hasTruncateMarker:!1,authors:[{name:"Shawn Tabrizi",title:"Software Engineer",url:"https://github.com/shawntabrizi",imageURL:"https://github.com/shawntabrizi.png",key:"shawntabrizi"}],frontMatter:{title:"Refresh Tokens for Azure AD V2 Applications in Flask",date:"2017-08-17T07:45:38.000Z",authors:"shawntabrizi",slug:"/aad/refresh-tokens-azure-ad-v2-applications-flask/",categories:["AAD"],tags:["access token","authentication","azure active directory","flask","microsoft graph","python","refresh token"]},unlisted:!1,prevItem:{title:"Common Microsoft Resources in Azure Active Directory",permalink:"/blog/aad/common-microsoft-resources-azure-active-directory/"},nextItem:{title:"Revoking Consent for Azure Active Directory Applications",permalink:"/blog/aad/revoking-consent-azure-active-directory-applications/"}},c={authorsImageUrls:[void 0]},l=[];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",p:"p",pre:"pre",strong:"strong",...(0,n.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["I have been working on a few projects recently that used Flask, a Python web framework, and Azure Active Directory to do things related to the Microsoft Graph. Using ",(0,o.jsx)(t.a,{href:"https://flask-oauthlib.readthedocs.io/en/latest/",children:"flask_oauthlib"})," and the ",(0,o.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-appmodel-v2-overview",children:"Azure AD V2 endpoint"}),", it has been really easy to set up basic authentication for my web apps."]}),"\n",(0,o.jsxs)(t.p,{children:["However, we quickly ran into basic authentication headaches like token expiry. It seems pretty obvious to the end user that as long as they haven't logged out since the last time they visited the site, they should stay automatically logged in. However, if you set up a naive implementation of authentication, you will find that the access token you store for the user is only valid for a limited time; ",(0,o.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/active-directory-configurable-token-lifetimes",children:"by default just 1 hour"}),"."]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"So do we make our user sign in every hour?"})}),"\n",(0,o.jsx)(t.p,{children:"Hell no. We need to use refresh tokens which can be exchanged for NEW access tokens, all without the user being asked to sign in again."}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"How do we get a refresh token?"})}),"\n",(0,o.jsxs)(t.p,{children:["In order to get a refresh token from the Azure AD V2 endpoint, you need to make sure your application requests a specific scope: offline_access. As stated ",(0,o.jsx)(t.a,{href:"https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-v2-scopes#openid-connect-scopes",children:"here"}),":"]}),"\n",(0,o.jsxs)(t.blockquote,{children:["\n",(0,o.jsxs)(t.p,{children:["When a user approves the ",(0,o.jsx)(t.code,{children:"offline_access"})," scope, your app can receive refresh tokens from the v2.0 token endpoint. Refresh tokens are long-lived. Your app can get new access tokens as older ones expire."]}),"\n",(0,o.jsxs)(t.p,{children:["If your app does not request the ",(0,o.jsx)(t.code,{children:"offline_access"})," scope, it won't receive refresh tokens."]}),"\n"]}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.strong,{children:"So how do we do it?"})}),"\n",(0,o.jsxs)(t.p,{children:["Unfortunately flask_oauthlib does not directly support refresh tokens, but it does support ",(0,o.jsx)(t.a,{href:"https://flask-oauthlib.readthedocs.io/en/latest/client.html?highlight=post#invoking-remote-methods",children:"remote methods"}),", so we should be able to simply make a POST request for a new access token! Here is the surprisingly simple code you need:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"    data = {}\n    data['grant_type'] = 'refresh_token'\n    data['refresh_token'] = session['refresh_token']\n    data['client_id'] = microsoft.consumer_key\n    data['client_secret'] = microsoft.consumer_secret\n\n    response = (microsoft.post(microsoft.access_token_url, data=data)).data\n"})}),"\n",(0,o.jsxs)(t.p,{children:["That's it! What you are not seeing here is the original code used to get an access token, but I am just doing the normal flask_oauthlib stuff (which you can find in ",(0,o.jsx)(t.a,{href:"https://github.com/Azure-Samples/active-directory-python-flask-graphapi-web-v2",children:"this sample"}),"), and storing the results of the token response in the user's session (Access Token, Expires In, and Refresh Token)."]}),"\n",(0,o.jsxs)(t.p,{children:["Now, in order to invoke this code at the right time, I need to create a ",(0,o.jsx)(t.a,{href:"http://flask.pocoo.org/docs/0.12/patterns/viewdecorators/",children:"view decorator"}),", and Flask has a sample for almost exactly what we want to do here: a login required decorator."]}),"\n",(0,o.jsx)(t.p,{children:"Basically, we add this decorator to any view where we expect the user to be signed in. If the user has no token, we will redirect them to the login page. If they have an expired token and a refresh token, we will use the refresh token to get a new access token. Otherwise, if the token is present and valid, we simply let the view load."}),"\n",(0,o.jsx)(t.p,{children:"Check it out in full action here:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"def login_required(f):\n    @wraps(f)\n    def wrap(*args, **kwargs):\n        if 'microsoft_token' in session:\n            if session['expires_at'] > datetime.now():\n                return f(*args, **kwargs)\n            elif 'refresh_token' in session:\n                # Try to get a Refresh Token\n                data = {}\n                data['grant_type'] = 'refresh_token'\n                data['refresh_token'] = session['refresh_token']\n                data['client_id'] = microsoft.consumer_key\n                data['client_secret'] = microsoft.consumer_secret\n\n                response = (microsoft.post(microsoft.access_token_url, data=data)).data\n\n                if response is None:\n                    session.clear()\n                    print(\"Access Denied: Reason=%s\\nError=%s\" % (response.get('error'),request.get('error_description')))\n                    return redirect(url_for('index'))\n                else:\n                    session['microsoft_token'] = (response['access_token'], '')\n                    session['expires_at'] = datetime.now() + timedelta(seconds=int(response['expires_in']))\n                    session['refresh_token'] = response['refresh_token']\n                    return f(*args, **kwargs)\n        else:\n            return redirect(url_for('login'))\n    return wrap\n"})}),"\n",(0,o.jsx)(t.p,{children:"So now when we want to make a page require login we simply set up our view function like so:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"@app.route('/home')\n@login_required\ndef home():\n    #view code goes here\n"})}),"\n",(0,o.jsx)(t.p,{children:"Adding this kind of code to your Azure AD Flask application can really be the difference between a good and bad user experience. Let me know if this ends up helping you out!"})]})}function d(e={}){const{wrapper:t}={...(0,n.a)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},11151:(e,t,s)=>{s.d(t,{Z:()=>i,a:()=>a});var o=s(67294);const n={},r=o.createContext(n);function a(e){const t=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:a(e.components),o.createElement(r.Provider,{value:t},e.children)}}}]);