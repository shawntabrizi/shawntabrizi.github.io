"use strict";(self.webpackChunkshawntabrizi=self.webpackChunkshawntabrizi||[]).push([[1160],{74262:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>i,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var t=n(85893),s=n(11151);const r={title:"Graphing ETH Balance History of an Ethereum Address using Parallel Asynchronous Requests in Web3.js",date:new Date("2018-03-12T06:31:35.000Z"),authors:"shawntabrizi",layout:"post",slug:"/ethereum/graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js/",categories:["Ethereum"],tags:["ethereum","javascript","web3"],github:"ETH-Balance-Graph"},l=void 0,o={permalink:"/blog/ethereum/graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js/",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2018-03-11-graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js.md",source:"@site/blog/2018-03-11-graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js.md",title:"Graphing ETH Balance History of an Ethereum Address using Parallel Asynchronous Requests in Web3.js",description:"This tutorial will show you how you can query the ETH balance of an Ethereum address across multiple Ethereum blocks, and visualize the results as a graph.",date:"2018-03-12T06:31:35.000Z",formattedDate:"March 12, 2018",tags:[{label:"ethereum",permalink:"/blog/tags/ethereum"},{label:"javascript",permalink:"/blog/tags/javascript"},{label:"web3",permalink:"/blog/tags/web-3"}],readingTime:5.895,hasTruncateMarker:!1,authors:[{name:"Shawn Tabrizi",title:"Software Engineer",url:"https://github.com/shawntabrizi",imageURL:"https://github.com/shawntabrizi.png",key:"shawntabrizi"}],frontMatter:{title:"Graphing ETH Balance History of an Ethereum Address using Parallel Asynchronous Requests in Web3.js",date:"2018-03-12T06:31:35.000Z",authors:"shawntabrizi",layout:"post",slug:"/ethereum/graphing-eth-balance-history-of-an-ethereum-address-using-parallel-asynchronous-requests-in-web3-js/",categories:["Ethereum"],tags:["ethereum","javascript","web3"],github:"ETH-Balance-Graph"},unlisted:!1,prevItem:{title:"Shawn Notes: CryptoZombies Lessons 1 &#8211; 5 in Solidity",permalink:"/blog/ethereum/shawn-notes-cryptozombies-lessons-1-5-in-solidity/"},nextItem:{title:"Set up Azure Service Health Alerts programmatically using PowerShell",permalink:"/blog/code/set-azure-service-health-alerts-programmatically-using-powershell/"}},i={authorsImageUrls:[void 0]},c=[{value:"This tutorial will show you how you can query the ETH balance of an Ethereum address across multiple Ethereum blocks, and visualize the results as a graph.",id:"this-tutorial-will-show-you-how-you-can-query-the-eth-balance-of-an-ethereum-address-across-multiple-ethereum-blocks-and-visualize-the-results-as-a-graph",level:5},{value:"Getting the ether balance at a certain block",id:"getting-the-ether-balance-at-a-certain-block",level:2},{value:"Getting the first transaction for an Ethereum address",id:"getting-the-first-transaction-for-an-ethereum-address",level:2},{value:"Get the current block number",id:"get-the-current-block-number",level:2},{value:"So let&#39;s make a simple loop:",id:"so-lets-make-a-simple-loop",level:2},{value:"Web3.js Asynchronous and Parallel Calls",id:"web3js-asynchronous-and-parallel-calls",level:2},{value:"Final Result",id:"final-result",level:2}];function h(e){const a={a:"a",code:"code",h2:"h2",h5:"h5",img:"img",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.h5,{id:"this-tutorial-will-show-you-how-you-can-query-the-eth-balance-of-an-ethereum-address-across-multiple-ethereum-blocks-and-visualize-the-results-as-a-graph",children:"This tutorial will show you how you can query the ETH balance of an Ethereum address across multiple Ethereum blocks, and visualize the results as a graph."}),"\n",(0,t.jsxs)(a.p,{children:["Continuing my series of simple to consume ",(0,t.jsx)(a.a,{href:"https://shawntabrizi.com/ethereum/ethereum-web3-js-hello-world-get-eth-balance-ethereum-address/",children:"Web3.js tutorials"}),", I want to now look into how we can start to visualize data from the Ethereum blockchain. In the past month or so, a bunch of ponzi scheme Ethereum contracts have been popping. The first notable one was POWHcoin which had the following brilliant whitepaper:"]}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{src:n(22364).Z+"",width:"579",height:"461"})}),"\n",(0,t.jsx)(a.p,{children:"This made me wonder what the actual graph of this Ethereum smart contract looked like..."}),"\n",(0,t.jsx)(a.p,{children:"Unfortunately, this smart contract eventually got hacked, so we won't quite be able to see the peaks and valleys like the picture above shows, but we will be able to see the contract get completely liquidated, which may be interesting itself."}),"\n",(0,t.jsx)(a.p,{children:"Let's build it!"}),"\n",(0,t.jsx)(a.h2,{id:"getting-the-ether-balance-at-a-certain-block",children:"Getting the ether balance at a certain block"}),"\n",(0,t.jsx)(a.p,{children:"The main thing we need to do here is get the ETH balance of an address at a specific block. This is actually quite easy by extending the call we make in my first tutorial:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.a,{href:"https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethgetbalance",children:(0,t.jsx)(a.strong,{children:"web3.eth.getBalance"})})}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"web3.eth.getBalance(addressHexString [, defaultBlock] [, callback])\n"})}),"\n",(0,t.jsx)(a.p,{children:"So if we simply pass a block number into this function, we should be able to get the balance at that point in time."}),"\n",(0,t.jsx)(a.h2,{id:"getting-the-first-transaction-for-an-ethereum-address",children:"Getting the first transaction for an Ethereum address"}),"\n",(0,t.jsx)(a.p,{children:"Before we create a loop getting the various balances, we need to know where to start looking. We could start at block 0, but we will get a ton of empty data before the address was ever used. Unfortunately, Web3.js does not have a good way to query the first transaction of an Ethereum address, so we will use Etherscan's API to get that information. Note that if you want to do this entirely with Web3, you can, you will just need to create a smart searching algorithm, and look at a ton of blocks... probably not very efficient."}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsxs)(a.a,{href:"https://etherscan.io/apis#accounts",children:[(0,t.jsx)(a.strong,{children:"Etherescan Developer APIs:"})," Accounts"]})}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"https://api.etherscan.io/api?module=account&action=txlist&address=0xA7CA36F7273D4d38fc2aEC5A454C497F86728a7A&startblock=0&page=1&offset=1\n"})}),"\n",(0,t.jsxs)(a.p,{children:["This query, which includes the POWHcoin address, will return the first transaction of that address, which is the contract creation. You can verify it is a contract creation call because the ",(0,t.jsx)(a.code,{children:"to"})," value is empty, and the ",(0,t.jsx)(a.code,{children:"contractAddress"})," is populated and matches the address we are observing."]}),"\n",(0,t.jsx)(a.p,{children:"Now we know to start looking at block 499258."}),"\n",(0,t.jsx)(a.h2,{id:"get-the-current-block-number",children:"Get the current block number"}),"\n",(0,t.jsx)(a.p,{children:"Really the last piece of information we need is the current block number, so we know where to end our loop. This information is also available via Web3.js with the following call:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.a,{href:"https://github.com/ethereum/wiki/wiki/JavaScript-API#web3ethblocknumber",children:(0,t.jsx)(a.strong,{children:"web3.eth.blockNumber"})})}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:"web3.eth.getBlockNumber(callback(error, result){ ... })\n"})}),"\n",(0,t.jsx)(a.h2,{id:"so-lets-make-a-simple-loop",children:"So let's make a simple loop:"}),"\n",(0,t.jsx)(a.p,{children:"Here is a simple implementation of what we want to accomplish:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-javascript",children:"// Check for MetaMask, otherwise use an HTTP Provider\nwindow.addEventListener('load', function () {\n    if (typeof web3 !== 'undefined') {\n        console.log('Web3 Detected! ' + web3.currentProvider.constructor.name)\n        window.web3 = new Web3(web3.currentProvider);\n    } else {\n        console.log('No Web3 Detected... using HTTP Provider')\n        window.web3 = new Web3(new Web3.providers.HttpProvider(\"https://mainnet.infura.io/<APIKEY>\"));\n    }\n})\n\n// Wrapper for Web3 callback\nconst promisify = (inner) =>\n    new Promise((resolve, reject) =>\n        inner((err, res) => {\n            if (err) {\n                reject(err);\n            } else {\n                resolve(res);\n            }\n        })\n    );\n\n// Get the first transaction block for an address\nasync function getFirstBlock(address) {\n    let response = await fetch(\"https://api.etherscan.io/api?module=account&action=txlist&address=\" + address + \"&startblock=0&page=1&offset=10&sort=asc\");\n    let data = await response.json();\n\n    return data.result[0].blockNumber;\n}\n\n// Given an address and a range of blocks, query the Ethereum blockchain for the ETH balance across the range\nasync function getBalanceInRange(address, startBlock, endBlock) {\n    // Number of points to fetch between block range\n    var pointCount = 50;\n\n    // Calculate the step size given the range of blocks and the number of points we want\n    var step = Math.floor((endBlock - startBlock) / pointCount)\n    // Make sure step is at least 1\n    if (step < 1) {\n        step = 1;\n    }\n\n    // Store the final result here\n    var balances = []\n\n    // Loop over the blocks, using the step value\n    for (let i = startBlock; i < endBlock; i = i + step) {\n        // Get the ETH value at that block\n        let wei = await promisify(cb => web3.eth.getBalance(address, i, cb));\n        let ether = parseFloat(web3.fromWei(wei, 'ether'))\n        // Add result to final output\n        balances.push({\n            block: i,\n            balance: ether\n        });\n    }\n\n    return balances;\n}\n\n// Main function\nasync function graphBalance() {\n    // Ethereum Address we want to look at\n    var address = \"0xA7CA36F7273D4d38fc2aEC5A454C497F86728a7A\"\n\n    // Find the intial range, from first block to current block\n    var startBlock = parseInt(await getFirstBlock(address));\n    var endBlock = parseInt(await promisify(cb => web3.eth.getBlockNumber(cb)));\n\n    var balances = await getBalanceInRange(address, startBlock, endBlock);\n    console.log(balances)\n}\n\ngraphBalance();\n"})}),"\n",(0,t.jsx)(a.p,{children:"And the output we get is:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{children:'[{"block":4990258,"balance":0},{"block":4995223,"balance":690.3946401936848},{"block":5000188,"balance":812.2356284509416},{"block":5005153,"balance":1033.1702951440611},{"block":5010118,"balance":74.00248959231331},{"block":5015083,"balance":0.23714259262709267},{"block":5020048,"balance":0.000334978488623982},{"block":5025013,"balance":0.005036602641690202},{"block":5029978,"balance":0.005036602641690202},{"block":5034943,"balance":0.0526236993093083},{"block":5039908,"balance":0.04323124310148216},{"block":5044873,"balance":0.06245124310148216},{"block":5049838,"balance":0.06283124310148216},{"block":5054803,"balance":0.004397267827962452},{"block":5059768,"balance":0.004397267827962452},{"block":5064733,"balance":0.004397267827962452},{"block":5069698,"balance":0.03639726782796245},{"block":5074663,"balance":0.03639726782796245},{"block":5079628,"balance":0.03919726782796245},{"block":5084593,"balance":0.03919726782796245},{"block":5089558,"balance":0.04199726782796245},{"block":5094523,"balance":0.04205726782796245},{"block":5099488,"balance":0.04205726782796245},{"block":5104453,"balance":0.5869572678279624},{"block":5109418,"balance":0.000534060075850865},{"block":5114383,"balance":0.000534060075850865},{"block":5119348,"balance":0.000534060075850865},{"block":5124313,"balance":0.000534060075850865},{"block":5129278,"balance":0.000534060075850865},{"block":5134243,"balance":0.000534060075850865},{"block":5139208,"balance":0.02642294883092996},{"block":5144173,"balance":0.026442948830929958},{"block":5149138,"balance":0.026442948830929958},{"block":5154103,"balance":0.026442948830929958},{"block":5159068,"balance":0.03494294883092996},{"block":5164033,"balance":0.03993222727211795},{"block":5168998,"balance":0.04793222727211795},{"block":5173963,"balance":0.04793222727211795},{"block":5178928,"balance":0.04793222727211795},{"block":5183893,"balance":0.04793222727211795},{"block":5188858,"balance":0.04076568624207472},{"block":5193823,"balance":0.04076568624207472},{"block":5198788,"balance":0.04076568624207472},{"block":5203753,"balance":0.04076568624207472},{"block":5208718,"balance":0.04076568624207472},{"block":5213683,"balance":0.04076568624207472},{"block":5218648,"balance":0.04076568624207472},{"block":5223613,"balance":0.04076568624207472},{"block":5228578,"balance":0.04076568624207472},{"block":5233543,"balance":0.04076568624207472},{"block":5238508,"balance":0.04076568624207472}]\n'})}),"\n",(0,t.jsx)(a.p,{children:"Looks good so far! But if you run the code yourself, you will feel how dreadfully slow it is... That is because we are essentially doing a serial query, waiting around 100ms for every data-point:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{src:n(25272).Z+"",width:"901",height:"700"})}),"\n",(0,t.jsx)(a.p,{children:"But we can dramatically improve this by making the Web3.js requests asynchronous and in parallel!"}),"\n",(0,t.jsx)(a.h2,{id:"web3js-asynchronous-and-parallel-calls",children:"Web3.js Asynchronous and Parallel Calls"}),"\n",(0,t.jsxs)(a.p,{children:["We will need to update our ",(0,t.jsx)(a.code,{children:"getBalanceInRange"})," function. Instead of ",(0,t.jsx)(a.code,{children:"await"}),"ing the balance data within each loop, we should simply queue up all of the requests, and then have them be processed at once with ",(0,t.jsx)(a.code,{children:"Promise.all"}),"."]}),"\n",(0,t.jsx)(a.p,{children:"So our new loop would look something like this:"}),"\n",(0,t.jsx)(a.pre,{children:(0,t.jsx)(a.code,{className:"language-javascript",children:"// Given an address and a range of blocks, query the Ethereum blockchain for the ETH balance across the range\nasync function getBalanceInRange(address, startBlock, endBlock) {\n    // Number of points to fetch between block range\n    var pointCount = 50;\n\n    // Calculate the step size given the range of blocks and the number of points we want\n    var step = Math.floor((endBlock - startBlock) / pointCount)\n    // Make sure step is at least 1\n    if (step < 1) {\n        step = 1;\n    }\n\n    // Queue the promises here\n    var promises = [];\n\n    // Loop over the blocks, using the step value\n    for (let i = startBlock; i < endBlock; i = i + step) {\n        // Create a promise to query the ETH balance for that block\n        var promise = promisify(cb => web3.eth.getBalance(address, i, cb));\n        // Queue the promise and include data about the block for output\n        promises.push(promise.then(wei => (\n            {\n                block: i,\n                balance: parseFloat(web3.fromWei(wei, 'ether'))\n            })));\n    }\n    // Resolve all promises in parellel\n    var balances = await Promise.all(promises);\n\n    return balances;\n}\n"})}),"\n",(0,t.jsx)(a.p,{children:"Running this is MUCH faster, and the parallel nature of the calls can be seen in the network traces:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{src:n(58359).Z+"",width:"889",height:"680"})}),"\n",(0,t.jsx)(a.h2,{id:"final-result",children:"Final Result"}),"\n",(0,t.jsx)(a.p,{children:"From there, you just need to pipe the data into your favorite JavaScript graph library, and you will get a view like this:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.img,{src:n(44014).Z+"",width:"871",height:"443"})}),"\n",(0,t.jsx)(a.p,{children:"Here you can see the quick rise of the ponzi scheme, the sell offs of 'weak hands', and finally the contract getting hacked and liquidating all the funds."}),"\n",(0,t.jsx)(a.p,{children:"I will not go into detail about making this graph in this tutorial, but you can see my final app here:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.a,{href:"https://shawntabrizi.com/ethgraph/?address=0xA7CA36F7273D4d38fc2aEC5A454C497F86728a7A&start=4990258&end=5010862",children:"https://shawntabrizi.com/ethgraph/?address=0xA7CA36F7273D4d38fc2aEC5A454C497F86728a7A&start=4990258&end=5010862"})}),"\n",(0,t.jsx)(a.p,{children:"You can find the source code here:"}),"\n",(0,t.jsx)(a.p,{children:(0,t.jsx)(a.a,{href:"https://github.com/shawntabrizi/ETH-Balance-Graph",children:"https://github.com/shawntabrizi/ETH-Balance-Graph"})}),"\n",(0,t.jsxs)(a.p,{children:["If you have any suggestions, or find any bugs please let me know! If you found this short tutorial helpful, feel free to send a donation using the information ",(0,t.jsx)(a.a,{href:"https://shawntabrizi.com/donate/",children:"here"}),"."]})]})}function d(e={}){const{wrapper:a}={...(0,s.a)(),...e.components};return a?(0,t.jsx)(a,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}},44014:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/img_5aa5ad6c84572-e9ad611e1ce172128285a24f067dcdaf.png"},25272:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/img_5aa5b062b26a2-638e1b62aee3f7fd6a55462edd6b139c.png"},58359:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/img_5aa5b09b0bb6f-fa68350f44c55601c39783ecda94408b.png"},22364:(e,a,n)=>{n.d(a,{Z:()=>t});const t=n.p+"assets/images/img_5acdcc67280aa-bc5e9998f4e067f88cc12d7cb58f38d9.png"},11151:(e,a,n)=>{n.d(a,{Z:()=>o,a:()=>l});var t=n(67294);const s={},r=t.createContext(s);function l(e){const a=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function o(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),t.createElement(r.Provider,{value:a},e.children)}}}]);